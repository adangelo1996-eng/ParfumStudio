<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parfum Studio</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

/* â•â• RESET & TOKENS â•â• */
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bk:#000;--wh:#fff;--rd:#cc0000;
  --g50:#f9f9f9;--g100:#f2f2f2;--g200:#e4e4e4;--g300:#ccc;
  --g500:#777;--g700:#333;
  --blue:#1a5fb4;--amber:#b45309;--purple:#6d28d9;
  --green:#15803d;--danger:#991b1b;
  --fn:'Courier Prime','Courier New',monospace;
  --r:10px;--sh:0 2px 14px rgba(0,0,0,.08);
}
body{font-family:var(--fn);background:var(--wh);color:var(--bk);line-height:1.6;-webkit-font-smoothing:antialiased;}
.hidden{display:none!important;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes boom{0%{transform:scale(1)}55%{transform:scale(22);opacity:.4}100%{transform:scale(0);opacity:0}}

/* â•â• BUTTONS â•â• */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.8rem 2rem;background:var(--bk);color:var(--wh);border:2px solid var(--bk);border-radius:50px;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .22s;letter-spacing:.03em;font-family:var(--fn);white-space:nowrap;}
.btn:hover{background:var(--rd);border-color:var(--rd);transform:translateY(-2px);}
.btn:disabled{opacity:.35;pointer-events:none;}
.btn-out{background:var(--wh);color:var(--bk);}
.btn-out:hover{background:var(--bk);color:var(--wh);}
.btn-sm{padding:.5rem 1.3rem;font-size:.83rem;}
.btn-green{background:var(--green);border-color:var(--green);}
.btn-green:hover{background:#14532d;border-color:#14532d;}

/* â•â• LANDING â•â• */
#landing{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:2rem;text-align:center;transition:opacity .4s;}
#landing.fade{opacity:0;pointer-events:none;}
.dot{width:68px;height:68px;background:var(--rd);border-radius:50%;margin-bottom:2.5rem;animation:pulse 2s ease-in-out infinite;}
.dot.boom{animation:boom .65s ease-out forwards;}
#landing h1{font-size:3.1rem;font-weight:400;letter-spacing:.02em;margin-bottom:.5rem;}
.land-sub{font-size:1rem;color:var(--g500);margin-bottom:2.6rem;}

/* â•â• HEADER â•â• */
#hdr{position:fixed;top:0;left:0;right:0;background:rgba(255,255,255,.96);backdrop-filter:blur(12px);border-bottom:1.5px solid var(--g200);z-index:900;padding:1rem 2rem;display:none;}
.hdr-in{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:.8rem;flex-wrap:wrap;}
.logo{display:flex;align-items:center;gap:.45rem;font-size:1.2rem;font-weight:700;cursor:pointer;transition:opacity .2s;}
.logo:hover{opacity:.55;}
.logo-dot{width:9px;height:9px;background:var(--rd);border-radius:50%;}
.hdr-btns{display:flex;gap:.5rem;flex-wrap:wrap;}

/* â•â• APP â•â• */
#app{display:none;max-width:1100px;margin:0 auto;padding:6.5rem 1.4rem 3rem;}
#app.show{display:block;animation:fadeUp .5s ease;}

/* â•â• PROGRESS â•â• */
.prog-wrap{background:var(--g50);border:1px solid var(--g200);border-radius:var(--r);padding:1.3rem 1.7rem;margin-bottom:2rem;}
.prog-steps{display:flex;position:relative;}
.prog-steps::before{content:'';position:absolute;top:17px;left:0;right:0;height:2px;background:var(--g200);z-index:0;}
.prog-line{position:absolute;top:17px;left:0;height:2px;background:var(--rd);z-index:1;transition:width .4s ease;width:0%;}
.ps{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;z-index:2;}
.ps-n{width:34px;height:34px;border-radius:50%;background:var(--wh);border:2px solid var(--g300);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;margin-bottom:.25rem;transition:all .3s;}
.ps.active .ps-n{background:var(--bk);border-color:var(--bk);color:var(--wh);}
.ps.done .ps-n{background:var(--rd);border-color:var(--rd);color:var(--wh);}
.ps-l{font-size:.73rem;color:var(--g500);text-align:center;}
.ps.active .ps-l{color:var(--bk);font-weight:700;}

/* â•â• STEPS â•â• */
.step{display:none;}
.step.on{display:block;animation:fadeUp .3s ease;}
.step-h{font-size:1.9rem;font-weight:400;letter-spacing:.01em;margin-bottom:.4rem;}
.step-sub{font-size:.97rem;color:var(--g500);margin-bottom:1.7rem;}

/* â•â• OPTION CARDS â•â• */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:.9rem;margin-bottom:1.7rem;}
.oc{background:var(--g50);border:2px solid var(--g200);border-radius:var(--r);padding:1.3rem 1rem;cursor:pointer;text-align:center;transition:all .22s;position:relative;}
.oc:hover{border-color:var(--bk);transform:translateY(-3px);box-shadow:var(--sh);}
.oc.sel{background:var(--bk);color:var(--wh);border-color:var(--bk);}
.oc.sel::after{content:'âœ“';position:absolute;top:7px;right:9px;font-size:.7rem;font-weight:700;background:var(--rd);color:var(--wh);width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.oc-i{font-size:2rem;margin-bottom:.6rem;display:block;}
.oc-t{font-size:.9rem;font-weight:700;margin-bottom:.2rem;}
.oc-d{font-size:.79rem;opacity:.72;line-height:1.4;}
.oc.sel .oc-d{opacity:.8;}

/* â•â• TAGS â•â• */
.tags{display:flex;flex-wrap:wrap;gap:.65rem;margin-bottom:1.7rem;}
.tag{padding:.5rem 1.1rem;background:var(--g50);border:2px solid var(--g200);border-radius:50px;cursor:pointer;font-weight:500;font-size:.86rem;transition:all .22s;}
.tag:hover{border-color:var(--bk);}
.tag.sel{background:var(--bk);color:var(--wh);border-color:var(--bk);}

/* â•â• SLIDERS â•â• */
.sl-wrap{margin-bottom:1.6rem;}
.sl-row{display:flex;justify-content:space-between;margin-bottom:.45rem;font-weight:600;}
.s-v{color:var(--rd);}
input[type=range]{width:100%;height:6px;border-radius:3px;background:var(--g200);-webkit-appearance:none;appearance:none;outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--rd);cursor:pointer;transition:transform .18s;}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.3);}
input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--rd);border:none;}

/* â•â• INPUTS â•â• */
.field{margin-bottom:1.3rem;}
.field label{display:block;font-weight:700;margin-bottom:.3rem;font-size:.9rem;}
.inp{width:100%;padding:.8rem 1rem;border:2px solid var(--g200);border-radius:var(--r);font-size:.97rem;font-family:var(--fn);transition:border-color .22s;background:var(--wh);}
.inp:focus{outline:none;border-color:var(--bk);}

/* â•â• NAV â•â• */
.nav{display:flex;justify-content:space-between;gap:.8rem;margin-top:1.8rem;}

/* â•â• PREVIEW pubblica â•â• */
#preview{margin-top:1.8rem;}
.block{background:var(--g50);border:1px solid var(--g200);border-radius:var(--r);padding:1.5rem;margin-bottom:1.4rem;box-shadow:var(--sh);}
.block-t{font-size:1.1rem;font-weight:700;margin-bottom:1.1rem;text-align:center;}

.pyr-s{margin-bottom:.9rem;}
.pyr-h{display:flex;justify-content:space-between;font-weight:600;font-size:.87rem;margin-bottom:.3rem;}
.pyr-track{height:34px;background:var(--g200);border-radius:5px;overflow:hidden;}
.pyr-fill{height:100%;display:flex;align-items:center;padding-left:.7rem;color:var(--wh);font-weight:700;font-size:.82rem;transition:width .9s ease;min-width:2.5rem;}
.pt{background:var(--blue);}
.pc{background:var(--amber);}
.pf{background:var(--purple);}

.ing-row{display:grid;grid-template-columns:1fr 70px 90px 85px;align-items:center;gap:.7rem;padding:.8rem .9rem;margin-bottom:.4rem;background:var(--wh);border:1px solid var(--g200);border-radius:7px;transition:border-color .18s,transform .18s;}
.ing-row:hover{border-color:var(--bk);transform:translateX(3px);}
.ing-nw{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;}
.ing-n{font-weight:700;font-size:.92rem;}
.badge{padding:.18rem .55rem;border-radius:7px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;white-space:nowrap;}
.bt{background:rgba(26,95,180,.12);color:var(--blue);}
.bc{background:rgba(180,83,9,.12);color:var(--amber);}
.bf{background:rgba(109,40,217,.12);color:var(--purple);}
.adj-b{background:rgba(21,128,61,.12);color:var(--green);font-size:.65rem;}
.ing-pct{font-size:.83rem;color:var(--g500);text-align:right;}
.ing-dr{font-weight:700;color:var(--rd);text-align:right;font-size:.89rem;}
.ing-gr{font-weight:600;color:var(--g700);text-align:right;font-size:.89rem;}

.ib{background:#fff5f5;border-left:4px solid var(--rd);padding:.9rem 1.2rem;border-radius:7px;margin:.9rem 0;font-size:.88rem;line-height:1.7;}
.ib.ok{background:#f0fdf4;border-left-color:var(--green);}
.ib.warn{background:#fefce8;border-left-color:var(--amber);}
.ib.info{background:#eff6ff;border-left-color:var(--blue);}
.acts{display:flex;gap:.7rem;justify-content:flex-end;flex-wrap:wrap;margin-top:1.1rem;}

/* â•â• MODAL PASSWORD â•â• */
#pass-ov{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px);}
#pass-ov.show{display:flex;}
.pass-box{background:var(--wh);border-radius:13px;padding:1.9rem 2.1rem;max-width:370px;width:100%;box-shadow:0 18px 55px rgba(0,0,0,.32);animation:fadeUp .3s ease;}
.pass-box h3{font-size:1.2rem;font-weight:700;margin-bottom:.25rem;}
.pass-box p{font-size:.86rem;color:var(--g500);margin-bottom:1.1rem;}
.pass-err{font-size:.83rem;color:var(--danger);margin-top:.4rem;min-height:1.1em;}

/* â•â• FORMULA PAGE â•â• */
#fp{display:none;max-width:920px;margin:6.5rem auto 3rem;padding:0 1.4rem;}
#fp.show{display:block;animation:fadeUp .4s ease;}
.fp-hero{background:var(--bk);color:var(--wh);border-radius:var(--r);padding:1.8rem 2rem;margin-bottom:1.4rem;}
.fp-name{font-size:1.75rem;font-weight:700;margin-bottom:.25rem;}
.fp-desc{font-size:.92rem;opacity:.68;line-height:1.6;}
.fp-bl{background:var(--g50);border:1px solid var(--g200);border-radius:var(--r);padding:1.4rem;margin-bottom:1.4rem;box-shadow:var(--sh);}
.fp-h{font-size:1.05rem;font-weight:700;margin-bottom:.9rem;padding-bottom:.5rem;border-bottom:2px solid var(--g200);}
.sum-r{display:flex;justify-content:space-between;padding:.55rem 0;border-bottom:1px solid var(--g200);font-size:.9rem;}
.sum-r:last-child{border-bottom:none;}
.sum-l{color:var(--g500);}
.sum-v{font-weight:700;}
.cost-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.8rem;margin-top:.7rem;}
.cc{background:var(--wh);border:1px solid var(--g200);border-radius:7px;padding:.9rem;text-align:center;}
.cc-l{font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:var(--g500);margin-bottom:.25rem;}
.cc-v{font-size:1.3rem;font-weight:700;}
.cc-v.big{font-size:1.8rem;color:var(--rd);}
.inst-list{list-style:none;counter-reset:inst;}
.inst-list li{counter-increment:inst;display:flex;gap:.85rem;align-items:flex-start;padding:.75rem 0;border-bottom:1px solid var(--g200);font-size:.9rem;line-height:1.6;}
.inst-list li:last-child{border-bottom:none;}
.inst-list li::before{content:counter(inst);flex-shrink:0;width:26px;height:26px;background:var(--bk);color:var(--wh);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.75rem;}
.ifra-hdr{display:grid;grid-template-columns:1fr 110px 90px 60px;gap:.4rem;padding:.4rem .7rem;background:var(--g200);border-radius:5px;font-size:.73rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--g500);margin-bottom:.4rem;}
.ifra-r{display:grid;grid-template-columns:1fr 110px 90px 60px;gap:.4rem;align-items:start;padding:.65rem .7rem;border-radius:6px;font-size:.86rem;margin-bottom:.35rem;}
.ifra-ok-r{background:rgba(21,128,61,.07);}
.ifra-warn-r{background:rgba(153,27,27,.07);}
.ifra-ok{color:var(--green);font-weight:700;}
.ifra-warn{color:var(--danger);font-weight:700;}
.ifra-note{font-size:.74rem;color:var(--g500);margin-top:.2rem;line-height:1.4;}

/* â•â• RESPONSIVE â•â• */
@media(max-width:680px){
  #landing h1{font-size:2rem;}
  .step-h{font-size:1.5rem;}
  .cards{grid-template-columns:1fr 1fr;}
  .nav{flex-direction:column;}
  .acts{flex-direction:column;}
  .ing-row{grid-template-columns:1fr 70px 80px;}
  .ing-pct{display:none;}
  .ifra-hdr,.ifra-r{grid-template-columns:1fr 90px 55px;}
  .ifra-hdr span:nth-child(3),.ifra-r>span:nth-child(3){display:none;}
}
@media(max-width:440px){.cards{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- â•â•â• LANDING â•â•â• -->
<div id="landing">
  <div class="dot" id="dot"></div>
  <h1>Parfum Studio</h1>
  <p class="land-sub">AI-Powered Fragrance Generator</p>
  <button class="btn" onclick="startApp()">Inizia la Creazione â†’</button>
</div>

<!-- â•â•â• HEADER â•â•â• -->
<div id="hdr">
  <div class="hdr-in">
    <div class="logo" onclick="location.reload()"><div class="logo-dot"></div>Parfum Studio</div>
    <div class="hdr-btns">
      <button class="btn btn-out btn-sm" onclick="location.reload()">â†º Reset</button>
      <button class="btn btn-sm" onclick="openPass()">ğŸ” Area Formule</button>
    </div>
  </div>
</div>

<!-- â•â•â• WIZARD â•â•â• -->
<div id="app">
  <!-- Progress bar -->
  <div class="prog-wrap">
    <div class="prog-steps" id="psteps">
      <div class="prog-line" id="pline"></div>
      <div class="ps active" data-s="1"><div class="ps-n">1</div><div class="ps-l">Famiglia</div></div>
      <div class="ps" data-s="2"><div class="ps-n">2</div><div class="ps-l">IntensitÃ </div></div>
      <div class="ps" data-s="3"><div class="ps-n">3</div><div class="ps-l">Occasione</div></div>
      <div class="ps" data-s="4"><div class="ps-n">4</div><div class="ps-l">Stile</div></div>
      <div class="ps" data-s="5"><div class="ps-n">5</div><div class="ps-l">Dettagli</div></div>
    </div>
  </div>

  <!-- Step 1 -->
  <div class="step on" data-step="1">
    <h2 class="step-h">Famiglia Olfattiva</h2>
    <p class="step-sub">Scegli il carattere principale del profumo</p>
    <div class="cards">
      <div class="oc" data-v="fresco-agrumato"    onclick="pick(this,'family')"><span class="oc-i">ğŸ‹</span><div class="oc-t">Fresco & Agrumato</div><p class="oc-d">Limone, bergamotto, mandarino.</p></div>
      <div class="oc" data-v="floreale"           onclick="pick(this,'family')"><span class="oc-i">ğŸŒ¸</span><div class="oc-t">Floreale & Romantico</div><p class="oc-d">Rosa, gelsomino, mughetto.</p></div>
      <div class="oc" data-v="aromatico-fougere"  onclick="pick(this,'family')"><span class="oc-i">ğŸŒ¿</span><div class="oc-t">Aromatico & FougÃ¨re</div><p class="oc-d">Lavanda, erbe, felce.</p></div>
      <div class="oc" data-v="legnoso-ambrato"    onclick="pick(this,'family')"><span class="oc-i">ğŸŒ³</span><div class="oc-t">Legnoso & Ambrato</div><p class="oc-d">Cedro, vetiver, ambra.</p></div>
      <div class="oc" data-v="orientale-speziato" onclick="pick(this,'family')"><span class="oc-i">ğŸ”¥</span><div class="oc-t">Orientale & Speziato</div><p class="oc-d">Spezie, resine, vaniglia.</p></div>
      <div class="oc" data-v="marino-fresco"      onclick="pick(this,'family')"><span class="oc-i">ğŸŒŠ</span><div class="oc-t">Marino & Acquatico</div><p class="oc-d">Ozono, note acquatiche.</p></div>
      <div class="oc" data-v="chypre-verde"       onclick="pick(this,'family')"><span class="oc-i">ğŸƒ</span><div class="oc-t">Chypre & Verde</div><p class="oc-d">Patchouly, muschio di quercia.</p></div>
      <div class="oc" data-v="gourmand-dolce"     onclick="pick(this,'family')"><span class="oc-i">ğŸ°</span><div class="oc-t">Gourmand & Dolce</div><p class="oc-d">Vaniglia, cumarina, miele.</p></div>
    </div>
    <div class="nav"><button class="btn btn-out" disabled>â† Indietro</button><button class="btn" onclick="goNext()">Continua â†’</button></div>
  </div>

  <!-- Step 2 -->
  <div class="step" data-step="2">
    <h2 class="step-h">IntensitÃ </h2>
    <p class="step-sub">Tipo di concentrazione essenze</p>
    <div class="cards">
      <div class="oc" data-v="edc" onclick="pick(this,'intensity')"><span class="oc-i">â˜ï¸</span><div class="oc-t">Eau de Cologne</div><p class="oc-d">~5% essenze Â· 2â€“3h</p></div>
      <div class="oc" data-v="edt" onclick="pick(this,'intensity')"><span class="oc-i">ğŸ’¨</span><div class="oc-t">Eau de Toilette</div><p class="oc-d">~10% essenze Â· 4â€“6h</p></div>
      <div class="oc" data-v="edp" onclick="pick(this,'intensity')"><span class="oc-i">âš¡</span><div class="oc-t">Eau de Parfum</div><p class="oc-d">~17% essenze Â· 6â€“8h</p></div>
    </div>
    <div class="nav"><button class="btn btn-out" onclick="goBack()">â† Indietro</button><button class="btn" onclick="goNext()">Continua â†’</button></div>
  </div>

  <!-- Step 3 -->
  <div class="step" data-step="3">
    <h2 class="step-h">Occasione d'Uso</h2>
    <p class="step-sub">Opzionale â€” seleziona una o piÃ¹</p>
    <div class="tags">
      <div class="tag" data-v="quotidiano" onclick="toggleTag(this)">Uso quotidiano</div>
      <div class="tag" data-v="sera"       onclick="toggleTag(this)">Serata elegante</div>
      <div class="tag" data-v="lavoro"     onclick="toggleTag(this)">Lavoro / Ufficio</div>
      <div class="tag" data-v="sport"      onclick="toggleTag(this)">Sport</div>
      <div class="tag" data-v="romantico"  onclick="toggleTag(this)">Romantico</div>
      <div class="tag" data-v="inverno"    onclick="toggleTag(this)">Inverno</div>
      <div class="tag" data-v="estate"     onclick="toggleTag(this)">Estate</div>
      <div class="tag" data-v="primavera"  onclick="toggleTag(this)">Primavera / Autunno</div>
    </div>
    <div class="nav"><button class="btn btn-out" onclick="goBack()">â† Indietro</button><button class="btn" onclick="goNext()">Continua â†’</button></div>
  </div>

  <!-- Step 4 -->
  <div class="step" data-step="4">
    <h2 class="step-h">Personalizza lo Stile</h2>
    <p class="step-sub">Regola le caratteristiche sensoriali</p>
    <div class="sl-wrap"><div class="sl-row"><span>ğŸ¯ Dolcezza</span><span class="s-v" id="vSw">50%</span></div><input type="range" id="sSw" min="0" max="100" value="50" oninput="usl('sSw','vSw','sweet')"></div>
    <div class="sl-wrap"><div class="sl-row"><span>ğŸ’§ Freschezza</span><span class="s-v" id="vFr">50%</span></div><input type="range" id="sFr" min="0" max="100" value="50" oninput="usl('sFr','vFr','fresh')"></div>
    <div class="sl-wrap"><div class="sl-row"><span>ğŸŒ‘ ProfonditÃ </span><span class="s-v" id="vDp">50%</span></div><input type="range" id="sDp" min="0" max="100" value="50" oninput="usl('sDp','vDp','depth')"></div>
    <div class="nav"><button class="btn btn-out" onclick="goBack()">â† Indietro</button><button class="btn" onclick="goNext()">Continua â†’</button></div>
  </div>

  <!-- Step 5 -->
  <div class="step" data-step="5">
    <h2 class="step-h">Ultimi Dettagli</h2>
    <p class="step-sub">Nome e volume finale</p>
    <div style="max-width:460px;margin:0 auto">
      <div class="field"><label>Nome del Profumo</label><input type="text" class="inp" id="pName" placeholder="Es. Notte di Cedro"></div>
      <div class="field"><label>Volume Finale (ml)</label><input type="number" class="inp" id="pVol" value="50" min="10" max="1000"></div>
    </div>
    <div class="nav"><button class="btn btn-out" onclick="goBack()">â† Indietro</button><button class="btn" onclick="generate()">ğŸ”® Genera Formula</button></div>
  </div>

  <!-- ANTEPRIMA PUBBLICA -->
  <div id="preview" class="hidden">
    <div class="block">
      <div class="block-t" id="prevTitle">Ingredienti Selezionati</div>
      <div style="margin-bottom:1.2rem;">
        <div class="pyr-s"><div class="pyr-h"><span>Note di Testa</span><span id="pTl">0%</span></div><div class="pyr-track"><div class="pyr-fill pt" id="pTb" style="width:0%"></div></div></div>
        <div class="pyr-s"><div class="pyr-h"><span>Note di Cuore</span><span id="pCl">0%</span></div><div class="pyr-track"><div class="pyr-fill pc" id="pCb" style="width:0%"></div></div></div>
        <div class="pyr-s"><div class="pyr-h"><span>Note di Fondo</span><span id="pFl">0%</span></div><div class="pyr-track"><div class="pyr-fill pf" id="pFb" style="width:0%"></div></div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 70px 90px 85px;gap:.5rem;padding:.3rem .9rem;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--g500);">
        <span>Ingrediente</span><span style="text-align:right">%</span><span style="text-align:right">Gocce</span><span style="text-align:right">Grammi</span>
      </div>
      <div id="prevList"></div>
      <div id="taraMsg"></div>
      <div class="ib info"><strong>ğŸ‘ Vista pubblica</strong> â€” Ingredienti, gocce, grammi. Formula giÃ  tarata IFRA.<br>Costi, istruzioni e certificato sono nell'<strong>Area Formule</strong>.</div>
      <div class="acts">
        <button class="btn btn-out" onclick="location.reload()">â†º Ricomincia</button>
        <button class="btn" onclick="openPass()">ğŸ” Area Formule</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL PASSWORD â•â•â• -->
<div id="pass-ov">
  <div class="pass-box">
    <h3>ğŸ” Area Formule Riservata</h3>
    <p>Costi, istruzioni di preparazione, conformitÃ  IFRA e certificato PDF.</p>
    <div class="field"><label>Password</label><input type="password" class="inp" id="passInp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')chkPass()"></div>
    <div class="pass-err" id="passErr"></div>
    <div class="acts" style="margin-top:.9rem;">
      <button class="btn btn-out btn-sm" onclick="closePass()">Annulla</button>
      <button class="btn btn-sm" onclick="chkPass()">Entra â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â• FORMULA PAGE (protetta) â•â•â• -->
<div id="fp">
  <div class="fp-hero">
    <div class="fp-name" id="fpName">â€”</div>
    <div class="fp-desc" id="fpDesc">â€”</div>
  </div>

  <div class="fp-bl">
    <div class="fp-h">ğŸ“‹ Riepilogo Formula</div>
    <div class="sum-r"><span class="sum-l">Tipo concentrazione</span><span class="sum-v" id="fpType">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Volume finale</span><span class="sum-v" id="fpVol">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Concentrato (essenze)</span><span class="sum-v" id="fpCml">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Alcol diluente 96Â°</span><span class="sum-v" id="fpAml">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Gocce totali concentrato</span><span class="sum-v" id="fpDr">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Peso totale concentrato</span><span class="sum-v" id="fpGr">â€”</span></div>
    <div class="sum-r"><span class="sum-l">NÂ° ingredienti</span><span class="sum-v" id="fpNi">â€”</span></div>
  </div>

  <div class="fp-bl">
    <div class="fp-h">ğŸ’¶ Costi di Produzione</div>
    <div class="cost-grid">
      <div class="cc"><div class="cc-l">Totale</div><div class="cc-v big" id="fpCtot">â‚¬â€”</div></div>
      <div class="cc"><div class="cc-l">Concentrato</div><div class="cc-v" id="fpCconc">â‚¬â€”</div></div>
      <div class="cc"><div class="cc-l">Alcol</div><div class="cc-v" id="fpCalc">â‚¬â€”</div></div>
      <div class="cc"><div class="cc-l">Costo / ml</div><div class="cc-v" id="fpCml2">â‚¬â€”</div></div>
    </div>
  </div>

  <div class="fp-bl">
    <div class="fp-h">âš—ï¸ Dosaggi Tecnici</div>
    <div style="display:grid;grid-template-columns:1fr 70px 90px 85px;gap:.5rem;padding:.3rem .7rem;font-size:.74rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--g500);">
      <span>Ingrediente</span><span style="text-align:right">%</span><span style="text-align:right">Gocce</span><span style="text-align:right">Grammi</span>
    </div>
    <div id="fpIngList"></div>
    <div class="ib warn" style="margin-top:.8rem;"><strong>â„¹ï¸ DensitÃ  media 1 g/ml.</strong> 1 goccia â‰ˆ 0.05 ml. Per oli densi (patchouly, mirra) il peso reale Ã¨ leggermente superiore.</div>
  </div>

  <div class="fp-bl">
    <div class="fp-h">ğŸ›¡ï¸ ConformitÃ  IFRA â€” Cat. 4 Fine Fragrance (leave-on)</div>
    <p style="font-size:.87rem;color:var(--g500);margin-bottom:.9rem;line-height:1.6;">Formula tarata automaticamente per rispettare IFRA 50th Amendment Cat. 4. Verifica sempre il certificato IFRA del fornitore per ogni lotto.</p>
    <div id="ifraMsg" style="margin-bottom:.8rem;"></div>
    <div class="ifra-hdr"><span>Ingrediente</span><span>% prod. finito</span><span>Limite IFRA</span><span>Stato</span></div>
    <div id="ifraRows"></div>
    <div id="ifraNoLim" class="ib ok hidden">âœ… Nessun ingrediente IFRA-limitato presente.</div>
  </div>

  <div class="fp-bl">
    <div class="fp-h">ğŸ“– Istruzioni di Preparazione</div>
    <ol class="inst-list">
      <li>Prepara area di lavoro pulita. Occorrente: bilancia 0.01 g, boccetta vetro scuro, pipette Pasteur separate per ogni ingrediente, becher 100 ml, bastoncino vetro, etichette.</li>
      <li>Versa nella boccetta <strong id="iAlc">â€”</strong> ml di alcol etilico 96Â° per profumeria.</li>
      <li>Aggiungi le <strong>note di fondo</strong> per prime (molecole piÃ¹ pesanti, scia piÃ¹ lunga).</li>
      <li>Aggiungi le <strong>note di cuore</strong> (corpo centrale del profumo).</li>
      <li>Aggiungi le <strong>note di testa</strong> (le piÃ¹ volatili, per ultime).</li>
      <li>Mescola delicatamente 30â€“40 secondi con movimenti circolari lenti.</li>
      <li>Chiudi ermeticamente. Etichetta: nome, data, tipo (<span id="iType">â€”</span>), volume (<span id="iVol">â€”</span> ml), lotto.</li>
      <li><strong>Maturazione:</strong> 2â€“6 settimane al buio a 18â€“22 Â°C. Agita 1Ã—/settimana. Non aprire i primi 7 giorni. Testa su mouillette prima che sulla cute.</li>
    </ol>
  </div>

  <div class="acts">
    <button class="btn btn-out" onclick="closeFP()">â† Chiudi</button>
    <button class="btn btn-green" onclick="printCert()">ğŸ“„ Genera Certificato IFRA PDF</button>
    <button class="btn" onclick="saveF()">ğŸ’¾ Salva</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATABASE INGREDIENTI
   ifraMax = % MAX nel PRODOTTO FINITO
   (Cat.4 Fine Fragrance leave-on, IFRA 50th Amendment 2023)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB=[
  // â”€â”€ TESTA â”€â”€
  {n:"BERGAMOTTO",             note:"testa",fam:"agrumato",  price:18,w:12, ifra:true,  ifraMax:0.4,   ifraNote:"FCF richiesto; fototossico â€” max 0.4% prod.finito",    compat:["fresco-agrumato","floreale","aromatico-fougere","marino-fresco","chypre-verde"]},
  {n:"LIMONE ITALIA",          note:"testa",fam:"agrumato",  price:12,w:12, ifra:true,  ifraMax:2.0,   ifraNote:"Limonene libero â‰¤2% prod.finito",                     compat:["fresco-agrumato","marino-fresco","aromatico-fougere"]},
  {n:"MANDARINO GIALLO",       note:"testa",fam:"agrumato",  price:15,w:10, ifra:false,                                                                                compat:["fresco-agrumato","gourmand-dolce","floreale"]},
  {n:"AGRUMEX",                note:"testa",fam:"agrumato",  price:10,w:10, ifra:false,                                                                                compat:["fresco-agrumato","marino-fresco","aromatico-fougere"]},
  {n:"VERTOCITRAL C",          note:"testa",fam:"agrumato",  price:13,w:8,  ifra:false,                                                                                compat:["fresco-agrumato","marino-fresco"]},
  {n:"ACETATO LINALILE",       note:"testa",fam:"floreale",  price:11,w:12, ifra:true,  ifraMax:5.0,   ifraNote:"Linalyl acetate â€” allergene UE, dichiarazione â‰¥0.01%",compat:["floreale","fresco-agrumato","aromatico-fougere"]},
  {n:"LINALOLO",               note:"testa",fam:"floreale",  price:10,w:12, ifra:true,  ifraMax:5.0,   ifraNote:"Linalool â€” allergene UE, max 5% leave-on",            compat:["floreale","fresco-agrumato","aromatico-fougere","chypre-verde"]},
  {n:"ETIL LINALOLO",          note:"testa",fam:"floreale",  price:8, w:10, ifra:false,                                                                                compat:["floreale","aromatico-fougere"]},
  {n:"ISORALDEINA",            note:"testa",fam:"fresco",    price:11,w:8,  ifra:false,                                                                                compat:["marino-fresco","fresco-agrumato","chypre-verde"]},
  {n:"DIIDROMIRCENOLO",        note:"testa",fam:"fresco",    price:9, w:10, ifra:false,                                                                                compat:["fresco-agrumato","marino-fresco","aromatico-fougere"]},
  {n:"CARDAMOMO",              note:"testa",fam:"speziato",  price:20,w:6,  ifra:false,                                                                                compat:["orientale-speziato","aromatico-fougere","legnoso-ambrato"]},
  {n:"PEPE NERO",              note:"testa",fam:"speziato",  price:16,w:4,  ifra:false,                                                                                compat:["orientale-speziato","legnoso-ambrato","chypre-verde"]},
  {n:"MANZANATE",              note:"testa",fam:"fruttato",  price:16,w:3,  ifra:true,  ifraMax:0.05,  ifraNote:"Allyl amyl glycolate â€” max 0.05% prod.finito",        compat:["fresco-agrumato","gourmand-dolce","floreale"]},
  {n:"ALLIL AMIL GLICOLATE",   note:"testa",fam:"fruttato",  price:14,w:3,  ifra:true,  ifraMax:0.05,  ifraNote:"Max 0.05% prod.finito (IFRA restricted)",             compat:["fresco-agrumato","gourmand-dolce"]},
  {n:"ACETATO EXILE",          note:"testa",fam:"fruttato",  price:7, w:8,  ifra:false,                                                                                compat:["fresco-agrumato","floreale","gourmand-dolce"]},
  // â”€â”€ CUORE â”€â”€
  {n:"HEDIONE",                note:"cuore",fam:"floreale",  price:25,w:15, ifra:false,                                                                                compat:["floreale","fresco-agrumato","aromatico-fougere","marino-fresco","chypre-verde"]},
  {n:"DAMASCENONE",            note:"cuore",fam:"floreale",  price:55,w:1,  ifra:true,  ifraMax:0.02,  ifraNote:"Î²-Damascenone â€” max 0.02% prod.finito (potentissimo)",compat:["floreale","orientale-speziato","gourmand-dolce","chypre-verde"]},
  {n:"ALFA DAMASCONE",         note:"cuore",fam:"floreale",  price:45,w:2,  ifra:true,  ifraMax:0.02,  ifraNote:"Î±-Damascone â€” max 0.02% prod.finito",                 compat:["floreale","orientale-speziato","chypre-verde"]},
  {n:"GERANIOLO",              note:"cuore",fam:"floreale",  price:12,w:10, ifra:true,  ifraMax:6.0,   ifraNote:"Geraniol â€” allergene UE, max 6% leave-on",            compat:["floreale","chypre-verde","aromatico-fougere"]},
  {n:"ACETATO BENZILE",        note:"cuore",fam:"floreale",  price:8, w:10, ifra:false,                                                                                compat:["floreale","aromatico-fougere"]},
  {n:"IDROSSICITRONELLALE",    note:"cuore",fam:"floreale",  price:9, w:12, ifra:true,  ifraMax:1.0,   ifraNote:"Hydroxycitronellal â€” max 1.0% leave-on",              compat:["floreale","fresco-agrumato","chypre-verde"]},
  {n:"SALICILATO BENZILE",     note:"cuore",fam:"floreale",  price:7, w:12, ifra:true,  ifraMax:10.0,  ifraNote:"Benzyl salicylate â€” max 10% leave-on (UE)",           compat:["floreale","chypre-verde","aromatico-fougere"]},
  {n:"ACETATO GERANILE",       note:"cuore",fam:"floreale",  price:9, w:10, ifra:false,                                                                                compat:["floreale","chypre-verde"]},
  {n:"ALDEIDE ALFA EXILCINNAMICA",note:"cuore",fam:"floreale",price:15,w:5, ifra:true,  ifraMax:0.5,   ifraNote:"Î±-Hexylcinnamaldehyde â€” max 0.5% leave-on",           compat:["floreale","orientale-speziato"]},
  {n:"ANTRANILATO METILE",     note:"cuore",fam:"floreale",  price:8, w:8,  ifra:false,                                                                                compat:["floreale","gourmand-dolce"]},
  {n:"LAVANDINO GROSSO",       note:"cuore",fam:"aromatico", price:12,w:12, ifra:false,                                                                                compat:["aromatico-fougere","fresco-agrumato","legnoso-ambrato","chypre-verde"]},
  {n:"SALVIA SCLAREA",         note:"cuore",fam:"aromatico", price:14,w:10, ifra:false,                                                                                compat:["aromatico-fougere","legnoso-ambrato","orientale-speziato"]},
  {n:"HELIONAL",               note:"cuore",fam:"marino",    price:22,w:10, ifra:false,                                                                                compat:["marino-fresco","fresco-agrumato"]},
  {n:"ALDEIDE C14",            note:"cuore",fam:"fresco",    price:12,w:6,  ifra:false,                                                                                compat:["marino-fresco","fresco-agrumato","chypre-verde"]},
  {n:"OCTINE CARBONATO METILE",note:"cuore",fam:"verde",     price:12,w:8,  ifra:false,                                                                                compat:["chypre-verde","floreale","aromatico-fougere"]},
  {n:"CANNELLA CINA",          note:"cuore",fam:"speziato",  price:25,w:2,  ifra:true,  ifraMax:0.1,   ifraNote:"Cinnamaldehyde â€” max 0.1% leave-on (forte allergene)",compat:["orientale-speziato","gourmand-dolce"]},
  {n:"NOCE MOSCATA",           note:"cuore",fam:"speziato",  price:14,w:5,  ifra:true,  ifraMax:1.0,   ifraNote:"Nutmeg oil â€” max 1.0% leave-on",                     compat:["orientale-speziato","legnoso-ambrato","gourmand-dolce"]},
  {n:"EUGENOLO PURO",          note:"cuore",fam:"speziato",  price:10,w:4,  ifra:true,  ifraMax:0.5,   ifraNote:"Eugenol â€” max 0.5% leave-on (allergene IFRA)",        compat:["orientale-speziato","chypre-verde"]},
  // â”€â”€ FONDO â”€â”€
  {n:"ISO E SUPER",            note:"fondo",fam:"legnoso",   price:18,w:15, ifra:false,                                                                                compat:["legnoso-ambrato","orientale-speziato","marino-fresco","aromatico-fougere","chypre-verde","floreale"]},
  {n:"CEDRO VIRGINIA",         note:"fondo",fam:"legnoso",   price:16,w:10, ifra:false,                                                                                compat:["legnoso-ambrato","orientale-speziato","aromatico-fougere","chypre-verde"]},
  {n:"PATCHOULY",              note:"fondo",fam:"legnoso",   price:20,w:8,  ifra:false,                                                                                compat:["legnoso-ambrato","orientale-speziato","chypre-verde","gourmand-dolce"]},
  {n:"VETIVER GIAVA",          note:"fondo",fam:"legnoso",   price:22,w:10, ifra:false,                                                                                compat:["legnoso-ambrato","fresco-agrumato","chypre-verde","aromatico-fougere"]},
  {n:"SANDALORE",              note:"fondo",fam:"legnoso",   price:24,w:10, ifra:false,                                                                                compat:["legnoso-ambrato","floreale","orientale-speziato","gourmand-dolce"]},
  {n:"VERTOFIX COEUR",         note:"fondo",fam:"legnoso",   price:20,w:10, ifra:false,                                                                                compat:["legnoso-ambrato","chypre-verde","aromatico-fougere"]},
  {n:"MOUSSE DE METRE",        note:"fondo",fam:"legnoso",   price:28,w:5,  ifra:true,  ifraMax:0.03,  ifraNote:"Oakmoss absolute â€” max 0.03% leave-on (IFRA strict)", compat:["chypre-verde","aromatico-fougere","legnoso-ambrato"]},
  {n:"AMBROX SUPER",           note:"fondo",fam:"ambrato",   price:35,w:6,  ifra:false,                                                                                compat:["legnoso-ambrato","orientale-speziato","floreale","gourmand-dolce"]},
  {n:"ALDEIDE C18",            note:"fondo",fam:"orientale", price:10,w:4,  ifra:false,                                                                                compat:["orientale-speziato","gourmand-dolce","legnoso-ambrato"]},
  {n:"CUMARINA",               note:"fondo",fam:"dolce",     price:10,w:8,  ifra:true,  ifraMax:1.0,   ifraNote:"Coumarin â€” max 1.0% leave-on (IFRA 50th)",            compat:["gourmand-dolce","orientale-speziato","aromatico-fougere"]},
  {n:"VANILLA",                note:"fondo",fam:"dolce",     price:12,w:5,  ifra:false,                                                                                compat:["gourmand-dolce","orientale-speziato","floreale"]},
  {n:"GALAXOLIDE",             note:"fondo",fam:"muschiato", price:16,w:10, ifra:false,                                                                                compat:["floreale","legnoso-ambrato","marino-fresco","aromatico-fougere","chypre-verde"]},
  {n:"HABANOLIDE",             note:"fondo",fam:"muschiato", price:25,w:6,  ifra:false,                                                                                compat:["floreale","legnoso-ambrato","gourmand-dolce"]},
  {n:"ETILENE BRASSILATE",     note:"fondo",fam:"muschiato", price:18,w:8,  ifra:false,                                                                                compat:["floreale","marino-fresco","chypre-verde","aromatico-fougere"]},
  {n:"INCENSO PURO",           note:"fondo",fam:"resinoso",  price:30,w:5,  ifra:false,                                                                                compat:["orientale-speziato","legnoso-ambrato","chypre-verde"]},
  {n:"MIRRA",                  note:"fondo",fam:"resinoso",  price:22,w:6,  ifra:false,                                                                                compat:["orientale-speziato","legnoso-ambrato"]},
  {n:"BENZOATO BENZILE",       note:"fondo",fam:"balsamico", price:7, w:8,  ifra:true,  ifraMax:8.0,   ifraNote:"Benzyl benzoate â€” max 8% leave-on (UE)",              compat:["floreale","orientale-speziato","gourmand-dolce"]},
];

/* â•â•â• COSTANTI â•â•â• */
const CONC    = {edc:5, edt:10, edp:17};
const ALC_ML  = 0.015; // â‚¬/ml alcol
const DROML   = 0.05;  // ml/goccia
const DENS    = 1.0;   // g/ml media
const PYR     = {testa:25, cuore:40, fondo:35};
const FAMNAMES= {"fresco-agrumato":"Fresco & Agrumato","floreale":"Floreale & Romantico","aromatico-fougere":"Aromatico & FougÃ¨re","legnoso-ambrato":"Legnoso & Ambrato","orientale-speziato":"Orientale & Speziato","marino-fresco":"Marino & Acquatico","chypre-verde":"Chypre & Verde","gourmand-dolce":"Gourmand & Dolce"};
const FAMDESCS= {"fresco-agrumato":"Profilo agrumato brillante â€” apertura vivace su base leggera e raffinata.","floreale":"Bouquet floreale elegante â€” cuore ricco di fiori sostenuto da base muschiata.","aromatico-fougere":"Struttura fougÃ¨re classica â€” lavanda, erbe aromatiche, base legnosa pulita.","legnoso-ambrato":"Legni nobili e ambra calda â€” scia profonda e persistente.","orientale-speziato":"Spezie esotiche e resine â€” composizione misteriosamente avvolgente.","marino-fresco":"Brezze ozoniche e note acquatiche â€” freschezza moderna e urbana.","chypre-verde":"Accordo chypre sofisticato â€” patchouly, muschio di quercia, foglie verdi.","gourmand-dolce":"Note golose e avvolgenti â€” vaniglia, cumarina, gourmand morbido."};
const TYPELBL = {edc:"Eau de Cologne (EDC) ~5%", edt:"Eau de Toilette (EDT) ~10%", edp:"Eau de Parfum (EDP) ~17%"};

/* â•â•â• STATE â•â•â• */
let curStep=1;
const sel={family:null,intensity:null,occasions:[],sweet:50,fresh:50,depth:50};
let F=null;

/* â•â•â• LANDING â•â•â• */
function startApp(){
  const d=document.getElementById('dot');
  d.classList.add('boom');
  setTimeout(()=>document.getElementById('landing').classList.add('fade'),350);
  setTimeout(()=>{
    document.getElementById('landing').style.display='none';
    document.getElementById('hdr').style.display='block';
    document.getElementById('app').classList.add('show');
    updProg();
  },900);
}

/* â•â•â• WIZARD â•â•â• */
function pick(el,key){
  el.closest('.cards').querySelectorAll('.oc').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel');
  sel[key]=el.dataset.v;
}
function toggleTag(el){
  el.classList.toggle('sel');
  const v=el.dataset.v,i=sel.occasions.indexOf(v);
  if(i>-1)sel.occasions.splice(i,1);else sel.occasions.push(v);
}
function usl(id,vid,key){
  const v=+document.getElementById(id).value;
  document.getElementById(vid).textContent=v+'%';
  sel[key]=v;
}
function goNext(){
  if(curStep===1&&!sel.family){alert('âš ï¸ Seleziona una famiglia olfattiva.');return;}
  if(curStep===2&&!sel.intensity){alert('âš ï¸ Seleziona il tipo di concentrazione.');return;}
  setStep(curStep+1);
}
function goBack(){setStep(curStep-1);}
function setStep(n){
  document.querySelector(`.step[data-step="${curStep}"]`).classList.remove('on');
  const prev=document.querySelector(`.ps[data-s="${curStep}"]`);
  if(n>curStep) prev.classList.replace('active','done');
  else prev.classList.remove('done','active');
  curStep=n;
  document.querySelector(`.step[data-step="${curStep}"]`).classList.add('on');
  document.querySelector(`.ps[data-s="${curStep}"]`).classList.add('active');
  updProg();
  window.scrollTo({top:0,behavior:'smooth'});
}
function updProg(){
  document.getElementById('pline').style.width=((curStep-1)/4*100)+'%';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERA FORMULA + TARA IFRA AUTOMATICA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generate(){
  const vol  = Math.max(10, parseInt(document.getElementById('pVol').value)||50);
  const name = document.getElementById('pName').value.trim()||'Il Mio Profumo';
  const type = sel.intensity;
  const fam  = sel.family;
  const concPct = CONC[type]; // % essenze sul volume finale

  /* Stile score */
  function styleScore(x){
    let s=0;
    if(sel.sweet>60 && ['dolce','fruttato','orientale','balsamico'].includes(x.fam)) s+=2;
    if(sel.fresh>60 && ['agrumato','fresco','marino'].includes(x.fam)) s+=2;
    if(sel.depth>60 && ['resinoso','ambrato','legnoso','speziato'].includes(x.fam)) s+=2;
    return s;
  }

  /* Pool per nota */
  const pool=note=>DB.filter(x=>x.note===note && x.compat.includes(fam))
                     .sort((a,b)=>styleScore(b)-styleScore(a));

  const tPick=pool('testa').slice(0,3);
  const cPick=pool('cuore').slice(0,4);
  const fPick=pool('fondo').slice(0,3);

  /* ml concentrato e ml totale gocce */
  const concMl  = vol * concPct / 100;
  const alcMl   = vol - concMl;
  const totDropTgt = concMl / DROML; // gocce totali target

  /* Distribuisce gocce secondo piramide */
  function assignDrops(group, pyrPct){
    const gDrops = totDropTgt * pyrPct / 100;
    const sumW   = group.reduce((s,x)=>s+x.w, 0)||1;
    return group.map(x=>({
      ...x,
      drops: Math.max(1, Math.round(x.w/sumW*gDrops)),
      adjusted: false
    }));
  }

  let tF=assignDrops(tPick, PYR.testa);
  let cF=assignDrops(cPick, PYR.cuore);
  let fF=assignDrops(fPick, PYR.fondo);
  let formula=[...tF,...cF,...fF];

  /* â•â• TARA IFRA â•â•
     Per ogni ingrediente limitato, verifica che
     (gocce * DROML / vol * 100) <= ifraMax.
     Se supera, riduce le gocce al massimo consentito. */
  const taraLog=[];
  formula.forEach(x=>{
    if(!x.ifra) return;
    const maxMl = x.ifraMax * vol / 100;  // ml max consentiti
    const maxDrops = Math.max(1, Math.floor(maxMl / DROML));
    if(x.drops > maxDrops){
      taraLog.push({n:x.n, orig:x.drops, cap:maxDrops, ifraMax:x.ifraMax});
      x.drops = maxDrops;
      x.adjusted = true;
    }
  });

  const totalDrops = formula.reduce((s,x)=>s+x.drops,0);

  /* Piramide reale */
  const pyrT=(formula.filter(x=>x.note==='testa').reduce((s,x)=>s+x.drops,0)/totalDrops*100).toFixed(1);
  const pyrC=(formula.filter(x=>x.note==='cuore').reduce((s,x)=>s+x.drops,0)/totalDrops*100).toFixed(1);
  const pyrF=(formula.filter(x=>x.note==='fondo').reduce((s,x)=>s+x.drops,0)/totalDrops*100).toFixed(1);

  /* Costi */
  const concCost = formula.reduce((s,x)=>s+(x.price/10)*(x.drops*DROML),0);
  const alcCost  = alcMl * ALC_ML;
  const totCost  = concCost + alcCost;

  F={name,fam,type,vol,concPct,concMl,alcMl,formula,totalDrops,
     pyrT,pyrC,pyrF,concCost,alcCost,totCost,taraLog,
     genDate:new Date().toISOString()};

  renderPreview();
}

/* â•â•â• RENDER PREVIEW â•â•â• */
function renderPreview(){
  document.getElementById('prevTitle').textContent=`${F.name} â€” ${F.formula.length} ingredienti`;
  setTimeout(()=>{
    [['T',F.pyrT],['C',F.pyrC],['F',F.pyrF]].forEach(([k,v])=>{
      document.getElementById('p'+k+'l').textContent=v+'%';
      const b=document.getElementById('p'+k+'b');
      b.style.width=v+'%'; b.textContent=v+'%';
    });
  },150);

  const badgeCls=n=>n==='testa'?'bt':n==='cuore'?'bc':'bf';
  document.getElementById('prevList').innerHTML=F.formula.map(x=>{
    const pct=(x.drops/F.totalDrops*100).toFixed(1);
    const gr=(x.drops*DROML*DENS).toFixed(3);
    return `<div class="ing-row">
      <div class="ing-nw"><span class="ing-n">${x.n}</span><span class="badge ${badgeCls(x.note)}">${x.note}</span>${x.adjusted?'<span class="badge adj-b">tarato IFRA</span>':''}</div>
      <span class="ing-pct">${pct}%</span>
      <span class="ing-dr">${x.drops} gocce</span>
      <span class="ing-gr">${gr} g</span>
    </div>`;
  }).join('');

  /* messaggio tara */
  const tm=document.getElementById('taraMsg');
  if(F.taraLog.length>0){
    tm.innerHTML=`<div class="ib warn"><strong>âš ï¸ Tara IFRA applicata</strong> â€” le gocce di ${F.taraLog.length} ingrediente/i sono state ridotte automaticamente per rispettare i limiti IFRA:<br>`+
      F.taraLog.map(t=>`<strong>${t.n}</strong>: ${t.orig} â†’ ${t.cap} gocce (limite ${t.ifraMax}%)`).join('<br>')+`</div>`;
  } else {
    tm.innerHTML=`<div class="ib ok">âœ… Nessuna tara IFRA necessaria â€” tutti gli ingredienti rientrano nei limiti.</div>`;
  }

  document.getElementById('preview').classList.remove('hidden');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â•â•â• MODAL PASSWORD â•â•â• */
function openPass(){
  document.getElementById('passInp').value='';
  document.getElementById('passErr').textContent='';
  document.getElementById('pass-ov').classList.add('show');
  setTimeout(()=>document.getElementById('passInp').focus(),180);
}
function closePass(){ document.getElementById('pass-ov').classList.remove('show'); }
function chkPass(){
  if(document.getElementById('passInp').value!=='FormularioProfumi'){
    document.getElementById('passErr').textContent='âŒ Password errata.';
    document.getElementById('passInp').select(); return;
  }
  if(!F){ document.getElementById('passErr').textContent='âš ï¸ Genera prima una formula.'; return; }
  closePass();
  showFP();
}

/* â•â•â• FORMULA PAGE â•â•â• */
function showFP(){
  const badgeCls=n=>n==='testa'?'bt':n==='cuore'?'bc':'bf';

  document.getElementById('fpName').textContent=F.name;
  document.getElementById('fpDesc').textContent=FAMDESCS[F.fam]||'';
  document.getElementById('fpType').textContent=TYPELBL[F.type];
  document.getElementById('fpVol').textContent=F.vol+' ml';
  document.getElementById('fpCml').textContent=F.concMl.toFixed(2)+' ml';
  document.getElementById('fpAml').textContent=F.alcMl.toFixed(2)+' ml';
  document.getElementById('fpDr').textContent=F.totalDrops+' gocce';
  document.getElementById('fpGr').textContent=(F.totalDrops*DROML*DENS).toFixed(2)+' g';
  document.getElementById('fpNi').textContent=F.formula.length;
  document.getElementById('fpCtot').textContent='â‚¬'+F.totCost.toFixed(2);
  document.getElementById('fpCconc').textContent='â‚¬'+F.concCost.toFixed(2);
  document.getElementById('fpCalc').textContent='â‚¬'+F.alcCost.toFixed(2);
  document.getElementById('fpCml2').textContent='â‚¬'+(F.totCost/F.vol).toFixed(3);
  document.getElementById('iAlc').textContent=F.alcMl.toFixed(1);
  document.getElementById('iType').textContent=F.type.toUpperCase();
  document.getElementById('iVol').textContent=F.vol;

  /* Ingredienti tecnici */
  document.getElementById('fpIngList').innerHTML=F.formula.map(x=>{
    const pct=(x.drops/F.totalDrops*100).toFixed(2);
    const gr=(x.drops*DROML*DENS).toFixed(3);
    return `<div class="ing-row">
      <div class="ing-nw"><span class="ing-n">${x.n}</span><span class="badge ${badgeCls(x.note)}">${x.note}</span>${x.adjusted?'<span class="badge adj-b">tarato IFRA</span>':''}</div>
      <span class="ing-pct">${pct}%</span>
      <span class="ing-dr">${x.drops} gocce</span>
      <span class="ing-gr">${gr} g</span>
    </div>`;
  }).join('');

  /* IFRA check */
  const limited=F.formula.filter(x=>x.ifra);
  const noLimEl=document.getElementById('ifraNoLim');
  const rowsEl=document.getElementById('ifraRows');
  const msgEl=document.getElementById('ifraMsg');
  if(limited.length===0){
    noLimEl.classList.remove('hidden');
    rowsEl.innerHTML=''; msgEl.innerHTML='';
  } else {
    noLimEl.classList.add('hidden');
    let hasViol=false;
    rowsEl.innerHTML=limited.map(x=>{
      const pctFin=(x.drops*DROML/F.vol*100);
      const ok=pctFin<=x.ifraMax;
      if(!ok) hasViol=true;
      return `<div class="ifra-r ${ok?'ifra-ok-r':'ifra-warn-r'}">
        <span><strong>${x.n}</strong><div class="ifra-note">${x.ifraNote}</div></span>
        <span>${pctFin.toFixed(3)}%</span>
        <span>max ${x.ifraMax}%</span>
        <span class="${ok?'ifra-ok':'ifra-warn'}">${ok?'âœ… OK':'âš ï¸ Supera'}</span>
      </div>`;
    }).join('');
    msgEl.innerHTML=hasViol
      ?`<div class="ib">âš ï¸ Attenzione: uno o piÃ¹ ingredienti superano il limite (anomalia di calcolo â€” segnalare).</div>`
      :`<div class="ib ok">âœ… Tutti gli ingredienti IFRA-limitati rientrano nei limiti per fine fragrance leave-on.</div>`;
  }

  document.getElementById('app').style.display='none';
  const fp=document.getElementById('fp');
  fp.classList.add('show');
  window.scrollTo({top:0,behavior:'smooth'});
}

function closeFP(){
  document.getElementById('fp').classList.remove('show');
  document.getElementById('app').style.display='block';
}

function saveF(){
  if(!F) return;
  const saved=JSON.parse(localStorage.getItem('ps_formulas')||'[]');
  saved.unshift({...F, savedAt:new Date().toISOString()});
  localStorage.setItem('ps_formulas',JSON.stringify(saved));
  alert('âœ… Formula "'+F.name+'" salvata!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAMPA CERTIFICATO IN FINESTRA SEPARATA
   â€” Genera HTML completo e autosufficiente, poi apre
     window.print() sulla nuova finestra.
   â€” Nessun visibility:hidden sul body principale.
   â€” @page con margini espliciti garantisce multi-pagina.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function printCert(){
  if(!F){ alert('Nessuna formula caricata.'); return; }

  const certNum='PS-'+Date.now().toString(36).toUpperCase();
  const now=new Date();
  const dateStr=now.toLocaleDateString('it-IT',{day:'2-digit',month:'long',year:'numeric'});
  const timeStr=now.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});

  const limited=F.formula.filter(x=>x.ifra);
  const allOk=limited.every(x=>(x.drops*DROML/F.vol*100)<=x.ifraMax);

  /* â”€â”€ Righe tabella ingredienti â”€â”€ */
  const ingRows=F.formula.map((x,i)=>{
    const pctConc=(x.drops/F.totalDrops*100).toFixed(2);
    const pctFin=(x.drops*DROML/F.vol*100).toFixed(3);
    const gr=(x.drops*DROML*DENS).toFixed(3);
    const noteLbl={'testa':'Testa','cuore':'Cuore','fondo':'Fondo'}[x.note]||x.note;
    const ifraMark=x.ifra?'âš  IFRA':'-';
    const bg=i%2===0?'#fff':'#f9f9f9';
    return `<tr style="background:${bg}">
      <td>${x.n}${x.adjusted?' <em style="color:#b45309;font-size:9pt">(tarato IFRA)</em>':''}</td>
      <td style="text-align:center">${noteLbl}</td>
      <td style="text-align:center">${x.drops}</td>
      <td style="text-align:center">${gr}</td>
      <td style="text-align:center">${pctConc}%</td>
      <td style="text-align:center">${pctFin}%</td>
      <td style="text-align:center">${ifraMark}</td>
    </tr>`;
  }).join('');

  /* â”€â”€ Righe IFRA â”€â”€ */
  let ifraSection='';
  if(limited.length===0){
    ifraSection=`<p style="padding:.6rem;background:#f0fdf4;border-left:3px solid #166534;font-size:9pt;color:#14532d;margin:0">
      âœ… Nessun ingrediente soggetto a restrizioni IFRA presente in questa formula.
    </p>`;
  } else {
    const rows=limited.map(x=>{
      const pctFin=(x.drops*DROML/F.vol*100);
      const ok=pctFin<=x.ifraMax;
      return `<tr style="background:${ok?'rgba(21,128,61,.06)':'rgba(153,27,27,.06)'}">
        <td><strong>${x.n}</strong><br><span style="font-size:8pt;color:#666">${x.ifraNote}</span></td>
        <td style="text-align:center">${pctFin.toFixed(3)}%</td>
        <td style="text-align:center">${x.ifraMax}%</td>
        <td style="text-align:center;font-weight:700;color:${ok?'#166534':'#991b1b'}">${ok?'âœ… CONFORME':'âš  SUPERA'}</td>
      </tr>`;
    }).join('');
    ifraSection=`<table style="width:100%;border-collapse:collapse;font-size:9pt">
      <thead><tr style="background:#e4e4e4">
        <th style="padding:.4rem .5rem;text-align:left;font-size:8pt;text-transform:uppercase;letter-spacing:.05em">Ingrediente</th>
        <th style="padding:.4rem .5rem;text-align:center">% Prod. Finito</th>
        <th style="padding:.4rem .5rem;text-align:center">Limite IFRA Cat.4</th>
        <th style="padding:.4rem .5rem;text-align:center">Stato</th>
      </tr></thead><tbody>${rows}</tbody>
    </table>`;
  }

  /* â”€â”€ Tara log â”€â”€ */
  let taraSection='';
  if(F.taraLog.length>0){
    taraSection=`<div style="background:#fefce8;border-left:3px solid #b45309;padding:.6rem .8rem;margin-top:.8rem;font-size:9pt">
      <strong>Tara IFRA applicata automaticamente:</strong><br>
      ${F.taraLog.map(t=>`${t.n}: ridotto da ${t.orig} a ${t.cap} gocce (limite ${t.ifraMax}% nel prodotto finito)`).join('<br>')}
    </div>`;
  }

  /* â”€â”€ Esito box â”€â”€ */
  const esitoColor=allOk?'#166534':'#991b1b';
  const esitoTxt=allOk
    ?`La presente miscela profumante Ã¨ stata verificata e risulta <strong>conforme</strong> ai limiti IFRA 50th Amendment (2023) per la Categoria 4 â€” Fine Fragrance / Leave-on (applicazione diretta sulla cute). Tutti gli ingredienti soggetti a restrizioni IFRA sono presenti entro i rispettivi limiti massimi.`
    :`âš  La presente miscela profumante presenta una o piÃ¹ non conformitÃ  ai limiti IFRA 50th Amendment (2023) per la Categoria 4. Si raccomanda di riformulare riducendo le quantitÃ  degli ingredienti segnalati prima dell'uso.`;
  const stampaTxt=allOk?'CONFORME':'NON\nCONFORME';
  const stampaColor=allOk?'#166534':'#991b1b';

  /* â•â•â• HTML DEL CERTIFICATO â•â•â•
       Autosufficiente â€” nessuna dipendenza esterna
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const html=`<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Certificato IFRA â€” ${F.name}</title>
<style>
@page{
  size: A4;
  margin: 18mm 16mm 20mm 16mm;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Courier New',Courier,monospace;
  font-size:10pt;
  color:#000;
  background:#fff;
  line-height:1.5;
}
h2{font-size:16pt;font-weight:700;margin-bottom:4pt;}
h3{font-size:10pt;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#555;
   border-bottom:1px solid #ccc;padding-bottom:3pt;margin:14pt 0 7pt;}
table{width:100%;border-collapse:collapse;font-size:9pt;}
th,td{padding:4pt 5pt;border:1px solid #ddd;vertical-align:top;}
thead th{background:#eee;font-size:8pt;text-transform:uppercase;letter-spacing:.05em;}
.cert-hdr{display:flex;justify-content:space-between;align-items:flex-start;
  border-bottom:2.5pt solid #000;padding-bottom:10pt;margin-bottom:12pt;}
.logo{font-size:13pt;font-weight:700;display:flex;align-items:center;gap:5pt;}
.logo-dot{width:9pt;height:9pt;background:#cc0000;border-radius:50%;display:inline-block;}
.meta{text-align:right;font-size:8.5pt;color:#444;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:3pt 16pt;margin-top:4pt;}
.pair{display:flex;justify-content:space-between;padding:3pt 0;border-bottom:1px dashed #ddd;font-size:9pt;}
.pair-l{color:#666;}
.pair-v{font-weight:700;}
.esito-box{display:flex;gap:16pt;align-items:flex-start;margin-top:8pt;}
.esito-text{flex:1;font-size:9pt;line-height:1.6;color:#222;}
.stamp{
  flex-shrink:0;width:72pt;height:72pt;
  border:2.5pt solid ${stampaColor};border-radius:50%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:${stampaColor};font-weight:700;font-size:7pt;text-align:center;
  text-transform:uppercase;letter-spacing:.04em;line-height:1.3;
  white-space:pre-line;
}
.disclaimer{
  background:#f9f9f9;border-left:2.5pt solid #b45309;
  padding:7pt 9pt;font-size:7.5pt;line-height:1.5;color:#555;margin-top:10pt;
}
.footer{
  border-top:2pt solid #000;padding-top:8pt;margin-top:14pt;
  display:flex;justify-content:space-between;align-items:flex-end;font-size:7.5pt;color:#555;
}
.sign-line{width:150pt;height:.8pt;background:#000;margin:20pt auto 3pt;}
.sign-box{text-align:right;}
/* Evita interruzioni in sezioni critiche */
h3{page-break-after:avoid;}
table{page-break-inside:auto;}
tr{page-break-inside:avoid;}
.cert-hdr,.esito-box,.disclaimer,.footer{page-break-inside:avoid;}
@media print{
  body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}
}
</style>
</head>
<body>
<!-- HEADER -->
<div class="cert-hdr">
  <div>
    <div class="logo"><span class="logo-dot"></span>Parfum Studio</div>
    <div style="font-size:7.5pt;color:#777;margin-top:3pt">AI-Powered Fragrance Generator Â· v2.0</div>
  </div>
  <div class="meta">
    <div><strong>CERTIFICATO DI CONFORMITÃ€ IFRA</strong></div>
    <div style="margin:2pt 0">NÂ° ${certNum}</div>
    <div>${dateStr} ore ${timeStr}</div>
  </div>
</div>

<h2>Dichiarazione di ConformitÃ  IFRA</h2>
<p style="font-size:9pt;color:#444;margin-bottom:12pt;line-height:1.6">
  La miscela profumante descritta in questo documento Ã¨ stata formulata e verificata nel rispetto degli standard
  <strong>IFRA â€” International Fragrance Association, 50th Amendment (2023)</strong>,
  <strong>Categoria 4 â€” Fine Fragrance / Leave-on</strong> (applicazione diretta sulla cute).
</p>

<!-- INFO PRODOTTO -->
<h3>Informazioni Prodotto</h3>
<div class="grid2">
  <div class="pair"><span class="pair-l">Nome profumo</span><span class="pair-v">${F.name}</span></div>
  <div class="pair"><span class="pair-l">Tipo concentrazione</span><span class="pair-v">${TYPELBL[F.type]}</span></div>
  <div class="pair"><span class="pair-l">Volume formulato</span><span class="pair-v">${F.vol} ml</span></div>
  <div class="pair"><span class="pair-l">Famiglia olfattiva</span><span class="pair-v">${FAMNAMES[F.fam]||F.fam}</span></div>
  <div class="pair"><span class="pair-l">NÂ° ingredienti</span><span class="pair-v">${F.formula.length}</span></div>
  <div class="pair"><span class="pair-l">Concentrato essenze</span><span class="pair-v">${F.concMl.toFixed(2)} ml (${F.concPct}%)</span></div>
  <div class="pair"><span class="pair-l">Alcol diluente 96Â°</span><span class="pair-v">${F.alcMl.toFixed(2)} ml</span></div>
  <div class="pair"><span class="pair-l">Data formulazione</span><span class="pair-v">${dateStr}</span></div>
  <div class="pair"><span class="pair-l">Standard applicato</span><span class="pair-v">IFRA 50th Amendment</span></div>
  <div class="pair"><span class="pair-l">Categoria IFRA</span><span class="pair-v">Categoria 4 â€” Fine Fragrance</span></div>
</div>

<!-- PIRAMIDE -->
<h3>Piramide Olfattiva</h3>
<div class="grid2">
  <div class="pair"><span class="pair-l">Note di Testa</span><span class="pair-v">${F.pyrT}%</span></div>
  <div class="pair"><span class="pair-l">Note di Cuore</span><span class="pair-v">${F.pyrC}%</span></div>
  <div class="pair"><span class="pair-l">Note di Fondo</span><span class="pair-v">${F.pyrF}%</span></div>
  <div class="pair"><span class="pair-l">Gocce totali concentrato</span><span class="pair-v">${F.totalDrops}</span></div>
</div>

<!-- COMPOSIZIONE -->
<h3>Composizione Dettagliata</h3>
<table>
  <thead>
    <tr>
      <th style="text-align:left">Ingrediente</th>
      <th>Nota</th>
      <th>Gocce</th>
      <th>Grammi</th>
      <th>% Conc.</th>
      <th>% Prod.Finito</th>
      <th>IFRA</th>
    </tr>
  </thead>
  <tbody>${ingRows}</tbody>
</table>

<!-- VERIFICA IFRA -->
<h3>Verifica Limiti IFRA â€” Ingredienti Soggetti a Restrizioni</h3>
<p style="font-size:8.5pt;color:#555;margin-bottom:7pt;line-height:1.5">
  Concentrazioni calcolate nel prodotto finito pronto all'uso (${F.vol} ml totali).
  Limiti: IFRA 50th Amendment (2023), Categoria 4.
</p>
${ifraSection}
${taraSection}

<!-- ESITO -->
<h3>Esito Certificazione</h3>
<div class="esito-box">
  <div class="esito-text">${esitoTxt}</div>
  <div class="stamp">${stampaTxt}<span style="font-size:6.5pt;margin-top:3pt">IFRA CAT.4</span><span style="font-size:6pt">50th Amendment</span></div>
</div>

<!-- DISCLAIMER -->
<div class="disclaimer">
  <strong>âš  Disclaimer:</strong> Questo certificato Ã¨ generato automaticamente da Parfum Studio a scopo orientativo e non costituisce una valutazione della sicurezza ai sensi del Regolamento (CE) n. 1223/2009 sui prodotti cosmetici, nÃ© una certificazione IFRA rilasciata da un profumiere qualificato certificato IFRA. Per immissione commerciale in vendita Ã¨ obbligatoria la compilazione di un PIF (Product Information File) e la valutazione della sicurezza da parte di un Safety Assessor qualificato. I limiti indicati si basano sull'IFRA 50th Amendment (2023), Categoria 4 â€” verificare sempre il certificato IFRA del fornitore per ogni lotto di materia prima acquistata. DensitÃ  degli oli assunta = 1 g/ml a scopo di calcolo (valore indicativo).
</div>

<!-- FOOTER -->
<div class="footer">
  <div>
    <div>Parfum Studio â€” AI Fragrance Generator</div>
    <div>Generato il ${dateStr} alle ${timeStr}</div>
    <div>Certificato NÂ° ${certNum}</div>
  </div>
  <div class="sign-box">
    <div class="sign-line"></div>
    <div>Firma / Timbro Formulatore</div>
    <div style="margin-top:2pt;font-size:7pt;color:#999">Parfum Studio v2.0 â€” generato automaticamente</div>
  </div>
</div>

<script>
  window.onload=function(){
    setTimeout(function(){ window.print(); },400);
  };
<\/script>
</body>
</html>`;

  /* Apri nuova finestra con l'HTML del certificato */
  const w=window.open('','_blank','width=900,height=700,scrollbars=yes');
  if(!w){ alert('Il popup Ã¨ stato bloccato. Abilita i popup per questo sito per stampare il certificato.'); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}
</script>
</body>
</html>
