<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#cc0000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="white">
<meta name="description" content="AI Fragrance Generator & IFRA Calculator">
<title>Parfum Studio</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<!-- Icona per iOS (usa il pallino rosso SVG base64 per semplicit√† immediata) -->
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjIwMCIgZmlsbD0iI2NjMDAwMCIvPjwvc3ZnPg==">

<style>
@import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

/* ‚ïê‚ïê RESET & VARS ‚ïê‚ïê */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bk:#000;--wh:#fff;--rd:#cc0000;
  --g50:#f9f9f9;--g100:#f2f2f2;--g200:#e4e4e4;--g500:#777;--g700:#333;
  --blue:#1a5fb4;--amber:#b45309;--purple:#6d28d9;--green:#15803d;--danger:#991b1b;
  --fn:'Courier Prime','Courier New',monospace;
  --r:12px;--sh:0 4px 20px rgba(0,0,0,.06);
}
body{font-family:var(--fn);background:var(--wh);color:var(--bk);line-height:1.5;overscroll-behavior-y:none;}
.hidden{display:none!important;}

/* ‚ïê‚ïê ANIMATIONS ‚ïê‚ïê */
@keyframes fadeUp{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes boom{0%{transform:scale(1)}55%{transform:scale(30);opacity:.5}100%{transform:scale(0);opacity:0}}

/* ‚ïê‚ïê UI ELEMENTS ‚ïê‚ïê */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.9rem 1.8rem;background:var(--bk);color:var(--wh);border:none;border-radius:50px;font-size:.95rem;font-weight:700;cursor:pointer;transition:transform .2s;font-family:var(--fn);box-shadow:0 4px 10px rgba(0,0,0,.15);}
.btn:active{transform:scale(.96);}
.btn-out{background:var(--g100);color:var(--bk);box-shadow:none;}
.btn-green{background:var(--green);}
.btn-sm{padding:.6rem 1.2rem;font-size:.8rem;}
.install-btn{background:var(--rd);display:none;} /* Nascosto di default */

/* ‚ïê‚ïê LANDING ‚ïê‚ïê */
#landing{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:2rem;text-align:center;position:fixed;inset:0;background:var(--wh);z-index:2000;transition:opacity .5s;}
.dot-hero{width:80px;height:80px;background:var(--rd);border-radius:50%;margin-bottom:2rem;animation:pulse 2s ease-in-out infinite;cursor:pointer;}
.dot-hero.boom{animation:boom .7s ease-out forwards;}
#landing h1{font-size:2.8rem;letter-spacing:-.03em;margin-bottom:.5rem;}

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
#hdr{position:fixed;top:0;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--g200);z-index:900;padding:.8rem 1.2rem;display:none;height:65px;}
.hdr-in{max-width:1000px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;}
.logo{display:flex;align-items:center;gap:.6rem;font-size:1.1rem;font-weight:700;color:var(--bk);}
.logo-dot{width:12px;height:12px;background:var(--rd);border-radius:50%;}
.hdr-acts{display:flex;gap:.6rem;}

/* ‚ïê‚ïê APP LAYOUT ‚ïê‚ïê */
#app{display:none;max-width:1000px;margin:0 auto;padding:5.5rem 1.2rem 8rem;min-height:100vh;}
#app.show{display:block;animation:fadeUp .5s ease;}

/* ‚ïê‚ïê PROGRESS ‚ïê‚ïê */
.prog-wrap{margin-bottom:2rem;padding:0 .5rem;}
.prog-bar{height:4px;background:var(--g200);border-radius:2px;overflow:hidden;margin-bottom:1rem;}
.prog-fill{height:100%;background:var(--rd);width:20%;transition:width .4s ease;}
.prog-lbl{display:flex;justify-content:space-between;font-size:.75rem;color:var(--g500);font-weight:700;text-transform:uppercase;}

/* ‚ïê‚ïê CARDS ‚ïê‚ïê */
.step{display:none;}
.step.on{display:block;animation:fadeUp .3s ease;}
.step-h{font-size:1.8rem;margin-bottom:.5rem;line-height:1.2;}
.step-sub{color:var(--g500);margin-bottom:2rem;}

.grid-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.8rem;}
.card-opt{background:var(--wh);border:2px solid var(--g200);border-radius:var(--r);padding:1.5rem 1rem;text-align:center;transition:all .2s;cursor:pointer;position:relative;}
.card-opt.sel{border-color:var(--bk);background:var(--g50);box-shadow:0 4px 12px rgba(0,0,0,.08);}
.card-opt.sel::after{content:'';position:absolute;top:10px;right:10px;width:10px;height:10px;background:var(--rd);border-radius:50%;}
.co-ico{font-size:2rem;margin-bottom:.8rem;display:block;}
.co-tit{font-weight:700;font-size:.9rem;margin-bottom:.4rem;}
.co-desc{font-size:.75rem;color:var(--g500);line-height:1.4;}

/* ‚ïê‚ïê TAGS & SLIDERS ‚ïê‚ïê */
.tags{display:flex;flex-wrap:wrap;gap:.6rem;}
.tag{padding:.6rem 1rem;border:1px solid var(--g200);border-radius:40px;font-size:.85rem;font-weight:700;background:var(--wh);}
.tag.sel{background:var(--bk);color:var(--wh);border-color:var(--bk);}

.slider-group{margin-bottom:1.5rem;}
.sl-h{display:flex;justify-content:space-between;margin-bottom:.5rem;font-size:.9rem;font-weight:700;}
input[type=range]{width:100%;accent-color:var(--rd);height:6px;}

.inp-group{margin-bottom:1.2rem;}
.inp-group label{display:block;font-size:.8rem;font-weight:700;margin-bottom:.4rem;text-transform:uppercase;color:var(--g500);}
.inp{width:100%;padding:1rem;border:2px solid var(--g200);border-radius:var(--r);font-family:var(--fn);font-size:1rem;background:var(--wh);}
.inp:focus{border-color:var(--bk);outline:none;}

/* ‚ïê‚ïê PREVIEW & DATA ‚ïê‚ïê */
.box{background:var(--wh);border:1px solid var(--g200);border-radius:var(--r);padding:1.5rem;margin-bottom:1.5rem;box-shadow:var(--sh);}
.box-h{font-size:1.1rem;font-weight:700;margin-bottom:1rem;border-bottom:1px solid var(--g100);padding-bottom:.8rem;}

.row-ing{display:flex;align-items:center;justify-content:space-between;padding:.8rem 0;border-bottom:1px solid var(--g100);font-size:.85rem;}
.row-ing:last-child{border-bottom:none;}
.ri-l{display:flex;flex-direction:column;gap:2px;}
.ri-n{font-weight:700;}
.ri-meta{font-size:.7rem;color:var(--g500);display:flex;gap:6px;align-items:center;}
.bdg{padding:2px 6px;border-radius:4px;font-size:.65rem;font-weight:700;text-transform:uppercase;}
.bdg.t{background:#e0f2fe;color:var(--blue);}
.bdg.c{background:#fef3c7;color:var(--amber);}
.bdg.f{background:#f3e8ff;color:var(--purple);}
.bdg.warn{background:#fee2e2;color:var(--danger);}
.ri-r{text-align:right;}
.ri-dr{font-weight:700;color:var(--rd);}

.ifra-warn-box{background:#fff1f2;border:1px solid #fecaca;color:#881337;padding:1rem;border-radius:var(--r);font-size:.8rem;margin-bottom:1rem;line-height:1.5;}

/* ‚ïê‚ïê MODAL ‚ïê‚ïê */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:3000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(5px);}
.modal{background:var(--wh);width:90%;max-width:400px;padding:2rem;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,.2);animation:fadeUp .3s;}
.m-ti{font-size:1.3rem;font-weight:700;margin-bottom:.5rem;}
.m-txt{font-size:.9rem;color:var(--g500);margin-bottom:1.5rem;}
.btns-row{display:flex;gap:.8rem;justify-content:flex-end;}

/* ‚ïê‚ïê NAV BOTTOM ‚ïê‚ïê */
.nav-bot{position:fixed;bottom:0;left:0;right:0;background:var(--wh);border-top:1px solid var(--g200);padding:1rem;display:none;justify-content:space-between;z-index:800;}
.nav-bot.show{display:flex;}

/* ‚ïê‚ïê PRINT ‚ïê‚ïê */
@media print{
  body{background:#fff;}
  #landing,#hdr,.nav-bot,.modal-ov,.btn{display:none!important;}
  #app{margin:0;padding:0;}
}
</style>
</head>
<body>

<!-- 1. LANDING SCREEN -->
<div id="landing">
  <div class="dot-hero" id="dot" onclick="initApp()"></div>
  <h1>Parfum Studio</h1>
  <p style="color:#777;margin-bottom:2rem;">Generatore di Formule & Calcolatore IFRA</p>
  <button class="btn" onclick="initApp()">Inizia Creazione</button>
</div>

<!-- 2. HEADER -->
<div id="hdr">
  <div class="hdr-in">
    <div class="logo" onclick="location.reload()">
      <div class="logo-dot"></div>Parfum Studio
    </div>
    <div class="hdr-acts">
      <button class="btn btn-sm install-btn" id="installBtn" onclick="installPWA()">‚Üì Installa</button>
      <button class="btn btn-sm btn-out" onclick="location.reload()">‚Ü∫</button>
      <button class="btn btn-sm" onclick="openLocker()">üîê</button>
    </div>
  </div>
</div>

<!-- 3. MAIN APP WIZARD -->
<div id="app">
  
  <!-- Progress -->
  <div class="prog-wrap">
    <div class="prog-bar"><div class="prog-fill" id="pb"></div></div>
    <div class="prog-lbl"><span id="pl-txt">FASE 1 DI 5</span><span>CREAZIONE</span></div>
  </div>

  <!-- STEP 1: Famiglia -->
  <div class="step on" data-s="1">
    <h2 class="step-h">Famiglia Olfattiva</h2>
    <p class="step-sub">Scegli l'anima della tua fragranza.</p>
    <div class="grid-cards">
      <div class="card-opt" onclick="pick('fam','agrumato',this)"><span class="co-ico">üçã</span><div class="co-tit">Agrumato</div><div class="co-desc">Fresco, energetico, solare.</div></div>
      <div class="card-opt" onclick="pick('fam','floreale',this)"><span class="co-ico">üå∏</span><div class="co-tit">Floreale</div><div class="co-desc">Romantico, elegante, petali.</div></div>
      <div class="card-opt" onclick="pick('fam','legnoso',this)"><span class="co-ico">üå≤</span><div class="co-tit">Legnoso</div><div class="co-desc">Caldo, secco, avvolgente.</div></div>
      <div class="card-opt" onclick="pick('fam','orientale',this)"><span class="co-ico">üî•</span><div class="co-tit">Orientale</div><div class="co-desc">Speziato, ambrato, sensuale.</div></div>
      <div class="card-opt" onclick="pick('fam','marino',this)"><span class="co-ico">üåä</span><div class="co-tit">Marino</div><div class="co-desc">Brezza, sale, ozono.</div></div>
      <div class="card-opt" onclick="pick('fam','gourmand',this)"><span class="co-ico">üç∞</span><div class="co-tit">Gourmand</div><div class="co-desc">Dolce, vanigliato, commestibile.</div></div>
    </div>
  </div>

  <!-- STEP 2: Intensit√† -->
  <div class="step" data-s="2">
    <h2 class="step-h">Concentrazione</h2>
    <p class="step-sub">Quanto deve essere intenso?</p>
    <div class="grid-cards">
      <div class="card-opt" onclick="pick('conc','edc',this)"><span class="co-ico">‚òÅÔ∏è</span><div class="co-tit">Eau de Cologne</div><div class="co-desc">Leggero (5%) ¬∑ 2h</div></div>
      <div class="card-opt" onclick="pick('conc','edt',this)"><span class="co-ico">üí®</span><div class="co-tit">Eau de Toilette</div><div class="co-desc">Medio (10%) ¬∑ 4h</div></div>
      <div class="card-opt" onclick="pick('conc','edp',this)"><span class="co-ico">‚ö°</span><div class="co-tit">Eau de Parfum</div><div class="co-desc">Intenso (17%) ¬∑ 8h</div></div>
    </div>
  </div>

  <!-- STEP 3: Stile -->
  <div class="step" data-s="3">
    <h2 class="step-h">Carattere</h2>
    <p class="step-sub">Modella le sfumature olfattive.</p>
    <div class="box">
      <div class="slider-group">
        <div class="sl-h"><span>Dolcezza</span><span id="v-sw">50%</span></div>
        <input type="range" oninput="updSl(this,'v-sw','sweet')" value="50">
      </div>
      <div class="slider-group">
        <div class="sl-h"><span>Freschezza</span><span id="v-fr">50%</span></div>
        <input type="range" oninput="updSl(this,'v-fr','fresh')" value="50">
      </div>
      <div class="slider-group">
        <div class="sl-h"><span>Profondit√†</span><span id="v-dp">50%</span></div>
        <input type="range" oninput="updSl(this,'v-dp','depth')" value="50">
      </div>
    </div>
  </div>

  <!-- STEP 4: Dettagli -->
  <div class="step" data-s="4">
    <h2 class="step-h">Progetto</h2>
    <p class="step-sub">Definisci i parametri finali.</p>
    <div class="inp-group">
      <label>Nome del Profumo</label>
      <input type="text" class="inp" id="pName" placeholder="Es. Notte Estiva">
    </div>
    <div class="inp-group">
      <label>Volume Finale (ml)</label>
      <input type="number" class="inp" id="pVol" value="50">
    </div>
  </div>

  <!-- STEP 5: Risultato Pubblico -->
  <div class="step" data-s="5">
    <div class="box">
      <div class="box-h">Formula Generata</div>
      <div id="pub-list"></div>
      <div id="ifra-alert"></div>
      <div style="font-size:.8rem;color:var(--g500);margin-top:1rem;background:var(--g50);padding:1rem;border-radius:8px;">
        üëÅ <strong>Anteprima Pubblica:</strong> Mostra solo ingredienti e grammature. Per visualizzare istruzioni, costi e scaricare il certificato IFRA PDF, accedi all'Area Riservata.
      </div>
    </div>
  </div>

  <!-- STEP 6: Area Riservata (Full) -->
  <div class="step" data-s="6">
    <h2 class="step-h">Area Tecnica</h2>
    <div class="box">
      <div class="box-h">‚öóÔ∏è Composizione & IFRA</div>
      <p style="font-size:.8rem;color:var(--g500);margin-bottom:1rem;">
        Calcoli basati su molecola pura attiva (con correzione diluizioni). 
      </p>
      <div id="priv-list"></div>
    </div>
    
    <div class="box">
      <div class="box-h">üí∂ Costi Produzione</div>
      <div style="display:flex;justify-content:space-between;margin-bottom:.5rem;">
        <span>Costo Concentrato</span><strong id="c-conc">‚Ç¨0.00</strong>
      </div>
      <div style="display:flex;justify-content:space-between;margin-bottom:.5rem;">
        <span>Costo Alcol</span><strong id="c-alc">‚Ç¨0.00</strong>
      </div>
      <div style="display:flex;justify-content:space-between;border-top:1px solid #eee;padding-top:.5rem;font-size:1.2rem;">
        <strong>TOTALE</strong><strong style="color:var(--rd)" id="c-tot">‚Ç¨0.00</strong>
      </div>
    </div>

    <div class="box">
      <div class="box-h">üìÑ Esporta</div>
      <button class="btn btn-green" style="width:100%" onclick="printCert()">Scarica Certificato IFRA PDF</button>
    </div>
  </div>

</div>

<!-- NAVIGAZIONE BOTTOM -->
<div class="nav-bot" id="nav">
  <button class="btn btn-out btn-sm" onclick="mov(-1)">‚Üê Indietro</button>
  <button class="btn btn-sm" id="nextBtn" onclick="mov(1)">Continua ‚Üí</button>
</div>

<!-- LOCKER MODAL -->
<div class="modal-ov" id="locker">
  <div class="modal">
    <div class="m-ti">Area Riservata</div>
    <div class="m-txt">Inserisci la password per accedere ai dati tecnici e al certificato.</div>
    <input type="password" class="inp" id="pwd" placeholder="Password..." style="margin-bottom:1rem;">
    <div class="btns-row">
      <button class="btn btn-out" onclick="document.getElementById('locker').style.display='none'">Annulla</button>
      <button class="btn" onclick="checkPass()">Entra</button>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê LOGICA DATABASE E IFRA ‚ïê‚ïê‚ïê‚ïê */
/* Dilution: 1.0 = puro, 0.1 = 10% sol. */
const DB=[
  {n:"Bergamotto FCF",fam:"agrumato",note:"t",dil:1.0,ifra:0.4,p:18,w:12},
  {n:"Limone IT",fam:"agrumato",note:"t",dil:1.0,ifra:2.0,p:12,w:12},
  {n:"Mandarino",fam:"agrumato",note:"t",dil:1.0,ifra:null,p:15,w:10},
  {n:"Linalolo",fam:"floreale",note:"t",dil:1.0,ifra:5.0,p:10,w:10},
  {n:"Pepe Nero",fam:"orientale",note:"t",dil:1.0,ifra:null,p:16,w:4},
  {n:"Manzanate 1% TRI",fam:"agrumato",note:"t",dil:0.01,ifra:0.05,p:16,w:3},
  {n:"Hedione",fam:"floreale",note:"c",dil:1.0,ifra:null,p:25,w:15},
  {n:"Damascenone 1% TRI",fam:"floreale",note:"c",dil:0.01,ifra:0.02,p:55,w:2},
  {n:"Iso E Super",fam:"legnoso",note:"f",dil:1.0,ifra:null,p:18,w:15},
  {n:"Ambrox 10% IPM",fam:"orientale",note:"f",dil:0.1,ifra:null,p:35,w:8},
  {n:"Vanillina 10% TRI",fam:"gourmand",note:"f",dil:0.1,ifra:null,p:12,w:6},
  {n:"Cumarina 10% TRI",fam:"gourmand",note:"f",dil:0.1,ifra:1.0,p:10,w:8},
  {n:"Muschio Galax. 50%",fam:"floreale",note:"f",dil:0.5,ifra:null,p:16,w:10},
  {n:"Patchouly",fam:"legnoso",note:"f",dil:1.0,ifra:null,p:20,w:8},
  {n:"Vetiver",fam:"legnoso",note:"f",dil:1.0,ifra:null,p:22,w:8}
];

const ST={s:1,data:{fam:null,conc:null,sweet:50,fresh:50,depth:50,name:''}};
let FORMULA=null;

/* PWA INSTALL LOGIC */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBtn').style.display = 'flex';
});
async function installPWA() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      document.getElementById('installBtn').style.display = 'none';
    }
    deferredPrompt = null;
  }
}
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

/* APP LOGIC */
function initApp(){
  document.getElementById('dot').classList.add('boom');
  setTimeout(()=>{
    document.getElementById('landing').style.opacity=0;
    setTimeout(()=>{
      document.getElementById('landing').classList.add('hidden');
      document.getElementById('hdr').style.display='block';
      document.getElementById('app').classList.add('show');
      document.getElementById('nav').classList.add('show');
    },400);
  },800);
}

function pick(cat,val,el){
  ST.data[cat]=val;
  el.parentNode.querySelectorAll('.card-opt').forEach(x=>x.classList.remove('sel'));
  el.classList.add('sel');
}
function updSl(el,id,k){
  document.getElementById(id).innerText=el.value+'%';
  ST.data[k]=parseInt(el.value);
}

function mov(d){
  const n=ST.s+d;
  if(d>0){
    if(ST.s==1 && !ST.data.fam) return alert("Seleziona famiglia");
    if(ST.s==2 && !ST.data.conc) return alert("Seleziona concentrazione");
    if(ST.s==4) calcFormula();
    if(ST.s==6) return; // Fine
  }
  if(n<1) return;
  
  document.querySelectorAll('.step').forEach(x=>x.classList.remove('on'));
  document.querySelector(`.step[data-s="${n}"]`).classList.add('on');
  ST.s=n;
  
  // Progress UI
  document.getElementById('pb').style.width=(n/6*100)+'%';
  document.getElementById('pl-txt').innerText=`FASE ${n} DI 6`;
  
  // Button text
  const nb=document.getElementById('nextBtn');
  if(n==4) nb.innerText="Genera Formula ‚ú®";
  else if(n==5) nb.innerText="Area Riservata üîê";
  else nb.innerText="Continua ‚Üí";
  
  window.scrollTo(0,0);
}

/* CALCOLO FORMULA */
function calcFormula(){
  const vol=parseInt(document.getElementById('pVol').value)||50;
  const concPct=ST.data.conc=='edc'?5:ST.data.conc=='edt'?10:17;
  const concMl=vol*concPct/100;
  const alcMl=vol-concMl;
  
  // Filtro Ingredienti
  let pool=DB.filter(x=>x.fam==ST.data.fam || x.fam=='floreale' || x.fam=='legnoso'); // Semplificato
  // 3 Testa, 3 Cuore, 3 Fondo
  const selI=[
    ...pool.filter(x=>x.note=='t').slice(0,3),
    ...pool.filter(x=>x.note=='c').slice(0,3),
    ...pool.filter(x=>x.note=='f').slice(0,3)
  ];
  
  // Distribuzione Pesi
  const totW=selI.reduce((a,b)=>a+b.w,0);
  const mlPerW=concMl/totW;
  
  const F=[];
  const dropsPerMl=20; // 1ml = 20 drops (0.05ml/drop)
  
  selI.forEach(ing=>{
    let drops=Math.round(ing.w*mlPerW*dropsPerMl);
    let tara=false;
    
    // TARA IFRA (con Diluizione)
    // MaxPura% = (Gocce * 0.05 * Diluizione) / Vol * 100
    // MaxGocce = (MaxPura% * Vol) / (100 * 0.05 * Diluizione)
    if(ing.ifra){
      const maxD=Math.floor((ing.ifra*vol)/(5*ing.dilution)); // 5 = 100*0.05
      if(drops>maxD){
        drops=maxD;
        tara=true;
      }
    }
    
    // Calcoli Finali
    const gr=drops*0.05; // Densit√† approx 1
    const cost=(ing.p/10)*gr; // p √® per 10ml
    const purePct=(drops*0.05*ing.dilution)/vol*100;
    
    F.push({...ing, drops, gr, cost, tara, purePct});
  });
  
  FORMULA={vol,concMl,alcMl,items:F};
  renderPub();
}

function renderPub(){
  const d=document.getElementById('pub-list');
  d.innerHTML=FORMULA.items.map(i=>`
    <div class="row-ing">
      <div class="ri-l">
        <div class="ri-n">${i.n}</div>
        <div class="ri-meta">
          <span class="bdg ${i.note}">${i.note=='t'?'Testa':i.note=='c'?'Cuore':'Fondo'}</span>
          ${i.tara?'<span class="bdg warn">TARATO IFRA</span>':''}
        </div>
      </div>
      <div class="ri-r">
        <div class="ri-dr">${i.drops} gc</div>
        <div style="font-size:.75rem">${i.gr.toFixed(2)} g</div>
      </div>
    </div>
  `).join('');
  
  const tarati=FORMULA.items.filter(x=>x.tara).length;
  document.getElementById('ifra-alert').innerHTML=tarati>0 
    ? `<div class="ifra-warn-box">‚ö†Ô∏è Attenzione: <strong>${tarati} ingredienti</strong> sono stati ridotti automaticamente per rispettare i limiti IFRA di sicurezza.</div>`
    : '';
}

function openLocker(){
  if(ST.s<5) return alert("Genera prima una formula.");
  document.getElementById('locker').style.display='flex';
}

function checkPass(){
  if(document.getElementById('pwd').value=='FormularioProfumi'){ // Password fissa
    document.getElementById('locker').style.display='none';
    mov(1); // Vai a step 6
    renderPriv();
  } else {
    alert("Password Errata");
  }
}

function renderPriv(){
  const d=document.getElementById('priv-list');
  let cConc=0;
  
  d.innerHTML=FORMULA.items.map(i=>{
    cConc+=i.cost;
    const dilTxt=i.dil<1?`${Math.round(i.dil*100)}% sol.`:'Puro';
    return `
    <div class="row-ing">
      <div class="ri-l">
        <div class="ri-n">${i.n}</div>
        <div class="ri-meta">${dilTxt} ¬∑ Pura nel fin: ${i.purePct.toFixed(2)}% (Max ${i.ifra||'ND'})</div>
      </div>
      <div class="ri-r">
        <div class="ri-dr">‚Ç¨${i.cost.toFixed(2)}</div>
      </div>
    </div>
  `}).join('');
  
  const cAlc=FORMULA.alcMl*0.015;
  document.getElementById('c-conc').innerText=`‚Ç¨${cConc.toFixed(2)}`;
  document.getElementById('c-alc').innerText=`‚Ç¨${cAlc.toFixed(2)}`;
  document.getElementById('c-tot').innerText=`‚Ç¨${(cConc+cAlc).toFixed(2)}`;
}

function printCert(){
  const w=window.open('','_blank');
  w.document.write(`<html><head><title>Certificato IFRA</title></head><body style="font-family:monospace;padding:2rem;">
    <h1>Certificato di Conformit√† IFRA</h1>
    <p>Nome: ${document.getElementById('pName').value || 'Mio Profumo'}</p>
    <p>Data: ${new Date().toLocaleDateString()}</p>
    <hr>
    <h3>Composizione (Verifica Diluizioni & IFRA)</h3>
    <table style="width:100%;text-align:left;font-size:12px;">
      <tr><th>Ingrediente</th><th>Gocce</th><th>Grammi</th><th>Diluizione</th><th>% Pura Finale</th><th>Limite IFRA</th></tr>
      ${FORMULA.items.map(i=>`
        <tr>
          <td>${i.n}</td>
          <td>${i.drops}</td>
          <td>${i.gr.toFixed(2)}</td>
          <td>${i.dil*100}%</td>
          <td>${i.purePct.toFixed(3)}%</td>
          <td>${i.ifra?i.ifra+'%':'ND'}</td>
        </tr>
      `).join('')}
    </table>
    <br>
    <div style="background:#eee;padding:10px;border-left:5px solid green;">
      <strong>ESITO: CONFORME</strong><br>
      La formula rispetta i limiti IFRA 50th Amendment (Cat. 4). I calcoli tengono conto della diluizione dei materiali in ingresso.
    </div>
    <script>window.print()<\/script>
  </body></html>`);
  w.document.close();
}
</script>
</body>
</html>
