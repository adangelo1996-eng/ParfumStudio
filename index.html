<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parfum Studio</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --black:#000;--white:#fff;--red:#e00;
  --g50:#f9f9f9;--g100:#f2f2f2;--g200:#e8e8e8;--g300:#d0d0d0;
  --g500:#777;--g700:#333;
  --blue:#1d6ecf;--amber:#d97706;--purple:#6d28d9;
  --green:#15803d;--danger:#b91c1c;
  --font:'Courier Prime','Courier New',monospace;
  --radius:10px;--shadow:0 2px 16px rgba(0,0,0,.09);
}
body{font-family:var(--font);background:var(--white);color:var(--black);line-height:1.6;-webkit-font-smoothing:antialiased;}

/* â•â•â• UTILS â•â•â• */
.hidden{display:none!important;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes boom{0%{transform:scale(1)}55%{transform:scale(20);opacity:.5}100%{transform:scale(1);opacity:0}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{
  display:inline-flex;align-items:center;gap:.4rem;
  padding:.85rem 2.2rem;background:var(--black);color:var(--white);
  border:2px solid var(--black);border-radius:50px;
  font-size:.95rem;font-weight:600;cursor:pointer;
  transition:all .25s;letter-spacing:.03em;font-family:var(--font);
}
.btn:hover{background:var(--red);border-color:var(--red);transform:translateY(-2px);}
.btn:disabled{opacity:.38;pointer-events:none;}
.btn-outline{background:var(--white);color:var(--black);}
.btn-outline:hover{background:var(--black);color:var(--white);}
.btn-sm{padding:.55rem 1.4rem;font-size:.87rem;}
.btn-danger{background:var(--danger);border-color:var(--danger);}
.btn-danger:hover{background:#900;border-color:#900;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#landing{
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;min-height:100vh;padding:2rem;text-align:center;
  transition:opacity .45s;
}
#landing.fade{opacity:0;pointer-events:none;}
.dot{
  width:70px;height:70px;background:var(--red);border-radius:50%;
  margin-bottom:2.5rem;animation:pulse 2s ease-in-out infinite;
}
.dot.boom{animation:boom .7s ease-out forwards;}
#landing h1{font-size:3.2rem;font-weight:400;letter-spacing:.02em;margin-bottom:.5rem;}
.land-sub{font-size:1.05rem;color:var(--g500);margin-bottom:2.8rem;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hdr{
  position:fixed;top:0;left:0;right:0;
  background:rgba(255,255,255,.96);backdrop-filter:blur(12px);
  border-bottom:1.5px solid var(--g200);z-index:900;
  padding:1.1rem 2rem;display:none;
}
.hdr-inner{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:1rem;}
.logo{display:flex;align-items:center;gap:.5rem;font-size:1.25rem;font-weight:600;cursor:pointer;transition:opacity .2s;}
.logo:hover{opacity:.6;}
.logo-dot{width:10px;height:10px;background:var(--red);border-radius:50%;}
.hdr-btns{display:flex;gap:.6rem;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{
  display:none;max-width:1100px;margin:0 auto;
  padding:7rem 1.5rem 3rem;
}
#app.show{display:block;animation:fadeUp .5s ease;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prog-wrap{background:var(--g50);border:1px solid var(--g200);border-radius:var(--radius);padding:1.4rem 1.8rem;margin-bottom:2rem;}
.prog-steps{display:flex;position:relative;}
.prog-steps::before{content:'';position:absolute;top:18px;left:0;right:0;height:2px;background:var(--g200);z-index:0;}
.prog-line{position:absolute;top:18px;left:0;height:2px;background:var(--red);z-index:1;transition:width .4s ease;width:0%;}
.ps{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;z-index:2;}
.ps-num{
  width:36px;height:36px;border-radius:50%;background:var(--white);
  border:2px solid var(--g300);display:flex;align-items:center;
  justify-content:center;font-weight:700;font-size:.9rem;
  margin-bottom:.3rem;transition:all .3s;
}
.ps.active .ps-num{background:var(--black);border-color:var(--black);color:var(--white);}
.ps.done .ps-num{background:var(--red);border-color:var(--red);color:var(--white);}
.ps-lbl{font-size:.75rem;color:var(--g500);text-align:center;}
.ps.active .ps-lbl{color:var(--black);font-weight:700;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.step{display:none;}
.step.on{display:block;animation:fadeUp .3s ease;}
.step-h{font-size:2rem;font-weight:400;letter-spacing:.01em;margin-bottom:.5rem;}
.step-sub{font-size:1rem;color:var(--g500);margin-bottom:1.8rem;}

/* â•â•â• OPTION CARDS â•â•â• */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;margin-bottom:1.8rem;}
.opt-card{
  background:var(--g50);border:2px solid var(--g200);border-radius:var(--radius);
  padding:1.4rem 1rem;cursor:pointer;text-align:center;transition:all .25s;position:relative;
}
.opt-card:hover{border-color:var(--black);transform:translateY(-3px);box-shadow:var(--shadow);}
.opt-card.sel{background:var(--black);color:var(--white);border-color:var(--black);}
.opt-card.sel::after{
  content:'âœ“';position:absolute;top:8px;right:10px;
  font-size:.75rem;font-weight:700;background:var(--red);color:var(--white);
  width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;
}
.oc-icon{font-size:2.2rem;margin-bottom:.7rem;display:block;}
.oc-title{font-size:.95rem;font-weight:700;margin-bottom:.25rem;}
.oc-desc{font-size:.82rem;opacity:.75;line-height:1.4;}
.opt-card.sel .oc-desc{opacity:.8;}

/* â•â•â• TAGS â•â•â• */
.tags{display:flex;flex-wrap:wrap;gap:.7rem;margin-bottom:1.8rem;}
.tag{
  padding:.55rem 1.2rem;background:var(--g50);border:2px solid var(--g200);
  border-radius:50px;cursor:pointer;font-weight:500;font-size:.88rem;transition:all .25s;
}
.tag:hover{border-color:var(--black);}
.tag.sel{background:var(--black);color:var(--white);border-color:var(--black);}

/* â•â•â• SLIDERS â•â•â• */
.slider-wrap{margin-bottom:1.8rem;}
.slider-row{display:flex;justify-content:space-between;margin-bottom:.5rem;font-weight:600;}
.s-val{color:var(--red);}
input[type=range]{
  width:100%;height:6px;border-radius:3px;background:var(--g200);
  -webkit-appearance:none;appearance:none;outline:none;cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:20px;height:20px;border-radius:50%;
  background:var(--red);cursor:pointer;transition:transform .2s;
}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.3);}
input[type=range]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--red);border:none;}

/* â•â•â• INPUTS â•â•â• */
.field{margin-bottom:1.4rem;}
.field label{display:block;font-weight:700;margin-bottom:.35rem;font-size:.92rem;}
.inp{
  width:100%;padding:.85rem 1rem;border:2px solid var(--g200);border-radius:var(--radius);
  font-size:1rem;font-family:var(--font);transition:border-color .25s;background:var(--white);
}
.inp:focus{outline:none;border-color:var(--black);}

/* â•â•â• NAV BUTTONS â•â•â• */
.nav-btns{display:flex;justify-content:space-between;gap:1rem;margin-top:2rem;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PUBLIC PREVIEW (ingredienti)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#preview{margin-top:2rem;}
.block{
  background:var(--g50);border:1px solid var(--g200);border-radius:var(--radius);
  padding:1.6rem;margin-bottom:1.5rem;box-shadow:var(--shadow);
}
.block-title{font-size:1.15rem;font-weight:700;margin-bottom:1.2rem;text-align:center;letter-spacing:.01em;}

/* pyramid bars */
.pyr-section{margin-bottom:1.1rem;}
.pyr-head{display:flex;justify-content:space-between;font-weight:600;font-size:.9rem;margin-bottom:.35rem;}
.pyr-track{height:38px;background:var(--g200);border-radius:6px;overflow:hidden;}
.pyr-fill{
  height:100%;display:flex;align-items:center;padding-left:.8rem;
  color:var(--white);font-weight:700;font-size:.85rem;
  transition:width 1s ease;min-width:2.5rem;
}
.pyr-t{background:var(--blue);}
.pyr-c{background:var(--amber);}
.pyr-f{background:var(--purple);}

/* ingredient rows */
.ing-row{
  display:grid;grid-template-columns:1fr auto auto auto;
  align-items:center;gap:.8rem;
  padding:.9rem 1rem;margin-bottom:.5rem;
  background:var(--white);border:1px solid var(--g200);border-radius:8px;
  transition:border-color .2s,transform .2s;
}
.ing-row:hover{border-color:var(--black);transform:translateX(3px);}
.ing-name-wrap{display:flex;align-items:center;gap:.6rem;}
.ing-name{font-weight:700;font-size:.95rem;}
.badge{
  padding:.2rem .6rem;border-radius:8px;font-size:.7rem;
  font-weight:700;text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;
}
.bt{background:rgba(29,110,207,.1);color:var(--blue);}
.bc{background:rgba(217,119,6,.1);color:var(--amber);}
.bf{background:rgba(109,40,217,.1);color:var(--purple);}
.ing-pct{font-size:.85rem;color:var(--g500);font-weight:500;text-align:right;}
.ing-drops{font-weight:700;color:var(--red);white-space:nowrap;font-size:.92rem;text-align:right;}
.ing-grams{font-weight:600;color:var(--g700);white-space:nowrap;font-size:.92rem;text-align:right;}

/* info box */
.info-box{
  background:#fff5f5;border-left:4px solid var(--red);
  padding:1rem 1.3rem;border-radius:8px;
  margin:1.2rem 0;font-size:.9rem;line-height:1.7;
}
.info-box.ok{background:#f0fdf4;border-left-color:var(--green);}
.info-box.warn{background:#fefce8;border-left-color:var(--amber);}

.actions{display:flex;gap:.8rem;justify-content:flex-end;flex-wrap:wrap;margin-top:1.2rem;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PASSWORD OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#pass-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:1000;
  backdrop-filter:blur(4px);
}
#pass-overlay.show{display:flex;}
.pass-box{
  background:var(--white);border-radius:14px;padding:2rem 2.2rem;
  max-width:380px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.35);
  animation:fadeUp .3s ease;
}
.pass-box h3{font-size:1.3rem;font-weight:700;margin-bottom:.3rem;}
.pass-box p{font-size:.88rem;color:var(--g500);margin-bottom:1.2rem;}
.pass-err{font-size:.85rem;color:var(--danger);margin-top:.5rem;min-height:1.2em;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMULA PAGE (protected)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#formula-page{
  display:none;max-width:900px;margin:7rem auto 3rem;padding:0 1.5rem;
}
#formula-page.show{display:block;animation:fadeUp .4s ease;}

.fp-hero{
  background:var(--black);color:var(--white);
  border-radius:var(--radius);padding:2rem 2.2rem;margin-bottom:1.5rem;
}
.fp-name{font-size:1.9rem;font-weight:700;margin-bottom:.3rem;}
.fp-desc{font-size:.95rem;opacity:.7;line-height:1.6;}

.fp-block{
  background:var(--g50);border:1px solid var(--g200);
  border-radius:var(--radius);padding:1.6rem;margin-bottom:1.5rem;
  box-shadow:var(--shadow);
}
.fp-h{font-size:1.1rem;font-weight:700;margin-bottom:1rem;padding-bottom:.6rem;border-bottom:2px solid var(--g200);}

/* cost display */
.cost-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin-top:.8rem;}
.cost-cell{background:var(--white);border:1px solid var(--g200);border-radius:8px;padding:1rem;text-align:center;}
.cc-label{font-size:.75rem;text-transform:uppercase;letter-spacing:.08em;color:var(--g500);margin-bottom:.3rem;}
.cc-val{font-size:1.5rem;font-weight:700;}
.cc-val.big{font-size:2rem;color:var(--red);}

/* summary rows */
.sum-row{display:flex;justify-content:space-between;padding:.6rem 0;border-bottom:1px solid var(--g200);font-size:.93rem;}
.sum-row:last-child{border-bottom:none;}
.sum-label{color:var(--g500);}
.sum-val{font-weight:700;}

/* instructions */
.inst-list{list-style:none;counter-reset:inst;}
.inst-list li{
  counter-increment:inst;display:flex;gap:.9rem;align-items:flex-start;
  padding:.8rem 0;border-bottom:1px solid var(--g200);font-size:.93rem;line-height:1.6;
}
.inst-list li:last-child{border-bottom:none;}
.inst-list li::before{
  content:counter(inst);flex-shrink:0;
  width:28px;height:28px;background:var(--black);color:var(--white);
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:.8rem;
}

/* IFRA table */
.ifra-row{
  display:grid;grid-template-columns:1fr 120px 120px 80px;
  gap:.5rem;align-items:center;
  padding:.7rem .8rem;border-radius:6px;font-size:.88rem;margin-bottom:.4rem;
}
.ifra-row.head{background:var(--g200);font-weight:700;font-size:.8rem;text-transform:uppercase;letter-spacing:.06em;}
.ifra-row.ok-row{background:rgba(21,128,61,.07);}
.ifra-row.warn-row{background:rgba(185,28,28,.07);}
.ifra-ok-lbl{color:var(--green);font-weight:700;}
.ifra-warn-lbl{color:var(--danger);font-weight:700;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:700px){
  #landing h1{font-size:2.2rem;}
  .step-h{font-size:1.6rem;}
  .cards{grid-template-columns:1fr 1fr;}
  .nav-btns{flex-direction:column;}
  .actions{flex-direction:column;}
  .ing-row{grid-template-columns:1fr auto auto;}
  .ing-pct{display:none;}
  .ifra-row{grid-template-columns:1fr 80px 80px 60px;}
  .cost-grid{grid-template-columns:1fr 1fr;}
}
@media(max-width:480px){
  .cards{grid-template-columns:1fr;}
  .ifra-row{grid-template-columns:1fr 80px 60px;}
  .ifra-row .ifra-limit{display:none;}
}
@media print{
  #hdr,#app,.actions{display:none!important;}
  #formula-page{margin-top:0;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LANDING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="landing">
  <div class="dot" id="dot"></div>
  <h1>Parfum Studio</h1>
  <p class="land-sub">AI-Powered Fragrance Generator</p>
  <button class="btn" onclick="startApp()">Inizia la Creazione â†’</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="hdr">
  <div class="hdr-inner">
    <div class="logo" onclick="location.reload()">
      <div class="logo-dot"></div>Parfum Studio
    </div>
    <div class="hdr-btns">
      <button class="btn btn-outline btn-sm" onclick="location.reload()">â†º Reset</button>
      <button class="btn btn-sm" onclick="openPassModal()">ğŸ” Area Formule</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP (WIZARD) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- Progress -->
  <div class="prog-wrap">
    <div class="prog-steps" id="progSteps">
      <div class="prog-line" id="progLine"></div>
      <div class="ps active" data-s="1"><div class="ps-num">1</div><div class="ps-lbl">Famiglia</div></div>
      <div class="ps"        data-s="2"><div class="ps-num">2</div><div class="ps-lbl">IntensitÃ </div></div>
      <div class="ps"        data-s="3"><div class="ps-num">3</div><div class="ps-lbl">Occasione</div></div>
      <div class="ps"        data-s="4"><div class="ps-num">4</div><div class="ps-lbl">Stile</div></div>
      <div class="ps"        data-s="5"><div class="ps-num">5</div><div class="ps-lbl">Dettagli</div></div>
    </div>
  </div>

  <!-- STEP 1 â€” FAMIGLIA -->
  <div class="step on" data-step="1">
    <h2 class="step-h">Famiglia Olfattiva</h2>
    <p class="step-sub">Scegli il carattere principale del profumo</p>
    <div class="cards" id="famCards">
      <div class="opt-card" data-v="fresco-agrumato"   onclick="pick(this,'family')"><span class="oc-icon">ğŸ‹</span><div class="oc-title">Fresco & Agrumato</div><p class="oc-desc">Limone, bergamotto, mandarino. Solare e luminoso.</p></div>
      <div class="opt-card" data-v="floreale"          onclick="pick(this,'family')"><span class="oc-icon">ğŸŒ¸</span><div class="oc-title">Floreale & Romantico</div><p class="oc-desc">Rosa, gelsomino, mughetto. Elegante e femminile.</p></div>
      <div class="opt-card" data-v="aromatico-fougere" onclick="pick(this,'family')"><span class="oc-icon">ğŸŒ¿</span><div class="oc-title">Aromatico & FougÃ¨re</div><p class="oc-desc">Lavanda, erbe, felce. Classico unisex.</p></div>
      <div class="opt-card" data-v="legnoso-ambrato"   onclick="pick(this,'family')"><span class="oc-icon">ğŸŒ³</span><div class="oc-title">Legnoso & Ambrato</div><p class="oc-desc">Cedro, vetiver, ambra. Caldo e avvolgente.</p></div>
      <div class="opt-card" data-v="orientale-speziato"onclick="pick(this,'family')"><span class="oc-icon">ğŸ”¥</span><div class="oc-title">Orientale & Speziato</div><p class="oc-desc">Spezie, resine, vaniglia. Sensuale e misterioso.</p></div>
      <div class="opt-card" data-v="marino-fresco"     onclick="pick(this,'family')"><span class="oc-icon">ğŸŒŠ</span><div class="oc-title">Marino & Acquatico</div><p class="oc-desc">Ozono, note acquatiche. Pulito e moderno.</p></div>
      <div class="opt-card" data-v="chypre-verde"      onclick="pick(this,'family')"><span class="oc-icon">ğŸƒ</span><div class="oc-title">Chypre & Verde</div><p class="oc-desc">Patchouly, muschio di quercia, foglie. Sofisticato.</p></div>
      <div class="opt-card" data-v="gourmand-dolce"    onclick="pick(this,'family')"><span class="oc-icon">ğŸ°</span><div class="oc-title">Gourmand & Dolce</div><p class="oc-desc">Vaniglia, cumarina, note zuccherine. Avvolgente.</p></div>
    </div>
    <div class="nav-btns">
      <button class="btn btn-outline" disabled>â† Indietro</button>
      <button class="btn" onclick="goNext()">Continua â†’</button>
    </div>
  </div>

  <!-- STEP 2 â€” INTENSITÃ€ -->
  <div class="step" data-step="2">
    <h2 class="step-h">IntensitÃ </h2>
    <p class="step-sub">Scegli la concentrazione di essenze</p>
    <div class="cards">
      <div class="opt-card" data-v="edc" onclick="pick(this,'intensity')"><span class="oc-icon">â˜ï¸</span><div class="oc-title">Eau de Cologne</div><p class="oc-desc">~5% essenze<br>Durata 2â€“3 ore<br>Leggera, estiva.</p></div>
      <div class="opt-card" data-v="edt" onclick="pick(this,'intensity')"><span class="oc-icon">ğŸ’¨</span><div class="oc-title">Eau de Toilette</div><p class="oc-desc">~10% essenze<br>Durata 4â€“6 ore<br>Quotidiana.</p></div>
      <div class="opt-card" data-v="edp" onclick="pick(this,'intensity')"><span class="oc-icon">âš¡</span><div class="oc-title">Eau de Parfum</div><p class="oc-desc">~17% essenze<br>Durata 6â€“8 ore<br>Intensa.</p></div>
    </div>
    <div class="nav-btns">
      <button class="btn btn-outline" onclick="goBack()">â† Indietro</button>
      <button class="btn" onclick="goNext()">Continua â†’</button>
    </div>
  </div>

  <!-- STEP 3 â€” OCCASIONE -->
  <div class="step" data-step="3">
    <h2 class="step-h">Occasione d'Uso</h2>
    <p class="step-sub">Scegli una o piÃ¹ occasioni (opzionale)</p>
    <div class="tags">
      <div class="tag" data-v="quotidiano"  onclick="toggleTag(this)">Uso quotidiano</div>
      <div class="tag" data-v="sera"        onclick="toggleTag(this)">Serata elegante</div>
      <div class="tag" data-v="lavoro"      onclick="toggleTag(this)">Lavoro / Ufficio</div>
      <div class="tag" data-v="sport"       onclick="toggleTag(this)">Sport</div>
      <div class="tag" data-v="romantico"   onclick="toggleTag(this)">Appuntamento romantico</div>
      <div class="tag" data-v="inverno"     onclick="toggleTag(this)">Inverno</div>
      <div class="tag" data-v="estate"      onclick="toggleTag(this)">Estate</div>
      <div class="tag" data-v="primavera"   onclick="toggleTag(this)">Primavera / Autunno</div>
    </div>
    <div class="nav-btns">
      <button class="btn btn-outline" onclick="goBack()">â† Indietro</button>
      <button class="btn" onclick="goNext()">Continua â†’</button>
    </div>
  </div>

  <!-- STEP 4 â€” STILE -->
  <div class="step" data-step="4">
    <h2 class="step-h">Personalizza lo Stile</h2>
    <p class="step-sub">Regola le caratteristiche sensoriali</p>
    <div class="slider-wrap">
      <div class="slider-row"><span>ğŸ¯ Dolcezza</span><span class="s-val" id="vSweet">50%</span></div>
      <input type="range" id="sSweet" min="0" max="100" value="50" oninput="updSlider('sSweet','vSweet','sweet')">
    </div>
    <div class="slider-wrap">
      <div class="slider-row"><span>ğŸ’§ Freschezza</span><span class="s-val" id="vFresh">50%</span></div>
      <input type="range" id="sFresh" min="0" max="100" value="50" oninput="updSlider('sFresh','vFresh','fresh')">
    </div>
    <div class="slider-wrap">
      <div class="slider-row"><span>ğŸŒ‘ ProfonditÃ  / Note scure</span><span class="s-val" id="vDepth">50%</span></div>
      <input type="range" id="sDepth" min="0" max="100" value="50" oninput="updSlider('sDepth','vDepth','depth')">
    </div>
    <div class="nav-btns">
      <button class="btn btn-outline" onclick="goBack()">â† Indietro</button>
      <button class="btn" onclick="goNext()">Continua â†’</button>
    </div>
  </div>

  <!-- STEP 5 â€” DETTAGLI -->
  <div class="step" data-step="5">
    <h2 class="step-h">Ultimi Dettagli</h2>
    <p class="step-sub">Nome e volume del tuo profumo</p>
    <div style="max-width:480px;margin:0 auto;">
      <div class="field">
        <label>Nome del Profumo</label>
        <input type="text" class="inp" id="perfName" placeholder="Es. Notte di Cedro">
      </div>
      <div class="field">
        <label>Volume Finale (ml)</label>
        <input type="number" class="inp" id="perfVol" value="50" min="10" max="1000">
      </div>
    </div>
    <div class="nav-btns">
      <button class="btn btn-outline" onclick="goBack()">â† Indietro</button>
      <button class="btn" onclick="generate()">ğŸ”® Genera Formula</button>
    </div>
  </div>

  <!-- ANTEPRIMA PUBBLICA -->
  <div id="preview" class="hidden">
    <div class="block">
      <div class="block-title" id="prevTitle">Ingredienti Selezionati</div>

      <!-- Piramide -->
      <div style="margin-bottom:1.5rem;">
        <div class="pyr-section">
          <div class="pyr-head"><span>Note di Testa</span><span id="pTlbl">0%</span></div>
          <div class="pyr-track"><div class="pyr-fill pyr-t" id="pTbar" style="width:0%"></div></div>
        </div>
        <div class="pyr-section">
          <div class="pyr-head"><span>Note di Cuore</span><span id="pClbl">0%</span></div>
          <div class="pyr-track"><div class="pyr-fill pyr-c" id="pCbar" style="width:0%"></div></div>
        </div>
        <div class="pyr-section">
          <div class="pyr-head"><span>Note di Fondo</span><span id="pFlbl">0%</span></div>
          <div class="pyr-track"><div class="pyr-fill pyr-f" id="pFbar" style="width:0%"></div></div>
        </div>
      </div>

      <!-- Lista ingredienti pubblica -->
      <div id="prevList"></div>

      <div class="info-box">
        <strong>ğŸ“Œ Vista pubblica</strong> â€” Mostra ingredienti, gocce e peso in grammi.<br>
        Costi, istruzioni di preparazione e conformitÃ  IFRA sono disponibili nell'<strong>Area Formule</strong> (richiede password).
      </div>
      <div class="actions">
        <button class="btn btn-outline" onclick="location.reload()">â†º Ricomincia</button>
        <button class="btn" onclick="openPassModal()">ğŸ” Accedi all'Area Formule</button>
      </div>
    </div>
  </div>

</div><!-- /app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL PASSWORD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="pass-overlay">
  <div class="pass-box">
    <h3>ğŸ” Area Formule Riservata</h3>
    <p>Inserisci la password per accedere a costi, istruzioni di preparazione e conformitÃ  IFRA.</p>
    <div class="field">
      <label>Password</label>
      <input type="password" class="inp" id="passInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
             onkeydown="if(event.key==='Enter') checkPass()">
    </div>
    <div class="pass-err" id="passErr"></div>
    <div class="actions" style="margin-top:1rem;">
      <button class="btn btn-outline btn-sm" onclick="closePassModal()">Annulla</button>
      <button class="btn btn-sm" onclick="checkPass()">Entra â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FORMULA PAGE (PROTETTA) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="formula-page">

  <!-- Hero -->
  <div class="fp-hero">
    <div class="fp-name" id="fpName">â€”</div>
    <div class="fp-desc" id="fpDesc">â€”</div>
  </div>

  <!-- Riepilogo tecnico -->
  <div class="fp-block">
    <div class="fp-h">ğŸ“‹ Riepilogo Formula</div>
    <div class="sum-row"><span class="sum-label">Tipo concentrazione</span><span class="sum-val" id="fpType">â€”</span></div>
    <div class="sum-row"><span class="sum-label">Volume finale</span><span class="sum-val" id="fpVol">â€”</span></div>
    <div class="sum-row"><span class="sum-label">Concentrato (essenze)</span><span class="sum-val" id="fpConcMl">â€”</span></div>
    <div class="sum-row"><span class="sum-label">Alcol diluente 96Â°</span><span class="sum-val" id="fpAlcMl">â€”</span></div>
    <div class="sum-row"><span class="sum-label">Totale gocce concentrato</span><span class="sum-val" id="fpTotDrops">â€”</span></div>
    <div class="sum-row"><span class="sum-label">Peso concentrato</span><span class="sum-val" id="fpTotGrams">â€”</span></div>
    <div class="sum-row"><span class="sum-label">Numero ingredienti</span><span class="sum-val" id="fpNIng">â€”</span></div>
  </div>

  <!-- Costi -->
  <div class="fp-block">
    <div class="fp-h">ğŸ’¶ Costi di Produzione</div>
    <div class="cost-grid">
      <div class="cost-cell"><div class="cc-label">Costo Totale</div><div class="cc-val big" id="fpCostTot">â‚¬â€”</div></div>
      <div class="cost-cell"><div class="cc-label">Concentrato</div><div class="cc-val" id="fpCostConc">â‚¬â€”</div></div>
      <div class="cost-cell"><div class="cc-label">Alcol diluente</div><div class="cc-val" id="fpCostAlc">â‚¬â€”</div></div>
      <div class="cost-cell"><div class="cc-label">Costo per ml</div><div class="cc-val" id="fpCostPerMl">â‚¬â€”</div></div>
    </div>
  </div>

  <!-- Ingredienti tecnici (gocce + grammi) -->
  <div class="fp-block">
    <div class="fp-h">âš—ï¸ Ingredienti â€” Dosaggi Tecnici</div>
    <div style="display:grid;grid-template-columns:1fr 90px 90px 90px;gap:.5rem;padding:.5rem .8rem;font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--g500);">
      <span>Ingrediente</span><span style="text-align:right">% formula</span><span style="text-align:right">Gocce</span><span style="text-align:right">Grammi</span>
    </div>
    <div id="fpIngList"></div>
    <div class="info-box warn" style="margin-top:1rem;">
      <strong>â„¹ï¸ DensitÃ  media:</strong> 1 goccia â‰ˆ 0.05 ml â‰ˆ 0.048â€“0.052 g (densitÃ  ~0.95â€“1.05 g/ml). Il valore in grammi Ã¨ calcolato con densitÃ  media 1 g/ml. Per oli molto densi (patchouly, mirra) il peso reale Ã¨ leggermente superiore.
    </div>
  </div>

  <!-- IFRA Check -->
  <div class="fp-block">
    <div class="fp-h">ğŸ›¡ï¸ ConformitÃ  IFRA â€” Categoria 4 (Fine Fragrance leave-on)</div>
    <p style="font-size:.9rem;color:var(--g500);margin-bottom:1rem;line-height:1.6;">
      La tabella mostra la concentrazione stimata di ogni ingrediente IFRA-limitato nel <em>prodotto finito</em>, comparata con il limite massimo indicativo per fragranze fine (leave-on, applicazione diretta cute). Limiti basati su IFRA 50th Amendment. <strong>Verifica sempre il certificato IFRA ufficiale del fornitore prima dell'uso.</strong>
    </p>
    <div id="ifraGlobalMsg" style="margin-bottom:1rem;"></div>
    <div class="ifra-row head">
      <span>Ingrediente</span>
      <span>Conc. prodotto</span>
      <span class="ifra-limit">Limite IFRA</span>
      <span>Stato</span>
    </div>
    <div id="ifraRows"></div>
    <div id="ifraNoLimited" class="info-box ok hidden">âœ… Nessun ingrediente IFRA-limitato presente in questa formula.</div>
  </div>

  <!-- Istruzioni di preparazione -->
  <div class="fp-block">
    <div class="fp-h">ğŸ“– Istruzioni di Preparazione</div>
    <ol class="inst-list">
      <li>Prepara un'area di lavoro pulita, asciutta e ben illuminata. Raccogli bilancia di precisione (0.01 g), boccette in vetro scuro, pipette Pasteur separate per ogni ingrediente, becher da 100 ml, bastoncino di vetro.</li>
      <li>Versa nella boccetta <strong id="iAlc">â€”</strong> ml di alcol etilico 96Â° per profumeria.</li>
      <li>Aggiungi per prime le <strong>note di fondo</strong> (le piÃ¹ pesanti e persistenti): seguendo l'ordine della tabella, conta le gocce con la pipetta dedicata.</li>
      <li>Aggiungi le <strong>note di cuore</strong> (il corpo del profumo).</li>
      <li>Aggiungi infine le <strong>note di testa</strong> (le piÃ¹ volatili).</li>
      <li>Mescola delicatamente con il bastoncino di vetro per 30â€“40 secondi con movimenti circolari lenti.</li>
      <li>Chiudi ermeticamente. Etichetta con: nome, data, tipo (<span id="iType">â€”</span>), volume (<span id="iVol">â€”</span> ml), lotto.</li>
      <li><strong>Maturazione:</strong> riposa al buio a temperatura costante 18â€“22 Â°C. Minimo 2 settimane, ottimale 6 settimane. Agita delicatamente 1 volta a settimana.</li>
      <li>Non aprire nei primi 7 giorni. Testa dopo 2 settimane su mouillette, poi su cute.</li>
    </ol>
  </div>

  <div class="actions">
    <button class="btn btn-outline" onclick="closeFormulaPage()">â† Chiudi</button>
    <button class="btn btn-outline" onclick="window.print()">ğŸ–¨ï¸ Stampa</button>
    <button class="btn" onclick="saveFormula()">ğŸ’¾ Salva Formula</button>
  </div>
</div><!-- /formula-page -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATABASE INGREDIENTI
   ifraLimited: true = soggetto a limiti IFRA
   ifraMaxPct: % max nel PRODOTTO FINITO (categoria 4 â€” fine fragrance leave-on)
   Fonte: IFRA 50th Amendment (2023)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB=[
  // â”€â”€ TESTA â”€â”€
  {n:"BERGAMOTTO",          note:"testa",fam:"agrumato", price:18,w:12,
   compat:["fresco-agrumato","floreale","aromatico-fougere","marino-fresco","chypre-verde"],
   ifra:true,  ifraMax:0.4,  ifraNote:"Furocumarine-free â‰¤0.4% (fotosensibilizzante se FCF)"},
  {n:"LIMONE ITALIA",       note:"testa",fam:"agrumato", price:12,w:12,
   compat:["fresco-agrumato","marino-fresco","aromatico-fougere"],
   ifra:true,  ifraMax:2.0,  ifraNote:"Limonene â€” soglia 2% prodotto finito"},
  {n:"MANDARINO GIALLO",    note:"testa",fam:"agrumato", price:15,w:10,
   compat:["fresco-agrumato","gourmand-dolce","floreale"],
   ifra:false},
  {n:"AGRUMEX",             note:"testa",fam:"agrumato", price:10,w:10,
   compat:["fresco-agrumato","marino-fresco","aromatico-fougere"],
   ifra:false},
  {n:"VERTOCITRAL C",       note:"testa",fam:"agrumato", price:13,w:8,
   compat:["fresco-agrumato","marino-fresco"],
   ifra:false},
  {n:"ACETATO LINALILE",    note:"testa",fam:"floreale",  price:11,w:12,
   compat:["floreale","fresco-agrumato","aromatico-fougere"],
   ifra:true,  ifraMax:5.0,  ifraNote:"Linalyl acetate â€” nessun limite IFRA ma limite UE cosmetici 5%"},
  {n:"LINALOLO",            note:"testa",fam:"floreale",  price:10,w:12,
   compat:["floreale","fresco-agrumato","aromatico-fougere","chypre-verde"],
   ifra:true,  ifraMax:5.0,  ifraNote:"Linalool â€” limite UE cosmetici 5% (allergene da dichiarare)"},
  {n:"ETIL LINALOLO",       note:"testa",fam:"floreale",  price:8,w:10,
   compat:["floreale","aromatico-fougere"],
   ifra:false},
  {n:"ISORALDEINA",         note:"testa",fam:"fresco",    price:11,w:8,
   compat:["marino-fresco","fresco-agrumato","chypre-verde"],
   ifra:false},
  {n:"DIIDROMIRCENOLO",     note:"testa",fam:"fresco",    price:9,w:10,
   compat:["fresco-agrumato","marino-fresco","aromatico-fougere"],
   ifra:false},
  {n:"CARDAMOMO",           note:"testa",fam:"speziato",  price:20,w:6,
   compat:["orientale-speziato","aromatico-fougere","legnoso-ambrato"],
   ifra:false},
  {n:"PEPE NERO",           note:"testa",fam:"speziato",  price:16,w:4,
   compat:["orientale-speziato","legnoso-ambrato","chypre-verde"],
   ifra:false},
  {n:"MANZANATE",           note:"testa",fam:"fruttato",  price:16,w:3,
   compat:["fresco-agrumato","gourmand-dolce","floreale"],
   ifra:true,  ifraMax:0.05, ifraNote:"Allyl amyl glycolate â€” max 0.05% prodotto finito (molto potente)"},
  {n:"ALLIL AMIL GLICOLATE",note:"testa",fam:"fruttato",  price:14,w:3,
   compat:["fresco-agrumato","gourmand-dolce"],
   ifra:true,  ifraMax:0.05, ifraNote:"Max 0.05% prodotto finito (IFRA restricts)"},
  {n:"ACETATO EXILE",       note:"testa",fam:"fruttato",  price:7,w:8,
   compat:["fresco-agrumato","floreale","gourmand-dolce"],
   ifra:false},

  // â”€â”€ CUORE â”€â”€
  {n:"HEDIONE",             note:"cuore",fam:"floreale",  price:25,w:15,
   compat:["floreale","fresco-agrumato","aromatico-fougere","marino-fresco","chypre-verde"],
   ifra:false},
  {n:"DAMASCENONE",         note:"cuore",fam:"floreale",  price:55,w:1,
   compat:["floreale","orientale-speziato","gourmand-dolce","chypre-verde"],
   ifra:true,  ifraMax:0.02, ifraNote:"Beta-Damascenone â€” max 0.02% (potentissimo, usare 1â€“2 gocce/50ml)"},
  {n:"ALFA DAMASCONE",      note:"cuore",fam:"floreale",  price:45,w:2,
   compat:["floreale","orientale-speziato","chypre-verde"],
   ifra:true,  ifraMax:0.02, ifraNote:"Alfa-Damascone â€” max 0.02% prodotto finito"},
  {n:"GERANIOLO",           note:"cuore",fam:"floreale",  price:12,w:10,
   compat:["floreale","chypre-verde","aromatico-fougere"],
   ifra:true,  ifraMax:6.0,  ifraNote:"Geraniol â€” limite UE cosmetici 6% (allergene)"},
  {n:"ACETATO BENZILE",     note:"cuore",fam:"floreale",  price:8,w:10,
   compat:["floreale","aromatico-fougere"],
   ifra:false},
  {n:"IDROSSICITRONELLALE", note:"cuore",fam:"floreale",  price:9,w:12,
   compat:["floreale","fresco-agrumato","chypre-verde"],
   ifra:true,  ifraMax:1.0,  ifraNote:"Hydroxycitronellal â€” max 1.0% leave-on (sensibilizzante)"},
  {n:"SALICILATO BENZILE",  note:"cuore",fam:"floreale",  price:7,w:12,
   compat:["floreale","chypre-verde","aromatico-fougere"],
   ifra:true,  ifraMax:10.0, ifraNote:"Benzyl salicylate â€” limite UE cosmetici 10%"},
  {n:"ACETATO GERANILE",    note:"cuore",fam:"floreale",  price:9,w:10,
   compat:["floreale","chypre-verde"],
   ifra:false},
  {n:"ALDEIDE ALFA EXILCINNAMICA",note:"cuore",fam:"floreale",price:15,w:5,
   compat:["floreale","orientale-speziato"],
   ifra:true,  ifraMax:0.5,  ifraNote:"Î±-Hexylcinnamaldehyde â€” max 0.5% leave-on"},
  {n:"ANTRANILATO METILE",  note:"cuore",fam:"floreale",  price:8,w:8,
   compat:["floreale","gourmand-dolce"],
   ifra:false},
  {n:"LAVANDINO GROSSO",    note:"cuore",fam:"aromatico", price:12,w:12,
   compat:["aromatico-fougere","fresco-agrumato","legnoso-ambrato","chypre-verde"],
   ifra:false},
  {n:"SALVIA SCLAREA",      note:"cuore",fam:"aromatico", price:14,w:10,
   compat:["aromatico-fougere","legnoso-ambrato","orientale-speziato"],
   ifra:false},
  {n:"HELIONAL",            note:"cuore",fam:"marino",    price:22,w:10,
   compat:["marino-fresco","fresco-agrumato"],
   ifra:false},
  {n:"ALDEIDE C14",         note:"cuore",fam:"fresco",    price:12,w:6,
   compat:["marino-fresco","fresco-agrumato","chypre-verde"],
   ifra:false},
  {n:"OCTINE CARBONATO METILE",note:"cuore",fam:"verde",  price:12,w:8,
   compat:["chypre-verde","floreale","aromatico-fougere"],
   ifra:false},
  {n:"CANNELLA CINA",       note:"cuore",fam:"speziato",  price:25,w:2,
   compat:["orientale-speziato","gourmand-dolce"],
   ifra:true,  ifraMax:0.1,  ifraNote:"Cinnamal/cinammic aldehyde â€” max 0.1% leave-on (forte allergene)"},
  {n:"NOCE MOSCATA",        note:"cuore",fam:"speziato",  price:14,w:5,
   compat:["orientale-speziato","legnoso-ambrato","gourmand-dolce"],
   ifra:true,  ifraMax:1.0,  ifraNote:"Nutmeg oil â€” max 1% leave-on (safrol ridotto)"},
  {n:"EUGENOLO PURO",       note:"cuore",fam:"speziato",  price:10,w:4,
   compat:["orientale-speziato","chypre-verde"],
   ifra:true,  ifraMax:0.5,  ifraNote:"Eugenol â€” max 0.5% leave-on (forte allergene IFRA)"},

  // â”€â”€ FONDO â”€â”€
  {n:"ISO E SUPER",         note:"fondo",fam:"legnoso",   price:18,w:15,
   compat:["legnoso-ambrato","orientale-speziato","marino-fresco","aromatico-fougere","chypre-verde","floreale"],
   ifra:false},
  {n:"CEDRO VIRGINIA",      note:"fondo",fam:"legnoso",   price:16,w:10,
   compat:["legnoso-ambrato","orientale-speziato","aromatico-fougere","chypre-verde"],
   ifra:false},
  {n:"PATCHOULY",           note:"fondo",fam:"legnoso",   price:20,w:8,
   compat:["legnoso-ambrato","orientale-speziato","chypre-verde","gourmand-dolce"],
   ifra:false},
  {n:"VETIVER GIAVA",       note:"fondo",fam:"legnoso",   price:22,w:10,
   compat:["legnoso-ambrato","fresco-agrumato","chypre-verde","aromatico-fougere"],
   ifra:false},
  {n:"SANDALORE",           note:"fondo",fam:"legnoso",   price:24,w:10,
   compat:["legnoso-ambrato","floreale","orientale-speziato","gourmand-dolce"],
   ifra:false},
  {n:"VERTOFIX COEUR",      note:"fondo",fam:"legnoso",   price:20,w:10,
   compat:["legnoso-ambrato","chypre-verde","aromatico-fougere"],
   ifra:false},
  {n:"MOUSSE DE METRE",     note:"fondo",fam:"legnoso",   price:28,w:5,
   compat:["chypre-verde","aromatico-fougere","legnoso-ambrato"],
   ifra:true,  ifraMax:0.03, ifraNote:"Oakmoss absolute â€” max 0.03% leave-on (IFRA strictly restricted)"},
  {n:"AMBROX SUPER",        note:"fondo",fam:"ambrato",   price:35,w:6,
   compat:["legnoso-ambrato","orientale-speziato","floreale","gourmand-dolce"],
   ifra:false},
  {n:"ALDEIDE C18",         note:"fondo",fam:"orientale", price:10,w:4,
   compat:["orientale-speziato","gourmand-dolce","legnoso-ambrato"],
   ifra:false},
  {n:"CUMARINA",            note:"fondo",fam:"dolce",     price:10,w:8,
   compat:["gourmand-dolce","orientale-speziato","aromatico-fougere"],
   ifra:true,  ifraMax:1.0,  ifraNote:"Coumarin â€” max 1.0% leave-on (IFRA 50th)"},
  {n:"VANILLA",             note:"fondo",fam:"dolce",     price:12,w:5,
   compat:["gourmand-dolce","orientale-speziato","floreale"],
   ifra:false},
  {n:"GALAXOLIDE",          note:"fondo",fam:"muschiato", price:16,w:10,
   compat:["floreale","legnoso-ambrato","marino-fresco","aromatico-fougere","chypre-verde"],
   ifra:false},
  {n:"HABANOLIDE",          note:"fondo",fam:"muschiato", price:25,w:6,
   compat:["floreale","legnoso-ambrato","gourmand-dolce"],
   ifra:false},
  {n:"ETILENE BRASSILATE",  note:"fondo",fam:"muschiato", price:18,w:8,
   compat:["floreale","marino-fresco","chypre-verde","aromatico-fougere"],
   ifra:false},
  {n:"INCENSO PURO",        note:"fondo",fam:"resinoso",  price:30,w:5,
   compat:["orientale-speziato","legnoso-ambrato","chypre-verde"],
   ifra:false},
  {n:"MIRRA",               note:"fondo",fam:"resinoso",  price:22,w:6,
   compat:["orientale-speziato","legnoso-ambrato"],
   ifra:false},
  {n:"BENZOATO BENZILE",    note:"fondo",fam:"balsamico", price:7,w:8,
   compat:["floreale","orientale-speziato","gourmand-dolce"],
   ifra:true,  ifraMax:8.0,  ifraNote:"Benzyl benzoate â€” limite UE cosmetici 8% leave-on"},
];

/* â•â• Costanti â•â• */
const CONC_PCT = {edc:5, edt:10, edp:17};
const ALC_COST = 0.015; // â‚¬/ml
const DROP_ML  = 0.05;  // 1 goccia â‰ˆ 0.05 ml
const DENSITY  = 1.0;   // g/ml media (approssimazione)
const PYR = {testa:25, cuore:40, fondo:35};

const DESCS = {
  "fresco-agrumato":    "Profilo agrumato brillante â€” note di apertura vivaci su base leggera e raffinata.",
  "floreale":           "Bouquet floreale elegante â€” cuore ricco di fiori sostenuto da base muschiata.",
  "aromatico-fougere":  "Struttura fougÃ¨re classica â€” lavanda, erbe aromatiche, base legnosa pulita.",
  "legnoso-ambrato":    "Legni nobili e ambra calda â€” scia profonda e persistente da sera.",
  "orientale-speziato": "Spezie esotiche e resine â€” composizione misteriosamente avvolgente.",
  "marino-fresco":      "Brezze ozoniche e note acquatiche â€” freschezza moderna e urbana.",
  "chypre-verde":       "Accordo chypre sofisticato â€” patchouly, muschio di quercia, foglie verdi.",
  "gourmand-dolce":     "Note golose e avvolgenti â€” vaniglia, cumarina, gourmand morbido.",
};

/* â•â• State â•â• */
let curStep = 1;
const sel = {family:null, intensity:null, occasions:[], sweet:50, fresh:50, depth:50};
let curFormula = null;

/* â•â• Landing â†’ App â•â• */
function startApp(){
  const d = document.getElementById('dot');
  d.classList.add('boom');
  setTimeout(()=>{ document.getElementById('landing').classList.add('fade'); }, 350);
  setTimeout(()=>{
    document.getElementById('landing').style.display='none';
    document.getElementById('hdr').style.display='block';
    document.getElementById('app').classList.add('show');
    updateProgress();
  }, 900);
}

/* â•â• Picks / Tags / Sliders â•â• */
function pick(el, key){
  el.closest('.cards').querySelectorAll('.opt-card').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel');
  sel[key] = el.dataset.v;
}
function toggleTag(el){
  el.classList.toggle('sel');
  const v = el.dataset.v, i = sel.occasions.indexOf(v);
  if(i>-1) sel.occasions.splice(i,1); else sel.occasions.push(v);
}
function updSlider(id, valId, key){
  const v = +document.getElementById(id).value;
  document.getElementById(valId).textContent = v+'%';
  sel[key] = v;
}

/* â•â• Step navigation â•â• */
function goNext(){
  if(curStep===1 && !sel.family){alert('âš ï¸ Seleziona una famiglia olfattiva.'); return;}
  if(curStep===2 && !sel.intensity){alert('âš ï¸ Seleziona il tipo di concentrazione.'); return;}
  setStep(curStep+1);
}
function goBack(){ setStep(curStep-1); }
function setStep(n){
  document.querySelector(`.step[data-step="${curStep}"]`).classList.remove('on');
  const prevPs = document.querySelector(`.ps[data-s="${curStep}"]`);
  if(n>curStep) prevPs.classList.replace('active','done');
  else { prevPs.classList.remove('done','active'); }
  curStep = n;
  document.querySelector(`.step[data-step="${curStep}"]`).classList.add('on');
  document.querySelector(`.ps[data-s="${curStep}"]`).classList.add('active');
  updateProgress();
  window.scrollTo({top:0,behavior:'smooth'});
}
function updateProgress(){
  document.getElementById('progLine').style.width = ((curStep-1)/4*100)+'%';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERA FORMULA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generate(){
  const vol  = parseInt(document.getElementById('perfVol').value)||50;
  const name = document.getElementById('perfName').value.trim()||'Il Mio Profumo';
  const fam  = sel.family;
  const type = sel.intensity;
  const concPct = CONC_PCT[type];

  /* Seleziona ingredienti per famiglia + stile */
  function styleScore(x){
    let s=0;
    if(sel.sweet>60 && ['dolce','fruttato','gourmand'].includes(x.fam)) s+=2;
    if(sel.fresh>60 && ['agrumato','fresco','marino'].includes(x.fam)) s+=2;
    if(sel.depth>60 && ['resinoso','ambrato','legnoso','orientale'].includes(x.fam)) s+=2;
    return s;
  }
  const pool = note => DB.filter(x=>x.note===note && x.compat.includes(fam))
                          .sort((a,b)=>styleScore(b)-styleScore(a));

  const tPool = pool('testa'), cPool = pool('cuore'), fPool = pool('fondo');
  const tPick = tPool.slice(0,3);
  const cPick = cPool.slice(0,4);
  const fPick = fPool.slice(0,3);

  /* Calcola ml necessari */
  const concMl = vol * concPct / 100;
  const alcMl  = vol - concMl;
  const totalDropsTarget = concMl / DROP_ML;

  /* Distribuisci gocce rispettando proporzioni piramide */
  function assignDrops(group, pyrPct){
    const gDrops = totalDropsTarget * pyrPct / 100;
    const sumW   = group.reduce((s,x)=>s+x.w, 0)||1;
    return group.map(x=>({
      ...x,
      drops: Math.max(1, Math.round(x.w/sumW * gDrops))
    }));
  }

  const tF = assignDrops(tPick, PYR.testa);
  const cF = assignDrops(cPick, PYR.cuore);
  const fF = assignDrops(fPick, PYR.fondo);
  const formula = [...tF, ...cF, ...fF];
  const totalDrops = formula.reduce((s,x)=>s+x.drops,0);

  /* Piramide reale */
  const pyr = {
    testa: (tF.reduce((s,x)=>s+x.drops,0)/totalDrops*100).toFixed(1),
    cuore: (cF.reduce((s,x)=>s+x.drops,0)/totalDrops*100).toFixed(1),
    fondo: (fF.reduce((s,x)=>s+x.drops,0)/totalDrops*100).toFixed(1),
  };

  /* Costi */
  const concCost = formula.reduce((s,x)=> s + (x.price/10)*(x.drops*DROP_ML), 0);
  const alcCost  = alcMl * ALC_COST;
  const totCost  = concCost + alcCost;

  curFormula = {
    name, fam, type, vol, concPct, concMl, alcMl,
    formula, totalDrops, pyr, concCost, alcCost, totCost
  };

  renderPreview(curFormula);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ANTEPRIMA (pubblica)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPreview(f){
  document.getElementById('prevTitle').textContent =
    `${f.name} â€” ${f.formula.length} ingredienti`;

  /* Piramide */
  setTimeout(()=>{
    ['T','C','F'].forEach((k,i)=>{
      const pct = [f.pyr.testa, f.pyr.cuore, f.pyr.fondo][i];
      document.getElementById('p'+k+'lbl').textContent = pct+'%';
      const bar = document.getElementById('p'+k+'bar');
      bar.style.width = pct+'%';
      bar.textContent = pct+'%';
    });
  }, 200);

  /* Lista */
  const list = document.getElementById('prevList');
  list.innerHTML = f.formula.map(x=>{
    const pct   = (x.drops/f.totalDrops*100).toFixed(1);
    const grams = (x.drops*DROP_ML*DENSITY).toFixed(3);
    const bc    = x.note==='testa'?'bt':x.note==='cuore'?'bc':'bf';
    return `
    <div class="ing-row">
      <div class="ing-name-wrap">
        <span class="ing-name">${x.n}</span>
        <span class="badge ${bc}">${x.note}</span>
      </div>
      <span class="ing-pct">${pct}%</span>
      <span class="ing-drops">${x.drops} gocce</span>
      <span class="ing-grams">${grams} g</span>
    </div>`;
  }).join('');

  document.getElementById('preview').classList.remove('hidden');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL PASSWORD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openPassModal(){
  document.getElementById('passInput').value='';
  document.getElementById('passErr').textContent='';
  document.getElementById('pass-overlay').classList.add('show');
  setTimeout(()=>document.getElementById('passInput').focus(),200);
}
function closePassModal(){
  document.getElementById('pass-overlay').classList.remove('show');
}
function checkPass(){
  const pwd = document.getElementById('passInput').value;
  if(pwd!=='FormularioProfumi'){
    document.getElementById('passErr').textContent='âŒ Password errata.';
    document.getElementById('passInput').select();
    return;
  }
  if(!curFormula){
    document.getElementById('passErr').textContent='âš ï¸ Genera prima una formula con il wizard.';
    return;
  }
  closePassModal();
  showFormulaPage();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGINA FORMULA (protetta)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showFormulaPage(){
  const f = curFormula;
  const fp = document.getElementById('formula-page');

  /* Hero */
  document.getElementById('fpName').textContent = f.name;
  document.getElementById('fpDesc').textContent = DESCS[f.fam]||'';

  /* Riepilogo */
  const typeLabel = {edc:'Eau de Cologne (EDC) ~5%', edt:'Eau de Toilette (EDT) ~10%', edp:'Eau de Parfum (EDP) ~17%'};
  document.getElementById('fpType').textContent    = typeLabel[f.type];
  document.getElementById('fpVol').textContent     = f.vol+' ml';
  document.getElementById('fpConcMl').textContent  = f.concMl.toFixed(2)+' ml';
  document.getElementById('fpAlcMl').textContent   = f.alcMl.toFixed(2)+' ml';
  document.getElementById('fpTotDrops').textContent= f.totalDrops+' gocce';
  document.getElementById('fpTotGrams').textContent= (f.totalDrops*DROP_ML*DENSITY).toFixed(2)+' g';
  document.getElementById('fpNIng').textContent    = f.formula.length;

  /* Costi */
  document.getElementById('fpCostTot').textContent   = 'â‚¬'+f.totCost.toFixed(2);
  document.getElementById('fpCostConc').textContent  = 'â‚¬'+f.concCost.toFixed(2);
  document.getElementById('fpCostAlc').textContent   = 'â‚¬'+f.alcCost.toFixed(2);
  document.getElementById('fpCostPerMl').textContent = 'â‚¬'+(f.totCost/f.vol).toFixed(3);

  /* Ingredienti tecnici */
  const il = document.getElementById('fpIngList');
  il.innerHTML = f.formula.map(x=>{
    const pct   = (x.drops/f.totalDrops*100).toFixed(2);
    const grams = (x.drops*DROP_ML*DENSITY).toFixed(3);
    const bc    = x.note==='testa'?'bt':x.note==='cuore'?'bc':'bf';
    return `
    <div class="ing-row">
      <div class="ing-name-wrap">
        <span class="ing-name">${x.n}</span>
        <span class="badge ${bc}">${x.note}</span>
      </div>
      <span class="ing-pct">${pct}%</span>
      <span class="ing-drops">${x.drops} gocce</span>
      <span class="ing-grams">${grams} g</span>
    </div>`;
  }).join('');

  /* â”€â”€ IFRA CHECK â”€â”€ */
  const limited = f.formula.filter(x=>x.ifra);
  const noLimEl = document.getElementById('ifraNoLimited');
  const rowsEl  = document.getElementById('ifraRows');
  const msgEl   = document.getElementById('ifraGlobalMsg');

  if(limited.length===0){
    noLimEl.classList.remove('hidden');
    rowsEl.innerHTML='';
    msgEl.innerHTML='';
  } else {
    noLimEl.classList.add('hidden');
    let hasViolation = false;
    rowsEl.innerHTML = limited.map(x=>{
      /* % nel prodotto finito = ml ingrediente / ml prodotto Ã— 100 */
      const mlIng  = x.drops * DROP_ML;
      const pctFin = (mlIng / f.vol * 100);
      const ok     = pctFin <= x.ifraMax;
      if(!ok) hasViolation=true;
      const cls = ok ? 'ok-row' : 'warn-row';
      const lbl = ok
        ? `<span class="ifra-ok-lbl">âœ… OK</span>`
        : `<span class="ifra-warn-lbl">âš ï¸ Supera</span>`;
      return `
      <div class="ifra-row ${cls}">
        <span><strong>${x.n}</strong><br><small style="color:var(--g500)">${x.ifraNote}</small></span>
        <span>${pctFin.toFixed(3)}%</span>
        <span class="ifra-limit">max ${x.ifraMax}%</span>
        <span>${lbl}</span>
      </div>`;
    }).join('');

    msgEl.innerHTML = hasViolation
      ? `<div class="info-box"><strong>âš ï¸ Attenzione:</strong> uno o piÃ¹ ingredienti IFRA-limitati superano il limite indicativo per il prodotto finito. Riduci le gocce degli ingredienti segnalati con âš ï¸ o riformula.</div>`
      : `<div class="info-box ok"><strong>âœ… Tutti gli ingredienti IFRA-limitati</strong> rientrano nei limiti indicativi per fine fragrance leave-on.</div>`;
  }

  /* Istruzioni */
  document.getElementById('iAlc').textContent  = f.alcMl.toFixed(1);
  document.getElementById('iType').textContent = ({edc:'EDC',edt:'EDT',edp:'EDP'})[f.type];
  document.getElementById('iVol').textContent  = f.vol;

  /* Mostra pagina */
  document.getElementById('app').style.display='none';
  fp.classList.add('show');
  window.scrollTo({top:0,behavior:'smooth'});
}

function closeFormulaPage(){
  document.getElementById('formula-page').classList.remove('show');
  document.getElementById('app').style.display='block';
}

/* â•â• Salvataggio localStorage â•â• */
function saveFormula(){
  if(!curFormula) return;
  const saved = JSON.parse(localStorage.getItem('ps_formulas')||'[]');
  saved.unshift({...curFormula, savedAt:new Date().toISOString()});
  localStorage.setItem('ps_formulas', JSON.stringify(saved));
  alert('âœ… Formula "'+curFormula.name+'" salvata!');
}
</script>
</body>
</html>
