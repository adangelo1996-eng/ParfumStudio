<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#cc0000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Parfum Studio">
<meta name="description" content="Generatore AI di formule profumo con calcolatore IFRA">
<title>Parfum Studio</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & DESIGN TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bk:#000;--wh:#fff;--rd:#cc0000;--rd2:#a80000;
  --g50:#f9f9f9;--g100:#f2f2f2;--g200:#e4e4e4;--g300:#ccc;
  --g500:#777;--g700:#333;
  --blue:#1a5fb4;--amber:#b45309;--purple:#6d28d9;
  --green:#15803d;--danger:#991b1b;
  --fn:'Courier Prime','Courier New',monospace;
  --r:14px;
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
}
html{height:100%;}
body{
  font-family:var(--fn);
  background:var(--wh);
  color:var(--bk);
  line-height:1.55;
  -webkit-font-smoothing:antialiased;
  overscroll-behavior:none;
  min-height:100%;
}
.hidden{display:none!important;}
img,svg{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMAZIONI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(204,0,0,.4)}70%{box-shadow:0 0 0 22px rgba(204,0,0,0)}}
@keyframes boom{0%{transform:scale(1);opacity:1}60%{transform:scale(28);opacity:.3}100%{transform:scale(0);opacity:0}}
@keyframes spin{to{transform:rotate(360deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PALLINO ROSSO â€” LOGO SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dot{
  display:inline-block;
  background:radial-gradient(circle at 36% 34%, #ff4444 0%, #cc0000 55%, #880000 100%);
  border-radius:50%;
  flex-shrink:0;
}
.dot-xs{width:8px;height:8px;}
.dot-sm{width:12px;height:12px;}
.dot-md{width:28px;height:28px;}
.dot-lg{
  width:88px;height:88px;
  animation:pulse 2.2s ease-in-out infinite;
  cursor:pointer;
  box-shadow:0 8px 32px rgba(204,0,0,.35);
}
.dot-lg:active{transform:scale(.93);}
.dot-lg.boom{animation:boom .7s ease-out forwards;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#landing{
  position:fixed;inset:0;
  background:var(--wh);
  z-index:2000;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:2rem;text-align:center;
  transition:opacity .5s ease;
}
.land-logo-wrap{
  display:flex;flex-direction:column;align-items:center;
  margin-bottom:2.5rem;gap:1.2rem;
}
.land-wordmark{
  font-size:2.6rem;font-weight:400;letter-spacing:.04em;line-height:1.1;
}
.land-wordmark span{font-weight:700;}
.land-sub{font-size:.95rem;color:var(--g500);margin-bottom:2.8rem;line-height:1.6;}
.land-btn{
  display:inline-flex;align-items:center;gap:.6rem;
  padding:1.1rem 2.6rem;
  background:var(--bk);color:var(--wh);
  border:none;border-radius:50px;
  font-family:var(--fn);font-size:1rem;font-weight:700;
  cursor:pointer;letter-spacing:.05em;
  box-shadow:0 6px 20px rgba(0,0,0,.15);
  transition:transform .2s,box-shadow .2s;
}
.land-btn:active{transform:scale(.96);box-shadow:none;}
.land-version{position:absolute;bottom:2rem;font-size:.72rem;color:var(--g300);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hdr{
  position:fixed;top:0;left:0;right:0;
  height:calc(60px + var(--safe-top));
  padding-top:var(--safe-top);
  background:rgba(255,255,255,.96);
  backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);
  border-bottom:1px solid var(--g200);
  z-index:900;
  display:none;
}
.hdr-in{
  height:60px;
  max-width:960px;margin:0 auto;
  padding:0 1.2rem;
  display:flex;justify-content:space-between;align-items:center;
}
.logo-btn{
  display:flex;align-items:center;gap:.6rem;
  background:none;border:none;cursor:pointer;
  font-family:var(--fn);font-size:1.05rem;font-weight:700;
  padding:0;color:var(--bk);
}
.logo-btn:active{opacity:.6;}
.hdr-right{display:flex;gap:.5rem;align-items:center;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PULSANTI GENERICI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:.4rem;
  padding:.75rem 1.5rem;
  background:var(--bk);color:var(--wh);
  border:2px solid var(--bk);border-radius:50px;
  font-family:var(--fn);font-size:.88rem;font-weight:700;
  cursor:pointer;letter-spacing:.04em;
  transition:transform .18s,background .18s;
  white-space:nowrap;
}
.btn:active{transform:scale(.95);}
.btn-ghost{background:transparent;color:var(--bk);}
.btn-ghost:active{background:var(--g100);}
.btn-red{background:var(--rd);border-color:var(--rd);}
.btn-green{background:var(--green);border-color:var(--green);}
.btn-sm{padding:.5rem 1.1rem;font-size:.8rem;}
.btn-full{width:100%;justify-content:center;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BANNER INSTALLAZIONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#install-bar{
  display:none;
  background:#000;color:#fff;
  padding:.8rem 1.2rem;
  flex-direction:row;align-items:center;justify-content:space-between;
  gap:.8rem;font-size:.83rem;
  border-bottom:2px solid var(--rd);
}
#install-bar.show{display:flex;}
.ib-left{display:flex;align-items:center;gap:.7rem;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP CONTAINER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{
  display:none;
  max-width:960px;margin:0 auto;
  padding-bottom:calc(90px + var(--safe-bot));
}
#app.on{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prog-zone{
  position:sticky;
  top:calc(60px + var(--safe-top));
  z-index:500;
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(8px);
  border-bottom:1px solid var(--g200);
  padding:.9rem 1.4rem;
}
.prog-track{height:3px;background:var(--g200);border-radius:2px;margin-bottom:.55rem;}
.prog-fill{height:100%;background:var(--rd);border-radius:2px;transition:width .45s ease;width:0%;}
.prog-info{display:flex;justify-content:space-between;font-size:.7rem;font-weight:700;
           text-transform:uppercase;letter-spacing:.08em;color:var(--g500);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP CONTENUTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.step{display:none;padding:1.6rem 1.4rem 1rem;animation:fadeUp .3s ease;}
.step.on{display:block;}
.step-head{margin-bottom:1.6rem;}
.step-ttl{font-size:1.85rem;font-weight:400;line-height:1.2;margin-bottom:.4rem;}
.step-sub{font-size:.9rem;color:var(--g500);line-height:1.5;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OPTION CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.opt-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
  gap:.75rem;margin-bottom:1.8rem;
}
.opt{
  background:var(--g50);border:2px solid var(--g200);
  border-radius:var(--r);padding:1.4rem .9rem;
  text-align:center;cursor:pointer;
  transition:border-color .2s,transform .18s,background .2s;
  position:relative;
}
.opt:active{transform:scale(.97);}
.opt.sel{background:var(--wh);border-color:var(--bk);
  box-shadow:0 4px 16px rgba(0,0,0,.1);}
.opt.sel::after{
  content:'';position:absolute;top:9px;right:9px;
  width:8px;height:8px;background:var(--rd);border-radius:50%;
}
.opt-ico{font-size:2rem;margin-bottom:.7rem;}
.opt-tit{font-size:.88rem;font-weight:700;margin-bottom:.25rem;}
.opt-dsc{font-size:.73rem;color:var(--g500);line-height:1.4;}
.opt.sel .opt-dsc{color:var(--g700);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAG PILLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pill-wrap{display:flex;flex-wrap:wrap;gap:.55rem;margin-bottom:1.8rem;}
.pill{
  padding:.5rem 1rem;
  border:1.5px solid var(--g300);border-radius:40px;
  background:var(--wh);cursor:pointer;
  font-family:var(--fn);font-size:.82rem;font-weight:700;
  transition:all .18s;
}
.pill.sel{background:var(--bk);color:var(--wh);border-color:var(--bk);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SLIDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sl-block{margin-bottom:1.6rem;}
.sl-top{display:flex;justify-content:space-between;
        font-size:.88rem;font-weight:700;margin-bottom:.55rem;}
.sl-val{color:var(--rd);}
input[type=range]{
  width:100%;height:6px;
  background:var(--g200);border-radius:3px;
  -webkit-appearance:none;appearance:none;outline:none;cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:22px;height:22px;
  border-radius:50%;background:var(--rd);
  box-shadow:0 2px 8px rgba(204,0,0,.4);
}
input[type=range]::-moz-range-thumb{
  width:22px;height:22px;border:none;border-radius:50%;background:var(--rd);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAMPI INPUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field{margin-bottom:1.3rem;}
.field-lbl{
  display:block;font-size:.76rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.08em;
  color:var(--g500);margin-bottom:.45rem;
}
.inp{
  width:100%;padding:.9rem 1rem;
  border:2px solid var(--g200);border-radius:var(--r);
  font-family:var(--fn);font-size:1rem;background:var(--wh);
  transition:border-color .2s;
}
.inp:focus{outline:none;border-color:var(--bk);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARD / BOX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{
  background:var(--wh);border:1px solid var(--g200);
  border-radius:var(--r);overflow:hidden;
  margin-bottom:1.2rem;
  box-shadow:0 2px 12px rgba(0,0,0,.05);
}
.card-hdr{
  padding:.9rem 1.2rem;border-bottom:1px solid var(--g100);
  font-size:.85rem;font-weight:700;
  display:flex;justify-content:space-between;align-items:center;
}
.card-body{padding:1rem 1.2rem;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PIRAMIDE BARRE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pyr-row{margin-bottom:.9rem;}
.pyr-lbl{display:flex;justify-content:space-between;
         font-size:.8rem;font-weight:700;margin-bottom:.3rem;}
.pyr-track{height:28px;background:var(--g100);border-radius:6px;overflow:hidden;}
.pyr-fill{height:100%;display:flex;align-items:center;padding-left:.6rem;
          color:var(--wh);font-weight:700;font-size:.75rem;
          transition:width 1s ease;min-width:3rem;}
.pyr-t{background:var(--blue);}
.pyr-c{background:var(--amber);}
.pyr-f{background:var(--purple);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIGHE INGREDIENTI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ing-row{
  display:grid;
  grid-template-columns:1fr auto auto auto;
  align-items:center;gap:.6rem;
  padding:.85rem 0;border-bottom:1px solid var(--g100);
}
.ing-row:last-child{border-bottom:none;}
.ing-name{font-size:.88rem;font-weight:700;margin-bottom:.2rem;}
.ing-meta{display:flex;flex-wrap:wrap;gap:.3rem;align-items:center;}
.badge{
  padding:.15rem .45rem;border-radius:5px;
  font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;
}
.b-t{background:#dbeafe;color:#1d4ed8;}
.b-c{background:#fef3c7;color:#92400e;}
.b-f{background:#ede9fe;color:#5b21b6;}
.b-d{background:#f1f5f9;color:#475569;}
.b-w{background:#fee2e2;color:#991b1b;}
.ing-drops{font-size:.88rem;font-weight:700;color:var(--rd);text-align:right;}
.ing-g{font-size:.78rem;color:var(--g500);text-align:right;}
.ing-pct{font-size:.75rem;color:var(--g500);text-align:right;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOX MESSAGGI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.msg{padding:1rem 1.1rem;border-radius:10px;font-size:.85rem;line-height:1.6;margin:.8rem 0;}
.msg-ok{background:#f0fdf4;border-left:4px solid var(--green);color:#14532d;}
.msg-warn{background:#fffbeb;border-left:4px solid var(--amber);color:#78350f;}
.msg-info{background:#eff6ff;border-left:4px solid var(--blue);color:#1e3a5f;}
.msg-err{background:#fff1f2;border-left:4px solid var(--danger);color:#881337;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIEPILOGO COSTI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cost-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem;margin-top:.6rem;}
.cost-cell{background:var(--g50);border-radius:10px;padding:.9rem;text-align:center;}
.cost-lbl{font-size:.7rem;text-transform:uppercase;letter-spacing:.07em;color:var(--g500);margin-bottom:.25rem;}
.cost-val{font-size:1.4rem;font-weight:700;}
.cost-big{grid-column:1/-1;background:#000;color:#fff;}
.cost-big .cost-val{font-size:2rem;color:var(--rd);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IFRA TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ifra-row{
  display:grid;grid-template-columns:1fr 90px 80px 55px;
  gap:.4rem;align-items:center;
  padding:.7rem .8rem;border-radius:8px;margin-bottom:.4rem;
  font-size:.82rem;
}
.ifra-row.ok{background:rgba(21,128,61,.07);}
.ifra-row.ko{background:rgba(153,27,27,.07);}
.ifra-note{font-size:.7rem;color:var(--g500);margin-top:.2rem;line-height:1.3;}
.ifra-val{text-align:right;}
.ifra-lim{text-align:right;}
.ifra-st{text-align:center;font-weight:700;}
.ifra-st.ok{color:var(--green);}
.ifra-st.ko{color:var(--danger);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ISTRUZIONI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inst-list{list-style:none;counter-reset:inst;}
.inst-list li{
  counter-increment:inst;
  display:flex;gap:.9rem;
  padding:.8rem 0;border-bottom:1px solid var(--g100);
  font-size:.88rem;line-height:1.55;
}
.inst-list li:last-child{border-bottom:none;}
.inst-list li::before{
  content:counter(inst);
  flex-shrink:0;width:26px;height:26px;
  background:var(--bk);color:var(--wh);
  border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-weight:700;font-size:.72rem;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  z-index:1800;display:none;
  align-items:center;justify-content:center;
  padding:1.2rem;
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
}
.overlay.open{display:flex;}
.modal{
  background:var(--wh);border-radius:20px;
  padding:2rem;width:100%;max-width:390px;
  box-shadow:0 24px 60px rgba(0,0,0,.22);
  animation:fadeUp .3s ease;
}
.modal-ttl{font-size:1.25rem;font-weight:700;margin-bottom:.4rem;}
.modal-sub{font-size:.85rem;color:var(--g500);margin-bottom:1.4rem;line-height:1.5;}
.modal-dot{
  width:40px;height:40px;
  background:radial-gradient(circle at 36% 34%,#ff4444,#cc0000 55%,#880000);
  border-radius:50%;margin:0 auto 1.2rem;
}
.modal-btns{display:flex;gap:.7rem;justify-content:flex-end;margin-top:1rem;}
.err-lbl{color:var(--danger);font-size:.82rem;margin-top:.35rem;min-height:1rem;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#bnav{
  position:fixed;
  bottom:0;left:0;right:0;
  padding:.8rem 1.4rem;
  padding-bottom:calc(.8rem + var(--safe-bot));
  background:rgba(255,255,255,.97);
  border-top:1px solid var(--g200);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  z-index:800;
  display:none;
  justify-content:space-between;align-items:center;
  gap:.8rem;
}
#bnav.show{display:flex;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMULA PAGE (step 6)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fp-hero{
  background:var(--bk);color:var(--wh);
  border-radius:var(--r);
  padding:1.6rem 1.4rem;margin-bottom:1.2rem;
}
.fp-name{font-size:1.9rem;font-weight:700;margin-bottom:.3rem;}
.fp-desc{font-size:.88rem;opacity:.6;line-height:1.5;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:540px){
  .opt-grid{grid-template-columns:1fr 1fr;}
  .cost-grid{grid-template-columns:1fr 1fr;}
  .ing-row{grid-template-columns:1fr auto auto;}
  .ing-pct{display:none;}
  .ifra-row{grid-template-columns:1fr 70px 55px;}
  .ifra-lim{display:none;}
}
@media(max-width:360px){
  .opt-grid{grid-template-columns:1fr;}
  .step-ttl{font-size:1.5rem;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LANDING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="landing">
  <div class="land-logo-wrap">
    <div class="dot dot-lg" id="herobot" onclick="startApp()"></div>
    <div class="land-wordmark">Parfum<br><span>Studio</span></div>
  </div>
  <p class="land-sub">Generatore AI di formule profumo<br>con calcolatore IFRA integrato.</p>
  <button class="land-btn" onclick="startApp()">
    Inizia la Creazione â†’
  </button>
  <div class="land-version">v2.1 â€” PWA</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INSTALL BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="install-bar">
  <div class="ib-left">
    <div class="dot dot-sm"></div>
    <span>Installa Parfum Studio come app</span>
  </div>
  <button class="btn btn-red btn-sm" onclick="installApp()">Installa</button>
  <button class="btn btn-ghost btn-sm" onclick="dismissInstall()">âœ•</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="hdr">
  <div class="hdr-in">
    <button class="logo-btn" onclick="location.reload()">
      <div class="dot dot-sm"></div>
      Parfum Studio
    </button>
    <div class="hdr-right">
      <button class="btn btn-ghost btn-sm" id="installBtn" onclick="installApp()" style="display:none">â†“ Installa App</button>
      <button class="btn btn-ghost btn-sm" onclick="location.reload()">â†º Reset</button>
      <button class="btn btn-sm" onclick="openPass()">ğŸ” Formule</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- PROGRESS -->
  <div class="prog-zone">
    <div class="prog-track"><div class="prog-fill" id="pf"></div></div>
    <div class="prog-info">
      <span id="ps-lbl">Step 1 di 5</span>
      <span id="ps-name">Famiglia</span>
    </div>
  </div>

  <!-- â”€â”€ STEP 1 â€” Famiglia â”€â”€ -->
  <div class="step on" data-step="1">
    <div class="step-head">
      <h2 class="step-ttl">Famiglia Olfattiva</h2>
      <p class="step-sub">Scegli l'identitÃ  della fragranza.</p>
    </div>
    <div class="opt-grid">
      <div class="opt" data-g="fam" data-v="fresco-agrumato" onclick="pick(this,'fam')">
        <div class="opt-ico">ğŸ‹</div><div class="opt-tit">Agrumato</div>
        <div class="opt-dsc">Limone, bergamotto, mandarino</div>
      </div>
      <div class="opt" data-g="fam" data-v="floreale" onclick="pick(this,'fam')">
        <div class="opt-ico">ğŸŒ¸</div><div class="opt-tit">Floreale</div>
        <div class="opt-dsc">Rosa, gelsomino, mughetto</div>
      </div>
      <div class="opt" data-g="fam" data-v="aromatico-fougere" onclick="pick(this,'fam')">
        <div class="opt-ico">ğŸŒ¿</div><div class="opt-tit">Aromatico</div>
        <div class="opt-dsc">Lavanda, erbe, felce</div>
      </div>
      <div class="opt" data-g="fam" data-v="legnoso-ambrato" onclick="pick(this,'fam')">
        <div class="opt-ico">ğŸŒ²</div><div class="opt-tit">Legnoso</div>
        <div class="opt-dsc">Cedro, vetiver, ambra</div>
      </div>
      <div class="opt" data-g="fam" data-v="orientale-speziato" onclick="pick(this,'fam')">
        <div class="opt-ico">ğŸ”¥</div><div class="opt-tit">Orientale</div>
        <div class="opt-dsc">Spezie, resine, vaniglia</div>
      </div>
      <div class="opt" data-g="fam" data-v="marino-fresco" onclick="pick(this,'fam')">
        <div class="opt-ico">ğŸŒŠ</div><div class="opt-tit">Marino</div>
        <div class="opt-dsc">Ozono, brezza, acquatico</div>
      </div>
      <div class="opt" data-g="fam" data-v="chypre-verde" onclick="pick(this,'fam')">
        <div class="opt-ico">ğŸƒ</div><div class="opt-tit">Chypre</div>
        <div class="opt-dsc">Patchouly, quercia, verde</div>
      </div>
      <div class="opt" data-g="fam" data-v="gourmand-dolce" onclick="pick(this,'fam')">
        <div class="opt-ico">ğŸ°</div><div class="opt-tit">Gourmand</div>
        <div class="opt-dsc">Vaniglia, cumarina, miele</div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ STEP 2 â€” Concentrazione â”€â”€ -->
  <div class="step" data-step="2">
    <div class="step-head">
      <h2 class="step-ttl">Concentrazione</h2>
      <p class="step-sub">Tipo e intensitÃ  della fragranza.</p>
    </div>
    <div class="opt-grid" style="grid-template-columns:1fr;max-width:440px;">
      <div class="opt" data-g="int" data-v="edc" onclick="pick(this,'int')" style="text-align:left;display:flex;align-items:center;gap:1rem;padding:1.2rem 1.4rem;">
        <div style="font-size:2rem">â˜ï¸</div>
        <div><div class="opt-tit">Eau de Cologne</div><div class="opt-dsc">~5% essenze Â· durata 2â€“3h Â· fresco, leggero</div></div>
      </div>
      <div class="opt" data-g="int" data-v="edt" onclick="pick(this,'int')" style="text-align:left;display:flex;align-items:center;gap:1rem;padding:1.2rem 1.4rem;">
        <div style="font-size:2rem">ğŸ’¨</div>
        <div><div class="opt-tit">Eau de Toilette</div><div class="opt-dsc">~10% essenze Â· durata 4â€“6h Â· equilibrato</div></div>
      </div>
      <div class="opt" data-g="int" data-v="edp" onclick="pick(this,'int')" style="text-align:left;display:flex;align-items:center;gap:1rem;padding:1.2rem 1.4rem;">
        <div style="font-size:2rem">âš¡</div>
        <div><div class="opt-tit">Eau de Parfum</div><div class="opt-dsc">~17% essenze Â· durata 6â€“8h Â· intenso</div></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ STEP 3 â€” Carattere â”€â”€ -->
  <div class="step" data-step="3">
    <div class="step-head">
      <h2 class="step-ttl">Carattere Olfattivo</h2>
      <p class="step-sub">Modella le sfumature sensoriali.</p>
    </div>
    <div style="max-width:520px;">
      <div class="sl-block">
        <div class="sl-top"><span>ğŸ¯ Dolcezza</span><span class="sl-val" id="vSw">50%</span></div>
        <input type="range" id="sSw" min="0" max="100" value="50" oninput="setSl('sSw','vSw','sweet')">
      </div>
      <div class="sl-block">
        <div class="sl-top"><span>ğŸ’§ Freschezza</span><span class="sl-val" id="vFr">50%</span></div>
        <input type="range" id="sFr" min="0" max="100" value="50" oninput="setSl('sFr','vFr','fresh')">
      </div>
      <div class="sl-block">
        <div class="sl-top"><span>ğŸŒ‘ ProfonditÃ </span><span class="sl-val" id="vDp">50%</span></div>
        <input type="range" id="sDp" min="0" max="100" value="50" oninput="setSl('sDp','vDp','depth')">
      </div>
      <div class="sl-block">
        <div class="sl-top"><span>âœ¨ Fruttato</span><span class="sl-val" id="vFt">30%</span></div>
        <input type="range" id="sFt" min="0" max="100" value="30" oninput="setSl('sFt','vFt','fruity')">
      </div>
    </div>
  </div>

  <!-- â”€â”€ STEP 4 â€” Occasione + Dettagli â”€â”€ -->
  <div class="step" data-step="4">
    <div class="step-head">
      <h2 class="step-ttl">Occasione & Dettagli</h2>
      <p class="step-sub">Seleziona le occasioni d'uso (opzionale) e inserisci i parametri.</p>
    </div>
    <p style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--g500);margin-bottom:.7rem;">Occasione d'Uso</p>
    <div class="pill-wrap" style="margin-bottom:1.8rem;">
      <div class="pill" data-occ="quotidiano" onclick="togOcc(this)">Quotidiano</div>
      <div class="pill" data-occ="sera" onclick="togOcc(this)">Serata</div>
      <div class="pill" data-occ="lavoro" onclick="togOcc(this)">Lavoro</div>
      <div class="pill" data-occ="sport" onclick="togOcc(this)">Sport</div>
      <div class="pill" data-occ="romantico" onclick="togOcc(this)">Romantico</div>
      <div class="pill" data-occ="estate" onclick="togOcc(this)">Estate</div>
      <div class="pill" data-occ="inverno" onclick="togOcc(this)">Inverno</div>
    </div>
    <div style="max-width:440px;">
      <div class="field">
        <label class="field-lbl">Nome del Profumo</label>
        <input class="inp" id="pName" type="text" placeholder="Es. Notte di Cedro">
      </div>
      <div class="field">
        <label class="field-lbl">Volume Finale (ml)</label>
        <input class="inp" id="pVol" type="number" value="50" min="10" max="1000">
      </div>
    </div>
  </div>

  <!-- â”€â”€ STEP 5 â€” Preview Pubblica â”€â”€ -->
  <div class="step" data-step="5">
    <div class="fp-hero" id="fp-hero">
      <div class="fp-name" id="fp-name">â€”</div>
      <div class="fp-desc" id="fp-desc">â€”</div>
    </div>

    <!-- Piramide -->
    <div class="card">
      <div class="card-hdr">Piramide Olfattiva</div>
      <div class="card-body">
        <div class="pyr-row">
          <div class="pyr-lbl"><span>Testa</span><span id="pyrTl">â€”</span></div>
          <div class="pyr-track"><div class="pyr-fill pyr-t" id="pyrTb" style="width:0%"></div></div>
        </div>
        <div class="pyr-row">
          <div class="pyr-lbl"><span>Cuore</span><span id="pyrCl">â€”</span></div>
          <div class="pyr-track"><div class="pyr-fill pyr-c" id="pyrCb" style="width:0%"></div></div>
        </div>
        <div class="pyr-row">
          <div class="pyr-lbl"><span>Fondo</span><span id="pyrFl">â€”</span></div>
          <div class="pyr-track"><div class="pyr-fill pyr-f" id="pyrFb" style="width:0%"></div></div>
        </div>
      </div>
    </div>

    <!-- Lista ingredienti pubblica -->
    <div class="card">
      <div class="card-hdr">
        <span>Ingredienti</span>
        <span style="font-size:.72rem;color:var(--g500);">% conc. Â· gocce Â· grammi</span>
      </div>
      <div class="card-body" id="pub-ing"></div>
    </div>

    <div id="tara-msg"></div>

    <div class="msg msg-info">
      <strong>ğŸ‘ Anteprima pubblica</strong> â€” Mostra ingredienti, gocce e grammature.<br>
      Costi, istruzioni dettagliate e certificato IFRA PDF si trovano nell'<strong>Area Formule</strong>.
    </div>
  </div>

  <!-- â”€â”€ STEP 6 â€” Formula Completa (Protetta) â”€â”€ -->
  <div class="step" data-step="6">
    <div class="fp-hero" id="fp-hero2">
      <div class="fp-name" id="fp-name2">â€”</div>
      <div class="fp-desc" id="fp-desc2">â€”</div>
    </div>

    <!-- Riepilogo -->
    <div class="card">
      <div class="card-hdr">ğŸ“‹ Riepilogo Formula</div>
      <div class="card-body" id="summ-body"></div>
    </div>

    <!-- Costi -->
    <div class="card">
      <div class="card-hdr">ğŸ’¶ Costi di Produzione</div>
      <div class="card-body">
        <div class="cost-grid" id="cost-grid"></div>
      </div>
    </div>

    <!-- Dosaggi Tecnici -->
    <div class="card">
      <div class="card-hdr">âš—ï¸ Dosaggi Tecnici</div>
      <div class="card-body">
        <div class="msg msg-info" style="margin-bottom:1rem;font-size:.8rem;">
          <strong>Nota calcoli:</strong> "% conc." = % della soluzione nel concentrato totale. "Pura fin." = % molecola attiva pura nel prodotto finito (con correzione diluizione). 1 goccia = 0.05 ml Â· densitÃ  â‰ˆ 1 g/ml.
        </div>
        <div id="tech-ing"></div>
      </div>
    </div>

    <!-- IFRA -->
    <div class="card">
      <div class="card-hdr">ğŸ›¡ï¸ ConformitÃ  IFRA â€” Cat.4 Leave-on</div>
      <div class="card-body">
        <p style="font-size:.8rem;color:var(--g500);margin-bottom:.9rem;line-height:1.5;">
          Verifica sulla <strong>molecola attiva pura equivalente</strong> nel prodotto finito, con correzione pre-diluizioni. IFRA 50th Amendment (2023).
        </p>
        <div id="ifra-msg"></div>
        <div style="display:grid;grid-template-columns:1fr 90px 80px 55px;gap:.4rem;padding:.4rem .8rem;background:var(--g100);border-radius:7px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--g500);margin-bottom:.5rem;">
          <span>Ingrediente</span><span style="text-align:right">Pura fin.</span><span style="text-align:right">Limite</span><span style="text-align:center">Stato</span>
        </div>
        <div id="ifra-rows"></div>
        <div id="ifra-none" class="msg msg-ok hidden">âœ… Nessun ingrediente IFRA-limitato in formula.</div>
      </div>
    </div>

    <!-- Istruzioni -->
    <div class="card">
      <div class="card-hdr">ğŸ“– Istruzioni di Preparazione</div>
      <div class="card-body">
        <ol class="inst-list">
          <li>Prepara superficie pulita. Occorrente: bilancia 0.01 g, boccetta vetro scuro, pipette Pasteur separate per ogni ingrediente, becher, bastoncino vetro.</li>
          <li>Versa <strong id="iAlc">â€”</strong> ml di alcol etilico 96Â° per profumeria nella boccetta.</li>
          <li>Aggiungi le <strong>note di fondo</strong> per prime (piÃ¹ pesanti e persistenti).</li>
          <li>Aggiungi le <strong>note di cuore</strong> (corpo centrale).</li>
          <li>Aggiungi le <strong>note di testa</strong> (le piÃ¹ volatili, per ultime).</li>
          <li>Mescola 30â€“40 secondi con movimenti circolari lenti. Chiudi ermeticamente.</li>
          <li>Etichetta con nome, data, tipo (<span id="iType">â€”</span>), volume (<span id="iVol">â€”</span> ml), nÂ° lotto.</li>
          <li><strong>Maturazione:</strong> 2â€“6 settimane al buio 18â€“22Â°C. Agita 1Ã—/settimana. Testa su mouillette prima della cute.</li>
        </ol>
      </div>
    </div>

    <div style="display:flex;gap:.8rem;flex-wrap:wrap;padding-bottom:1rem;">
      <button class="btn btn-green btn-full" onclick="printCert()">ğŸ“„ Scarica Certificato IFRA PDF</button>
      <button class="btn btn-ghost btn-full" onclick="saveFormula()">ğŸ’¾ Salva Formula</button>
    </div>
  </div>

</div><!-- /app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="bnav">
  <button class="btn btn-ghost" id="prevBtn" onclick="goStep(-1)">â† Indietro</button>
  <button class="btn" id="nextBtn" onclick="goStep(1)">Continua â†’</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL PASSWORD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="pass-ov">
  <div class="modal">
    <div class="modal-dot"></div>
    <div class="modal-ttl">Area Formule Riservata</div>
    <div class="modal-sub">Costi di produzione, istruzioni di preparazione, conformitÃ  IFRA e certificato PDF.</div>
    <div class="field">
      <label class="field-lbl">Password</label>
      <input class="inp" type="password" id="passInp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
             onkeydown="if(event.key==='Enter')chkPass()">
    </div>
    <div class="err-lbl" id="passErr"></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closePass()">Annulla</button>
      <button class="btn" onclick="chkPass()">Entra â†’</button>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATABASE INGREDIENTI
   
   dilution : frazione molecola PURA nella soluzione
              1.0 = puro  |  0.10 = 10% in TRI/IPM/APV  ecc.
   
   ifraMax  : % MAX MOLECOLA PURA nel prodotto FINITO
              (IFRA 50th Amendment 2023 â€” Cat. 4 leave-on)
   
   price    : â‚¬/10 ml della SOLUZIONE (come acquistata)
   w        : peso relativo per distribuzione gocce
   compat   : famiglie compatibili
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB = [
  /* â”€â”€ TESTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  {n:"Bergamotto FCF",         note:"t",fam:"agrumato",    dil:1.00, price:18, w:12,
   ifra:true, ifraMax:0.4,
   ifraNote:"Bergapten-free Â· max 0.4% pura nel fin.",
   compat:["fresco-agrumato","floreale","aromatico-fougere","marino-fresco","chypre-verde"]},

  {n:"Limone Italia",          note:"t",fam:"agrumato",    dil:1.00, price:12, w:12,
   ifra:true, ifraMax:2.0,
   ifraNote:"Limonene Â· max 2.0% pura nel fin.",
   compat:["fresco-agrumato","marino-fresco","aromatico-fougere"]},

  {n:"Mandarino Giallo",       note:"t",fam:"agrumato",    dil:1.00, price:15, w:10,
   ifra:false,
   compat:["fresco-agrumato","gourmand-dolce","floreale"]},

  {n:"Agrumex",                note:"t",fam:"agrumato",    dil:1.00, price:10, w:10,
   ifra:false,
   compat:["fresco-agrumato","marino-fresco","aromatico-fougere"]},

  {n:"Diidromircenolo",        note:"t",fam:"fresco",      dil:1.00, price:9,  w:10,
   ifra:false,
   compat:["fresco-agrumato","marino-fresco","aromatico-fougere"]},

  {n:"Linalolo",               note:"t",fam:"floreale",    dil:1.00, price:10, w:12,
   ifra:true, ifraMax:5.0,
   ifraNote:"Linalool Â· allergene UE Â· max 5.0% pura nel fin.",
   compat:["floreale","fresco-agrumato","aromatico-fougere","chypre-verde"]},

  {n:"Acetato Linalile",       note:"t",fam:"floreale",    dil:1.00, price:11, w:12,
   ifra:true, ifraMax:5.0,
   ifraNote:"Linalyl acetate Â· allergene UE Â· max 5.0% pura nel fin.",
   compat:["floreale","fresco-agrumato","aromatico-fougere"]},

  {n:"Cardamomo 10% TRI",      note:"t",fam:"speziato",    dil:0.10, price:20, w:6,
   ifra:false,
   compat:["orientale-speziato","aromatico-fougere","legnoso-ambrato"]},

  {n:"Pepe Nero",              note:"t",fam:"speziato",    dil:1.00, price:16, w:4,
   ifra:false,
   compat:["orientale-speziato","legnoso-ambrato","chypre-verde"]},

  {n:"Vertocitral C 10% TRI",  note:"t",fam:"agrumato",    dil:0.10, price:13, w:8,
   ifra:false,
   compat:["fresco-agrumato","marino-fresco"]},

  {n:"Manzanate 1% TRI",       note:"t",fam:"fruttato",    dil:0.01, price:16, w:3,
   ifra:true, ifraMax:0.05,
   ifraNote:"Allyl amyl glycolate Â· max 0.05% pura nel fin.",
   compat:["fresco-agrumato","gourmand-dolce","floreale"]},

  {n:"Acetato Exile",          note:"t",fam:"fruttato",    dil:1.00, price:7,  w:8,
   ifra:false,
   compat:["fresco-agrumato","floreale","gourmand-dolce"]},

  /* â”€â”€ CUORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  {n:"Hedione",                note:"c",fam:"floreale",    dil:1.00, price:25, w:15,
   ifra:false,
   compat:["floreale","fresco-agrumato","aromatico-fougere","marino-fresco","chypre-verde"]},

  {n:"Damascenone 1% TRI",     note:"c",fam:"floreale",    dil:0.01, price:55, w:3,
   ifra:true, ifraMax:0.02,
   ifraNote:"Î²-Damascenone puro Â· MASSIMO 0.02% pura nel fin. (pre-dil. 1% TRI)",
   compat:["floreale","orientale-speziato","gourmand-dolce","chypre-verde"]},

  {n:"Î±-Damascone 10% TRI",    note:"c",fam:"floreale",    dil:0.10, price:45, w:2,
   ifra:true, ifraMax:0.02,
   ifraNote:"Î±-Damascone puro Â· max 0.02% pura nel fin. (pre-dil. 10% TRI)",
   compat:["floreale","orientale-speziato","chypre-verde"]},

  {n:"Geraniolo 50%",          note:"c",fam:"floreale",    dil:0.50, price:12, w:10,
   ifra:true, ifraMax:6.0,
   ifraNote:"Geraniol puro Â· max 6.0% pura nel fin. (sol. 50%)",
   compat:["floreale","chypre-verde","aromatico-fougere"]},

  {n:"Acetato Benzile",        note:"c",fam:"floreale",    dil:1.00, price:8,  w:10,
   ifra:false,
   compat:["floreale","aromatico-fougere"]},

  {n:"Idrossicitronellale",    note:"c",fam:"floreale",    dil:1.00, price:9,  w:12,
   ifra:true, ifraMax:1.0,
   ifraNote:"Hydroxycitronellal Â· max 1.0% pura nel fin.",
   compat:["floreale","fresco-agrumato","chypre-verde"]},

  {n:"Salicilato Benzile",     note:"c",fam:"floreale",    dil:1.00, price:7,  w:12,
   ifra:true, ifraMax:10.0,
   ifraNote:"Benzyl salicylate Â· max 10.0% pura nel fin.",
   compat:["floreale","chypre-verde","aromatico-fougere"]},

  {n:"Lavandino Grosso",       note:"c",fam:"aromatico",   dil:1.00, price:12, w:12,
   ifra:false,
   compat:["aromatico-fougere","fresco-agrumato","legnoso-ambrato","chypre-verde"]},

  {n:"Salvia Sclarea 10% APV", note:"c",fam:"aromatico",   dil:0.10, price:14, w:10,
   ifra:false,
   compat:["aromatico-fougere","legnoso-ambrato","orientale-speziato"]},

  {n:"Helional",               note:"c",fam:"marino",      dil:1.00, price:22, w:10,
   ifra:false,
   compat:["marino-fresco","fresco-agrumato"]},

  {n:"Aldeide C14 10% TRI",    note:"c",fam:"fresco",      dil:0.10, price:12, w:6,
   ifra:false,
   compat:["marino-fresco","fresco-agrumato","chypre-verde"]},

  {n:"Octine Carb. Metile 10% TRI", note:"c",fam:"verde",  dil:0.10, price:12, w:8,
   ifra:false,
   compat:["chypre-verde","floreale","aromatico-fougere"]},

  {n:"Cannella Cina 1% TRI",   note:"c",fam:"speziato",    dil:0.01, price:25, w:3,
   ifra:true, ifraMax:0.1,
   ifraNote:"Cinnamaldehyde puro Â· max 0.1% pura nel fin. (pre-dil. 1% TRI)",
   compat:["orientale-speziato","gourmand-dolce"]},

  {n:"Noce Moscata rid.Safrolo",note:"c",fam:"speziato",   dil:1.00, price:14, w:5,
   ifra:true, ifraMax:1.0,
   ifraNote:"Nutmeg oil Â· max 1.0% pura nel fin.",
   compat:["orientale-speziato","legnoso-ambrato","gourmand-dolce"]},

  {n:"Eugenolo Puro",          note:"c",fam:"speziato",    dil:1.00, price:10, w:4,
   ifra:true, ifraMax:0.5,
   ifraNote:"Eugenol Â· max 0.5% pura nel fin.",
   compat:["orientale-speziato","chypre-verde"]},

  {n:"Ald. Î±-Exilcinnamica",   note:"c",fam:"floreale",    dil:1.00, price:15, w:5,
   ifra:true, ifraMax:0.5,
   ifraNote:"Î±-Hexylcinnamaldehyde Â· max 0.5% pura nel fin.",
   compat:["floreale","orientale-speziato"]},

  /* â”€â”€ FONDO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  {n:"Iso E Super",            note:"f",fam:"legnoso",     dil:1.00, price:18, w:15,
   ifra:false,
   compat:["legnoso-ambrato","orientale-speziato","marino-fresco","aromatico-fougere","chypre-verde","floreale"]},

  {n:"Cedro Virginia",         note:"f",fam:"legnoso",     dil:1.00, price:16, w:10,
   ifra:false,
   compat:["legnoso-ambrato","orientale-speziato","aromatico-fougere","chypre-verde"]},

  {n:"Patchouly",              note:"f",fam:"legnoso",     dil:1.00, price:20, w:8,
   ifra:false,
   compat:["legnoso-ambrato","orientale-speziato","chypre-verde","gourmand-dolce"]},

  {n:"Vetiver Giava",          note:"f",fam:"legnoso",     dil:1.00, price:22, w:10,
   ifra:false,
   compat:["legnoso-ambrato","fresco-agrumato","chypre-verde","aromatico-fougere"]},

  {n:"Sandalore",              note:"f",fam:"legnoso",     dil:1.00, price:24, w:10,
   ifra:false,
   compat:["legnoso-ambrato","floreale","orientale-speziato","gourmand-dolce"]},

  {n:"Vertofix Coeur",         note:"f",fam:"legnoso",     dil:1.00, price:20, w:10,
   ifra:false,
   compat:["legnoso-ambrato","chypre-verde","aromatico-fougere"]},

  {n:"Mousse de Metre 10% TRI",note:"f",fam:"legnoso",     dil:0.10, price:28, w:5,
   ifra:true, ifraMax:0.03,
   ifraNote:"Oakmoss absolute puro Â· max 0.03% pura nel fin. (pre-dil. 10% TRI)",
   compat:["chypre-verde","aromatico-fougere","legnoso-ambrato"]},

  {n:"Ambrox Super 10% IPM",   note:"f",fam:"ambrato",     dil:0.10, price:35, w:8,
   ifra:false,
   compat:["legnoso-ambrato","orientale-speziato","floreale","gourmand-dolce"]},

  {n:"Galaxolide 50% IPM",     note:"f",fam:"muschiato",   dil:0.50, price:16, w:10,
   ifra:false,
   compat:["floreale","legnoso-ambrato","marino-fresco","aromatico-fougere","chypre-verde"]},

  {n:"Habanolide",             note:"f",fam:"muschiato",   dil:1.00, price:25, w:6,
   ifra:false,
   compat:["floreale","legnoso-ambrato","gourmand-dolce"]},

  {n:"Etilene Brassilate",     note:"f",fam:"muschiato",   dil:1.00, price:18, w:8,
   ifra:false,
   compat:["floreale","marino-fresco","chypre-verde","aromatico-fougere"]},

  {n:"Cumarina 10% TRI",       note:"f",fam:"dolce",       dil:0.10, price:10, w:8,
   ifra:true, ifraMax:1.0,
   ifraNote:"Coumarin puro Â· max 1.0% pura nel fin. (pre-dil. 10% TRI)",
   compat:["gourmand-dolce","orientale-speziato","aromatico-fougere"]},

  {n:"Vanilla 10% TRI",        note:"f",fam:"dolce",       dil:0.10, price:12, w:5,
   ifra:false,
   compat:["gourmand-dolce","orientale-speziato","floreale"]},

  {n:"Aldeide C18",            note:"f",fam:"orientale",   dil:1.00, price:10, w:4,
   ifra:false,
   compat:["orientale-speziato","gourmand-dolce","legnoso-ambrato"]},

  {n:"Incenso Puro",           note:"f",fam:"resinoso",    dil:1.00, price:30, w:5,
   ifra:false,
   compat:["orientale-speziato","legnoso-ambrato","chypre-verde"]},

  {n:"Mirra 10% APV",          note:"f",fam:"resinoso",    dil:0.10, price:22, w:6,
   ifra:false,
   compat:["orientale-speziato","legnoso-ambrato"]},

  {n:"Benzoato Benzile",       note:"f",fam:"balsamico",   dil:1.00, price:7,  w:8,
   ifra:true, ifraMax:8.0,
   ifraNote:"Benzyl benzoate Â· max 8.0% pura nel fin.",
   compat:["floreale","orientale-speziato","gourmand-dolce"]},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COSTANTI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CONC_PCT = {edc:5, edt:10, edp:17};
const ALC_COST = 0.015;   // â‚¬/ml alcol 96Â°
const DROP_ML  = 0.05;    // ml per goccia
const DENS     = 1.0;     // g/ml densitÃ  media
const PYR      = {t:25, c:40, f:35}; // distribuzione % piramide

const FAM_NAMES = {
  "fresco-agrumato":"Fresco & Agrumato","floreale":"Floreale & Romantico",
  "aromatico-fougere":"Aromatico & FougÃ¨re","legnoso-ambrato":"Legnoso & Ambrato",
  "orientale-speziato":"Orientale & Speziato","marino-fresco":"Marino & Acquatico",
  "chypre-verde":"Chypre & Verde","gourmand-dolce":"Gourmand & Dolce"
};
const FAM_DESC = {
  "fresco-agrumato":"Apertura vivace su base leggera e raffinata.",
  "floreale":"Bouquet ricco di fiori sostenuto da base muschiata.",
  "aromatico-fougere":"FougÃ¨re classica â€” lavanda, erbe, base legnosa.",
  "legnoso-ambrato":"Legni nobili e ambra â€” scia profonda e persistente.",
  "orientale-speziato":"Spezie e resine esotiche â€” composizione avvolgente.",
  "marino-fresco":"Brezze ozoniche e note acquatiche â€” freschezza moderna.",
  "chypre-verde":"Patchouly, muschio di quercia, foglie verdi.",
  "gourmand-dolce":"Vaniglia, cumarina, note golose e morbide."
};
const TYPE_LBL = {edc:"Eau de Cologne ~5%",edt:"Eau de Toilette ~10%",edp:"Eau de Parfum ~17%"};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATO APPLICAZIONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let CUR = 1;
const SEL = {
  fam: null, int: null,
  sweet:50, fresh:50, depth:50, fruity:30,
  occ: [],
};
let FORMULA = null;
let deferredInstall = null;

const STEP_META = [
  {lbl:"Famiglia",      name:"Famiglia Olfattiva"},
  {lbl:"Concentraz.",   name:"Concentrazione"},
  {lbl:"Carattere",     name:"Carattere Olfattivo"},
  {lbl:"Dettagli",      name:"Occasione & Dettagli"},
  {lbl:"Anteprima",     name:"Formula Generata"},
  {lbl:"Area Tecnica",  name:"Dati Tecnici & IFRA"},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PWA â€” SERVICE WORKER & INSTALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if('serviceWorker' in navigator){
  window.addEventListener('load', () =>
    navigator.serviceWorker.register('./sw.js')
      .catch(e => console.warn('SW:', e))
  );
}
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstall = e;
  document.getElementById('installBtn').style.display = 'flex';
  document.getElementById('install-bar').classList.add('show');
});
window.addEventListener('appinstalled', () => {
  document.getElementById('install-bar').classList.remove('show');
  document.getElementById('installBtn').style.display = 'none';
});
async function installApp(){
  if(!deferredInstall) return;
  deferredInstall.prompt();
  const {outcome} = await deferredInstall.userChoice;
  if(outcome==='accepted'){
    deferredInstall = null;
    document.getElementById('install-bar').classList.remove('show');
    document.getElementById('installBtn').style.display = 'none';
  }
}
function dismissInstall(){
  document.getElementById('install-bar').classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING â†’ APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startApp(){
  const dot = document.getElementById('herobot');
  dot.classList.add('boom');
  setTimeout(() => {
    const l = document.getElementById('landing');
    l.style.opacity = '0';
    setTimeout(() => {
      l.classList.add('hidden');
      document.getElementById('hdr').style.display = 'block';
      document.getElementById('app').classList.add('on');
      document.getElementById('bnav').classList.add('show');
      updProg();
    }, 450);
  }, 750);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WIZARD â€” NAVIGAZIONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goStep(dir){
  const n = CUR + dir;

  if(dir > 0){
    if(CUR===1 && !SEL.fam){alert('Seleziona una famiglia olfattiva.');return;}
    if(CUR===2 && !SEL.int){alert('Seleziona il tipo di concentrazione.');return;}
    if(CUR===4){
      generate();
      // Vai a step 5 (preview)
    }
    if(CUR===5){
      // Richiede password per step 6
      openPass(); return;
    }
    if(CUR===6) return;
  }
  if(n < 1) return;

  document.querySelector(`.step[data-step="${CUR}"]`).classList.remove('on');
  CUR = n;
  document.querySelector(`.step[data-step="${CUR}"]`).classList.add('on');
  updProg();
  window.scrollTo({top:0,behavior:'smooth'});
}

function updProg(){
  const pct = ((CUR-1)/5)*100;
  document.getElementById('pf').style.width = pct+'%';
  const m = STEP_META[CUR-1];
  document.getElementById('ps-lbl').textContent = `Step ${CUR} di 6`;
  document.getElementById('ps-name').textContent = m.name;

  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  prevBtn.disabled = CUR === 1;
  prevBtn.style.opacity = CUR===1 ? '.3':'1';

  if(CUR===4) nextBtn.textContent = 'âœ¨ Genera Formula';
  else if(CUR===5) nextBtn.textContent = 'ğŸ” Area Formule';
  else if(CUR===6) nextBtn.textContent = 'âœ“ Completato';
  else nextBtn.textContent = 'Continua â†’';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SELEZIONI WIZARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pick(el, group){
  document.querySelectorAll(`.opt[data-g="${group}"]`).forEach(x=>x.classList.remove('sel'));
  el.classList.add('sel');
  SEL[group] = el.dataset.v;
}
function togOcc(el){
  const v = el.dataset.occ;
  el.classList.toggle('sel');
  const i = SEL.occ.indexOf(v);
  if(i>-1) SEL.occ.splice(i,1); else SEL.occ.push(v);
}
function setSl(id,vid,key){
  const v = +document.getElementById(id).value;
  document.getElementById(vid).textContent = v+'%';
  SEL[key] = v;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPER CALCOLO IFRA (CORRETTO)
   
   purePctInFinal = (gocce Ã— DROP_ML Ã— dilution) / vol Ã— 100
   
   maxDrops = (ifraMax Ã— vol) / (100 Ã— DROP_ML Ã— dilution)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function purePct(x, drops, vol){
  return (drops * DROP_ML * x.dil) / vol * 100;
}
function maxDropsIfra(x, vol){
  return Math.floor((x.ifraMax * vol) / (100 * DROP_ML * x.dil));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERA FORMULA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generate(){
  const vol      = Math.max(10, parseInt(document.getElementById('pVol').value)||50);
  const name     = document.getElementById('pName').value.trim() || 'Il Mio Profumo';
  const fam      = SEL.fam;
  const concPct  = CONC_PCT[SEL.int];
  const concMl   = vol * concPct / 100;
  const alcMl    = vol - concMl;
  const totDrops = concMl / DROP_ML;

  /* Score stile per ranking ingredienti */
  function score(x){
    let s = 0;
    const fmFam = x.fam || '';
    if(SEL.sweet>60  && ['dolce','fruttato','orientale','balsamico'].includes(fmFam)) s+=2;
    if(SEL.fresh>60  && ['agrumato','fresco','marino'].includes(fmFam)) s+=2;
    if(SEL.depth>60  && ['resinoso','ambrato','legnoso','speziato'].includes(fmFam)) s+=2;
    if(SEL.fruity>50 && ['fruttato'].includes(fmFam)) s+=2;
    return s;
  }

  const pool = note =>
    DB.filter(x => x.note===note && x.compat.includes(fam))
      .sort((a,b) => score(b)-score(a));

  const tPick = pool('t').slice(0,3);
  const cPick = pool('c').slice(0,4);
  const fPick = pool('f').slice(0,3);

  function assign(group, pyrPct){
    const gDrop = totDrops * pyrPct / 100;
    const sumW  = group.reduce((s,x)=>s+x.w,0) || 1;
    return group.map(x => ({
      ...x,
      drops: Math.max(1, Math.round(x.w / sumW * gDrop)),
      adjusted: false,
      origDrops: null
    }));
  }

  let items = [
    ...assign(tPick, PYR.t),
    ...assign(cPick, PYR.c),
    ...assign(fPick, PYR.f)
  ];

  /* â”€â”€ TARA IFRA con correzione diluizioni â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     maxDrops = floor( ifraMax% Ã— vol / (100 Ã— DROP_ML Ã— dil) )
     
     Es. Damascenone 1% TRI, vol=50ml, ifraMax=0.02%:
       maxDrops = floor( 0.02Ã—50 / (100Ã—0.05Ã—0.01) ) = floor(20) = 20 gocce âœ“
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const taraLog = [];
  items.forEach(x => {
    if(!x.ifra) return;
    const max = maxDropsIfra(x, vol);
    if(x.drops > max){
      taraLog.push({
        n: x.n,
        orig: x.drops,
        cap: max,
        ifraMax: x.ifraMax,
        dil: x.dil,
        pureOrig: purePct(x, x.drops, vol).toFixed(4),
        pureCap:  purePct(x, max,      vol).toFixed(4)
      });
      x.origDrops = x.drops;
      x.drops     = max;
      x.adjusted  = true;
    }
  });

  const totalDrops = items.reduce((s,x)=>s+x.drops, 0);
  const sumNote = n => items.filter(x=>x.note===n).reduce((s,x)=>s+x.drops,0);
  const pyrT = (sumNote('t')/totalDrops*100).toFixed(1);
  const pyrC = (sumNote('c')/totalDrops*100).toFixed(1);
  const pyrF = (sumNote('f')/totalDrops*100).toFixed(1);

  const concCost = items.reduce((s,x)=>s+(x.price/10)*(x.drops*DROP_ML), 0);
  const alcCost  = alcMl * ALC_COST;
  const totCost  = concCost + alcCost;

  FORMULA = {
    name, fam, type: SEL.int, vol, concPct, concMl, alcMl,
    items, totalDrops, pyrT, pyrC, pyrF,
    concCost, alcCost, totCost, taraLog,
    genDate: new Date().toISOString()
  };

  renderPreview();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ANTEPRIMA PUBBLICA (Step 5)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPreview(){
  const F = FORMULA;

  // Hero
  document.getElementById('fp-name').textContent  = F.name;
  document.getElementById('fp-desc').textContent  = FAM_DESC[F.fam]||'';
  document.getElementById('fp-name2').textContent = F.name;
  document.getElementById('fp-desc2').textContent = FAM_DESC[F.fam]||'';

  // Piramide (con delay animazione)
  setTimeout(()=>{
    [{k:'T',v:F.pyrT},{k:'C',v:F.pyrC},{k:'F',v:F.pyrF}].forEach(({k,v})=>{
      document.getElementById(`pyr${k}l`).textContent = v+'%';
      const b = document.getElementById(`pyr${k}b`);
      b.style.width = v+'%'; b.textContent = v+'%';
    });
  },200);

  // Ingredienti pubblici
  const bc = n => n==='t'?'b-t':n==='c'?'b-c':'b-f';
  const NL = {t:'Testa',c:'Cuore',f:'Fondo'};
  const dilBdg = x => x.dil<1
    ? `<span class="badge b-d">${Math.round(x.dil*100)}% dil.</span>` : '';
  const adjBdg = x => x.adjusted
    ? `<span class="badge b-w">tarato IFRA</span>` : '';

  document.getElementById('pub-ing').innerHTML = F.items.map(x => {
    const pctConc = (x.drops/F.totalDrops*100).toFixed(1);
    const gr      = (x.drops*DROP_ML*DENS).toFixed(3);
    return `<div class="ing-row">
      <div>
        <div class="ing-name">${x.n}</div>
        <div class="ing-meta">
          <span class="badge ${bc(x.note)}">${NL[x.note]}</span>
          ${dilBdg(x)}${adjBdg(x)}
        </div>
      </div>
      <div class="ing-pct">${pctConc}%</div>
      <div class="ing-drops">${x.drops}gc</div>
      <div class="ing-g">${gr}g</div>
    </div>`;
  }).join('');

  // Tara log
  const tm = document.getElementById('tara-msg');
  if(F.taraLog.length>0){
    tm.innerHTML = `<div class="msg msg-warn"><strong>âš ï¸ Tara IFRA (${F.taraLog.length} ingrediente/i):</strong><br>` +
      F.taraLog.map(t=>{
        const dp = Math.round(t.dil*100);
        return `<strong>${t.n}</strong> (dil. ${dp}%): ${t.orig}â†’${t.cap} gocce Â· pura fin.: ${t.pureOrig}%â†’${t.pureCap}% (lim. ${t.ifraMax}%)`;
      }).join('<br>')+`</div>`;
  } else {
    tm.innerHTML = `<div class="msg msg-ok">âœ… Nessuna tara necessaria â€” tutti gli ingredienti nei limiti IFRA.</div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER AREA TECNICA (Step 6)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTech(){
  const F = FORMULA;
  const bc = n => n==='t'?'b-t':n==='c'?'b-c':'b-f';
  const NL = {t:'Testa',c:'Cuore',f:'Fondo'};
  const TYPE_K = {edc:'Eau de Cologne',edt:'Eau de Toilette',edp:'Eau de Parfum'};

  // Riepilogo
  document.getElementById('summ-body').innerHTML = [
    ['Tipo concentrazione', TYPE_LBL[F.type]],
    ['Volume finale', F.vol+' ml'],
    ['Concentrato essenze', F.concMl.toFixed(2)+' ml ('+F.concPct+'%)'],
    ['Alcol diluente 96Â°', F.alcMl.toFixed(2)+' ml'],
    ['Gocce totali conc.', F.totalDrops+' gocce'],
    ['Peso tot. concentrato', (F.totalDrops*DROP_ML*DENS).toFixed(2)+' g'],
    ['NÂ° ingredienti', F.items.length],
  ].map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:.55rem 0;border-bottom:1px solid var(--g100);font-size:.88rem;">
    <span style="color:var(--g500)">${l}</span><strong>${v}</strong>
  </div>`).join('');

  // Costi
  document.getElementById('cost-grid').innerHTML = `
    <div class="cost-cell"><div class="cost-lbl">Concentrato</div><div class="cost-val">â‚¬${F.concCost.toFixed(2)}</div></div>
    <div class="cost-cell"><div class="cost-lbl">Alcol</div><div class="cost-val">â‚¬${F.alcCost.toFixed(2)}</div></div>
    <div class="cost-cell cost-big"><div class="cost-lbl">Totale produzione</div><div class="cost-val">â‚¬${F.totCost.toFixed(2)}</div></div>
    <div class="cost-cell"><div class="cost-lbl">Costo / ml</div><div class="cost-val">â‚¬${(F.totCost/F.vol).toFixed(3)}</div></div>
  `;

  // Istruzioni
  document.getElementById('iAlc').textContent  = F.alcMl.toFixed(1);
  document.getElementById('iType').textContent = F.type.toUpperCase();
  document.getElementById('iVol').textContent  = F.vol;

  // Dosaggi tecnici
  document.getElementById('tech-ing').innerHTML = F.items.map(x => {
    const pctConc = (x.drops/F.totalDrops*100).toFixed(2);
    const gr      = (x.drops*DROP_ML*DENS).toFixed(3);
    const pp      = purePct(x,x.drops,F.vol).toFixed(4);
    const dilBdg  = x.dil<1
      ? `<span class="badge b-d">${Math.round(x.dil*100)}% dil.</span>` : '';
    const adjBdg  = x.adjusted
      ? `<span class="badge b-w">tarato IFRA</span>` : '';
    return `<div class="ing-row">
      <div>
        <div class="ing-name">${x.n}</div>
        <div class="ing-meta">
          <span class="badge ${bc(x.note)}">${NL[x.note]}</span>
          ${dilBdg}${adjBdg}
        </div>
        <div style="font-size:.7rem;color:var(--g500);margin-top:.2rem">pura fin.: ${pp}%</div>
      </div>
      <div class="ing-pct">${pctConc}%</div>
      <div class="ing-drops">${x.drops}gc</div>
      <div class="ing-g">${gr}g</div>
    </div>`;
  }).join('');

  // IFRA
  const limited = F.items.filter(x=>x.ifra);
  const noneEl  = document.getElementById('ifra-none');
  const rowsEl  = document.getElementById('ifra-rows');
  const msgEl   = document.getElementById('ifra-msg');

  if(limited.length===0){
    noneEl.classList.remove('hidden');
    rowsEl.innerHTML=''; msgEl.innerHTML='';
  } else {
    noneEl.classList.add('hidden');
    let hasViol = false;
    rowsEl.innerHTML = limited.map(x=>{
      const pp  = purePct(x,x.drops,F.vol);
      const ok  = pp <= x.ifraMax;
      if(!ok) hasViol=true;
      const ds  = x.dil<1 ? ` (${Math.round(x.dil*100)}% dil.)` : '';
      return `<div class="ifra-row ${ok?'ok':'ko'}">
        <div>
          <strong>${x.n}</strong>${ds}
          <div class="ifra-note">${x.ifraNote}</div>
        </div>
        <div class="ifra-val">${pp.toFixed(4)}%</div>
        <div class="ifra-lim">â‰¤${x.ifraMax}%</div>
        <div class="ifra-st ${ok?'ok':'ko'}">${ok?'âœ…':'âš ï¸'}</div>
      </div>`;
    }).join('');
    msgEl.innerHTML = hasViol
      ? `<div class="msg msg-err">âš ï¸ Un ingrediente supera il limite IFRA â€” anomalia di calcolo.</div>`
      : `<div class="msg msg-ok">âœ… Tutti gli ingredienti IFRA-limitati rientrano nei limiti Cat.4 leave-on.</div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PASSWORD MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openPass(){
  if(!FORMULA){alert('Genera prima una formula (Step 4).');return;}
  document.getElementById('passInp').value='';
  document.getElementById('passErr').textContent='';
  document.getElementById('pass-ov').classList.add('open');
  setTimeout(()=>document.getElementById('passInp').focus(),200);
}
function closePass(){
  document.getElementById('pass-ov').classList.remove('open');
}
function chkPass(){
  if(document.getElementById('passInp').value !== 'FormularioProfumi'){
    document.getElementById('passErr').textContent='âŒ Password non corretta.';
    document.getElementById('passInp').select(); return;
  }
  closePass();
  // Vai a step 6
  document.querySelector(`.step[data-step="${CUR}"]`).classList.remove('on');
  CUR = 6;
  document.querySelector(`.step[data-step="6"]`).classList.add('on');
  updProg();
  renderTech();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SALVA FORMULA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveFormula(){
  if(!FORMULA) return;
  const saved = JSON.parse(localStorage.getItem('ps_formulas')||'[]');
  saved.unshift({...FORMULA, savedAt:new Date().toISOString()});
  localStorage.setItem('ps_formulas', JSON.stringify(saved));
  alert('âœ… Formula "'+FORMULA.name+'" salvata!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAMPA CERTIFICATO IFRA â€” FINESTRA SEPARATA
   

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function printCert(){
  if(!FORMULA){alert('Nessuna formula da certificare.');return;}
  const F = FORMULA;

  const now     = new Date();
  const certNum = 'PS-'+now.getTime().toString(36).toUpperCase();
  const dateStr = now.toLocaleDateString('it-IT',{day:'2-digit',month:'long',year:'numeric'});
  const timeStr = now.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});

  const limited = F.items.filter(x=>x.ifra);
  const allOk   = limited.every(x=>purePct(x,x.drops,F.vol)<=x.ifraMax);
  const staColor= allOk?'#166534':'#991b1b';
  const staTxt  = allOk?'CONFORME':'NON CONFORME';

  /* righe composizione */
  const ingRows = F.items.map((x,i)=>{
    const pc  = (x.drops/F.totalDrops*100).toFixed(2);
    const gr  = (x.drops*DROP_ML*DENS).toFixed(3);
    const pp  = purePct(x,x.drops,F.vol).toFixed(4);
    const NL  = {t:'Testa',c:'Cuore',f:'Fondo'};
    const ds  = x.dil<1?`${Math.round(x.dil*100)}%`:'Puro';
    const adj = x.adjusted?` <em style="color:#b45309;font-size:8pt">(tarato)</em>`:'';
    return `<tr style="background:${i%2?'#f9f9f9':'#fff'}">
      <td>${x.n}${adj}</td>
      <td style="text-align:center">${NL[x.note]}</td>
      <td style="text-align:center">${ds}</td>
      <td style="text-align:center">${x.drops}</td>
      <td style="text-align:center">${gr}</td>
      <td style="text-align:center">${pc}%</td>
      <td style="text-align:center"><strong>${pp}%</strong></td>
      <td style="text-align:center;color:${x.ifra?'#b45309':'#999'}">${x.ifra?'âš  IFRA':'â€”'}</td>
    </tr>`;
  }).join('');

  /* righe IFRA */
  let ifraRows = '';
  if(limited.length===0){
    ifraRows=`<tr><td colspan="5" style="color:#166534;padding:.6rem;background:#f0fdf4">âœ… Nessun ingrediente IFRA-limitato.</td></tr>`;
  } else {
    ifraRows = limited.map(x=>{
      const pp = purePct(x,x.drops,F.vol);
      const ok = pp<=x.ifraMax;
      const ds = x.dil<1?`${Math.round(x.dil*100)}%`:'100%';
      return `<tr style="background:${ok?'rgba(21,128,61,.05)':'rgba(153,27,27,.05)'}">
        <td><strong>${x.n}</strong><br><span style="font-size:7.5pt;color:#666">${x.ifraNote}</span></td>
        <td style="text-align:center">${ds}</td>
        <td style="text-align:center"><strong>${pp.toFixed(4)}%</strong></td>
        <td style="text-align:center">${x.ifraMax}%</td>
        <td style="text-align:center;font-weight:700;color:${ok?'#166534':'#991b1b'}">${ok?'âœ… OK':'âš  SUPERA'}</td>
      </tr>`;
    }).join('');
  }

  /* tara log */
  let taraHtml = '';
  if(F.taraLog.length>0){
    taraHtml=`<div style="background:#fefce8;border-left:3px solid #b45309;padding:.6rem .8rem;margin-top:.8rem;font-size:8.5pt">
      <strong>Tara IFRA applicata (con correzione diluizioni):</strong><br>
      ${F.taraLog.map(t=>{
        const dp=Math.round(t.dil*100);
        return `â€¢ ${t.n} (dil. ${dp}%): ${t.orig}â†’${t.cap} gocce | pura nel fin.: ${t.pureOrig}%â†’${t.pureCap}% (limite ${t.ifraMax}%)`;
      }).join('<br>')}
    </div>`;
  }

  const esitoTxt = allOk
    ? `La miscela profumante Ã¨ <strong>conforme</strong> ai limiti IFRA 50th Amendment (2023), Categoria 4 â€” Fine Fragrance / Leave-on. La verifica Ã¨ stata condotta sulla molecola attiva pura equivalente nel prodotto finito, con correzione della pre-diluizione di ogni ingrediente.`
    : `âš  La formula presenta non conformitÃ  ai limiti IFRA. Si raccomanda di riformulare riducendo le dosi degli ingredienti segnalati.`;

  const html=`<!DOCTYPE html>
<html lang="it"><head><meta charset="UTF-8">
<title>Certificato IFRA â€” ${F.name}</title>
<style>
@page{size:A4;margin:16mm 15mm 20mm 15mm;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Courier New',Courier,monospace;font-size:9.5pt;color:#000;background:#fff;line-height:1.5;}
h2{font-size:14pt;font-weight:700;margin-bottom:4pt;}
h3{font-size:9pt;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#555;
   border-bottom:1px solid #ccc;padding-bottom:3pt;margin:12pt 0 6pt;page-break-after:avoid;}
table{width:100%;border-collapse:collapse;font-size:8.5pt;}
th,td{padding:3.5pt 5pt;border:1px solid #ddd;vertical-align:top;}
thead th{background:#eee;font-size:7.5pt;text-transform:uppercase;letter-spacing:.05em;}
tr{page-break-inside:avoid;}
.hdr{display:flex;justify-content:space-between;align-items:flex-start;
     border-bottom:2.5pt solid #000;padding-bottom:9pt;margin-bottom:11pt;}
.logo{display:flex;align-items:center;gap:7pt;font-size:13pt;font-weight:700;}
.logo-dot{width:12pt;height:12pt;background:#cc0000;border-radius:50%;flex-shrink:0;}
.meta{text-align:right;font-size:7.5pt;color:#444;line-height:1.7;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:2pt 14pt;margin-top:4pt;}
.pair{display:flex;justify-content:space-between;padding:2.5pt 0;
      border-bottom:1px dashed #ddd;font-size:8.5pt;}
.pl{color:#666;}.pv{font-weight:700;}
.esito{display:flex;gap:14pt;align-items:flex-start;margin-top:7pt;page-break-inside:avoid;}
.esito-txt{flex:1;font-size:9pt;line-height:1.6;color:#222;}
.stamp{flex-shrink:0;width:68pt;height:68pt;border:2.5pt solid ${staColor};border-radius:50%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:${staColor};font-weight:700;font-size:6.5pt;text-align:center;letter-spacing:.04em;}
.disc{background:#f9f9f9;border-left:2.5pt solid #b45309;
      padding:6pt 8pt;font-size:7pt;line-height:1.5;color:#555;margin-top:10pt;
      page-break-inside:avoid;}
.foot{border-top:2pt solid #000;padding-top:7pt;margin-top:13pt;
      display:flex;justify-content:space-between;align-items:flex-end;
      font-size:7pt;color:#666;page-break-inside:avoid;}
.sign-line{width:130pt;height:.7pt;background:#000;margin:16pt auto 3pt;}
@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}}
</style></head><body>

<div class="hdr">
  <div class="logo">
    <div class="logo-dot"></div>
    <div>Parfum Studio<div style="font-size:7.5pt;color:#888;font-weight:400">AI Fragrance Generator Â· v2.1</div></div>
  </div>
  <div class="meta">
    <div><strong>CERTIFICATO DI CONFORMITÃ€ IFRA</strong></div>
    <div>NÂ° ${certNum}</div>
    <div>${dateStr} â€” ${timeStr}</div>
  </div>
</div>

<h2>Dichiarazione di ConformitÃ  IFRA</h2>
<p style="font-size:9pt;color:#444;margin-bottom:11pt;line-height:1.6">
  Miscela verificata secondo <strong>IFRA 50th Amendment (2023) â€” Categoria 4 â€” Fine Fragrance / Leave-on</strong>. 
  La verifica Ã¨ condotta sulla <strong>molecola attiva pura equivalente</strong> nel prodotto finito,
  con correzione della pre-diluizione di ciascun ingrediente.
</p>

<h3>Informazioni Prodotto</h3>
<div class="g2">
  <div class="pair"><span class="pl">Nome profumo</span><span class="pv">${F.name}</span></div>
  <div class="pair"><span class="pl">Tipo</span><span class="pv">${TYPE_LBL[F.type]}</span></div>
  <div class="pair"><span class="pl">Famiglia olfattiva</span><span class="pv">${FAM_NAMES[F.fam]||F.fam}</span></div>
  <div class="pair"><span class="pl">Volume formulato</span><span class="pv">${F.vol} ml</span></div>
  <div class="pair"><span class="pl">Concentrato essenze</span><span class="pv">${F.concMl.toFixed(2)} ml (${F.concPct}%)</span></div>
  <div class="pair"><span class="pl">Alcol diluente 96Â°</span><span class="pv">${F.alcMl.toFixed(2)} ml</span></div>
  <div class="pair"><span class="pl">NÂ° ingredienti</span><span class="pv">${F.items.length}</span></div>
  <div class="pair"><span class="pl">Gocce totali conc.</span><span class="pv">${F.totalDrops}</span></div>
  <div class="pair"><span class="pl">Piramide T/C/F</span><span class="pv">${F.pyrT}% / ${F.pyrC}% / ${F.pyrF}%</span></div>
  <div class="pair"><span class="pl">Standard IFRA</span><span class="pv">50th Amendment (2023) Cat.4</span></div>
  <div class="pair"><span class="pl">Data formulazione</span><span class="pv">${dateStr}</span></div>
  <div class="pair"><span class="pl">Costo produzione</span><span class="pv">â‚¬${F.totCost.toFixed(2)} (â‚¬${(F.totCost/F.vol).toFixed(3)}/ml)</span></div>
</div>

<h3>Composizione Dettagliata</h3>
<p style="font-size:7.5pt;color:#666;margin-bottom:4pt">"% Conc." = % soluzione nel conc. totale. "Pura nel Fin." = % molecola attiva pura nel prod. finito. 1 goccia = 0.05 ml Â· Ï â‰ˆ 1 g/ml.</p>
<table>
  <thead><tr>
    <th style="text-align:left">Ingrediente</th><th>Nota</th><th>Dil.</th>
    <th>Gocce</th><th>Grammi</th><th>% Conc.</th><th>Pura nel Fin.</th><th>IFRA</th>
  </tr></thead>
  <tbody>${ingRows}</tbody>
</table>

<h3>Verifica Limiti IFRA â€” Ingredienti Soggetti a Restrizioni</h3>
<p style="font-size:8pt;color:#555;margin-bottom:5pt">Verifica sulla molecola pura nel prod. finito (${F.vol} ml). Limite: IFRA 50th Amendment, Cat. 4.</p>
<table>
  <thead><tr>
    <th style="text-align:left">Ingrediente</th><th>Dil.</th>
    <th>Pura nel Fin.</th><th>Limite Cat.4</th><th>Stato</th>
  </tr></thead>
  <tbody>${ifraRows}</tbody>
</table>
${taraHtml}

<h3>Esito Certificazione</h3>
<div class="esito">
  <div class="esito-txt">${esitoTxt}</div>
  <div class="stamp">
    ${staTxt}<br>
    <span style="font-size:5.5pt;margin-top:3pt">IFRA CAT.4</span>
    <span style="font-size:5pt">50th Amend.</span>
  </div>
</div>

<div class="disc">
  <strong>âš  Disclaimer:</strong> Certificato generato automaticamente da Parfum Studio a scopo orientativo.
  Non sostituisce una valutazione della sicurezza ex Reg. (CE) 1223/2009, nÃ© una certificazione IFRA emessa da un 
  profumiere qualificato. Per commercializzazione: PIF obbligatorio e Safety Assessor qualificato.
  I limiti si riferiscono a IFRA 50th Amendment (2023), Cat. 4 leave-on. Verificare sempre il certificato IFRA 
  del fornitore per ogni lotto. DensitÃ  assunta = 1 g/ml. Pre-diluizioni dichiarate dal fornitore.
</div>

<div class="foot">
  <div>
    <div>Parfum Studio v2.1 Â· AI Fragrance Generator Â· PWA</div>
    <div>
