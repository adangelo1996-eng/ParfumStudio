<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parfum Studio</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

/* â•â• RESET â•â• */
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --black:#000;--white:#fff;--red:#d00;
  --g50:#f9f9f9;--g100:#f2f2f2;--g200:#e4e4e4;--g300:#ccc;
  --g500:#777;--g700:#333;
  --blue:#1a5fb4;--amber:#c27d00;--purple:#6a0dad;
  --green:#166534;--danger:#991b1b;
  --font:'Courier Prime','Courier New',monospace;
  --r:10px;--sh:0 2px 14px rgba(0,0,0,.08);
}
body{font-family:var(--font);background:var(--white);color:var(--black);line-height:1.6;-webkit-font-smoothing:antialiased;}
.hidden{display:none!important;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes boom{0%{transform:scale(1)}55%{transform:scale(22);opacity:.4}100%{transform:scale(0);opacity:0}}

/* â•â• BUTTONS â•â• */
.btn{
  display:inline-flex;align-items:center;gap:.4rem;
  padding:.8rem 2rem;background:var(--black);color:var(--white);
  border:2px solid var(--black);border-radius:50px;
  font-size:.9rem;font-weight:700;cursor:pointer;
  transition:all .22s;letter-spacing:.03em;font-family:var(--font);
  white-space:nowrap;
}
.btn:hover{background:var(--red);border-color:var(--red);transform:translateY(-2px);}
.btn:disabled{opacity:.35;pointer-events:none;}
.btn-out{background:var(--white);color:var(--black);}
.btn-out:hover{background:var(--black);color:var(--white);}
.btn-sm{padding:.5rem 1.3rem;font-size:.83rem;}
.btn-green{background:var(--green);border-color:var(--green);}
.btn-green:hover{background:#14532d;border-color:#14532d;}

/* â•â• LANDING â•â• */
#landing{
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;min-height:100vh;padding:2rem;text-align:center;
  transition:opacity .4s;
}
#landing.fade{opacity:0;pointer-events:none;}
.dot{width:68px;height:68px;background:var(--red);border-radius:50%;margin-bottom:2.5rem;animation:pulse 2s ease-in-out infinite;}
.dot.boom{animation:boom .65s ease-out forwards;}
#landing h1{font-size:3.1rem;font-weight:400;letter-spacing:.02em;margin-bottom:.5rem;}
.land-sub{font-size:1rem;color:var(--g500);margin-bottom:2.6rem;}

/* â•â• HEADER â•â• */
#hdr{
  position:fixed;top:0;left:0;right:0;
  background:rgba(255,255,255,.96);backdrop-filter:blur(12px);
  border-bottom:1.5px solid var(--g200);z-index:900;
  padding:1rem 2rem;display:none;
}
.hdr-in{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:.8rem;flex-wrap:wrap;}
.logo{display:flex;align-items:center;gap:.45rem;font-size:1.2rem;font-weight:700;cursor:pointer;transition:opacity .2s;}
.logo:hover{opacity:.55;}
.logo-dot{width:9px;height:9px;background:var(--red);border-radius:50%;}
.hdr-btns{display:flex;gap:.5rem;flex-wrap:wrap;}

/* â•â• APP â•â• */
#app{display:none;max-width:1100px;margin:0 auto;padding:6.5rem 1.4rem 3rem;}
#app.show{display:block;animation:fadeUp .5s ease;}

/* â•â• PROGRESS â•â• */
.prog-wrap{background:var(--g50);border:1px solid var(--g200);border-radius:var(--r);padding:1.3rem 1.7rem;margin-bottom:2rem;}
.prog-steps{display:flex;position:relative;}
.prog-steps::before{content:'';position:absolute;top:17px;left:0;right:0;height:2px;background:var(--g200);z-index:0;}
.prog-line{position:absolute;top:17px;left:0;height:2px;background:var(--red);z-index:1;transition:width .4s ease;width:0%;}
.ps{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;z-index:2;}
.ps-n{width:34px;height:34px;border-radius:50%;background:var(--white);border:2px solid var(--g300);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;margin-bottom:.25rem;transition:all .3s;}
.ps.active .ps-n{background:var(--black);border-color:var(--black);color:var(--white);}
.ps.done .ps-n{background:var(--red);border-color:var(--red);color:var(--white);}
.ps-l{font-size:.73rem;color:var(--g500);text-align:center;}
.ps.active .ps-l{color:var(--black);font-weight:700;}

/* â•â• STEPS â•â• */
.step{display:none;}
.step.on{display:block;animation:fadeUp .3s ease;}
.step-h{font-size:1.9rem;font-weight:400;letter-spacing:.01em;margin-bottom:.4rem;}
.step-sub{font-size:.97rem;color:var(--g500);margin-bottom:1.7rem;}

/* â•â• CARDS â•â• */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:.9rem;margin-bottom:1.7rem;}
.oc{background:var(--g50);border:2px solid var(--g200);border-radius:var(--r);padding:1.3rem 1rem;cursor:pointer;text-align:center;transition:all .22s;position:relative;}
.oc:hover{border-color:var(--black);transform:translateY(-3px);box-shadow:var(--sh);}
.oc.sel{background:var(--black);color:var(--white);border-color:var(--black);}
.oc.sel::after{content:'âœ“';position:absolute;top:7px;right:9px;font-size:.7rem;font-weight:700;background:var(--red);color:var(--white);width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.oc-i{font-size:2rem;margin-bottom:.6rem;display:block;}
.oc-t{font-size:.9rem;font-weight:700;margin-bottom:.2rem;}
.oc-d{font-size:.79rem;opacity:.72;line-height:1.4;}
.oc.sel .oc-d{opacity:.8;}

/* â•â• TAGS â•â• */
.tags{display:flex;flex-wrap:wrap;gap:.65rem;margin-bottom:1.7rem;}
.tag{padding:.5rem 1.1rem;background:var(--g50);border:2px solid var(--g200);border-radius:50px;cursor:pointer;font-weight:500;font-size:.86rem;transition:all .22s;}
.tag:hover{border-color:var(--black);}
.tag.sel{background:var(--black);color:var(--white);border-color:var(--black);}

/* â•â• SLIDERS â•â• */
.sl-wrap{margin-bottom:1.6rem;}
.sl-row{display:flex;justify-content:space-between;margin-bottom:.45rem;font-weight:600;}
.s-v{color:var(--red);}
input[type=range]{width:100%;height:6px;border-radius:3px;background:var(--g200);-webkit-appearance:none;appearance:none;outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--red);cursor:pointer;transition:transform .18s;}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.3);}
input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--red);border:none;}

/* â•â• INPUTS â•â• */
.field{margin-bottom:1.3rem;}
.field label{display:block;font-weight:700;margin-bottom:.3rem;font-size:.9rem;}
.inp{width:100%;padding:.8rem 1rem;border:2px solid var(--g200);border-radius:var(--r);font-size:.97rem;font-family:var(--font);transition:border-color .22s;background:var(--white);}
.inp:focus{outline:none;border-color:var(--black);}

/* â•â• NAV â•â• */
.nav{display:flex;justify-content:space-between;gap:.8rem;margin-top:1.8rem;}

/* â•â• PREVIEW â•â• */
#preview{margin-top:1.8rem;}
.block{background:var(--g50);border:1px solid var(--g200);border-radius:var(--r);padding:1.5rem;margin-bottom:1.4rem;box-shadow:var(--sh);}
.block-t{font-size:1.1rem;font-weight:700;margin-bottom:1.1rem;text-align:center;letter-spacing:.01em;}

/* pyramid */
.pyr-s{margin-bottom:.9rem;}
.pyr-h{display:flex;justify-content:space-between;font-weight:600;font-size:.87rem;margin-bottom:.3rem;}
.pyr-track{height:34px;background:var(--g200);border-radius:5px;overflow:hidden;}
.pyr-fill{height:100%;display:flex;align-items:center;padding-left:.7rem;color:var(--white);font-weight:700;font-size:.82rem;transition:width .9s ease;min-width:2.2rem;}
.pt{background:var(--blue);}
.pc{background:var(--amber);}
.pf{background:var(--purple);}

/* ingredient rows */
.ing-row{
  display:grid;grid-template-columns:1fr 70px 90px 85px;
  align-items:center;gap:.7rem;
  padding:.8rem .9rem;margin-bottom:.4rem;
  background:var(--white);border:1px solid var(--g200);border-radius:7px;
  transition:border-color .18s,transform .18s;
}
.ing-row:hover{border-color:var(--black);transform:translateX(3px);}
.ing-nw{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;}
.ing-n{font-weight:700;font-size:.92rem;}
.badge{padding:.18rem .55rem;border-radius:7px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;white-space:nowrap;}
.bt{background:rgba(26,95,180,.1);color:var(--blue);}
.bc{background:rgba(194,125,0,.1);color:var(--amber);}
.bf{background:rgba(106,13,173,.1);color:var(--purple);}
.ifra-badge{background:rgba(153,27,27,.1);color:var(--danger);border:1px solid rgba(153,27,27,.25);}
.adj-badge{background:rgba(21,128,61,.1);color:var(--green);border:1px solid rgba(21,128,61,.25);}
.ing-pct{font-size:.83rem;color:var(--g500);font-weight:500;text-align:right;}
.ing-dr{font-weight:700;color:var(--red);white-space:nowrap;font-size:.89rem;text-align:right;}
.ing-gr{font-weight:600;color:var(--g700);white-space:nowrap;font-size:.89rem;text-align:right;}

/* info box */
.ib{background:#fff5f5;border-left:4px solid var(--red);padding:.9rem 1.2rem;border-radius:7px;margin:.9rem 0;font-size:.88rem;line-height:1.7;}
.ib.ok{background:#f0fdf4;border-left-color:#166534;}
.ib.warn{background:#fefce8;border-left-color:var(--amber);}
.ib.info{background:#eff6ff;border-left-color:var(--blue);}
.acts{display:flex;gap:.7rem;justify-content:flex-end;flex-wrap:wrap;margin-top:1.1rem;}

/* â•â• MODAL â•â• */
#pass-ov{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px);}
#pass-ov.show{display:flex;}
.pass-box{background:var(--white);border-radius:13px;padding:1.9rem 2.1rem;max-width:370px;width:100%;box-shadow:0 18px 55px rgba(0,0,0,.32);animation:fadeUp .3s ease;}
.pass-box h3{font-size:1.2rem;font-weight:700;margin-bottom:.25rem;}
.pass-box p{font-size:.86rem;color:var(--g500);margin-bottom:1.1rem;}
.pass-err{font-size:.83rem;color:var(--danger);margin-top:.4rem;min-height:1.1em;}

/* â•â• FORMULA PAGE â•â• */
#fp{display:none;max-width:900px;margin:6.5rem auto 3rem;padding:0 1.4rem;}
#fp.show{display:block;animation:fadeUp .4s ease;}
.fp-hero{background:var(--black);color:var(--white);border-radius:var(--r);padding:1.8rem 2rem;margin-bottom:1.4rem;}
.fp-name{font-size:1.75rem;font-weight:700;margin-bottom:.25rem;}
.fp-desc{font-size:.92rem;opacity:.68;line-height:1.6;}
.fp-bl{background:var(--g50);border:1px solid var(--g200);border-radius:var(--r);padding:1.4rem;margin-bottom:1.4rem;box-shadow:var(--sh);}
.fp-h{font-size:1.05rem;font-weight:700;margin-bottom:.9rem;padding-bottom:.5rem;border-bottom:2px solid var(--g200);}
.sum-r{display:flex;justify-content:space-between;padding:.55rem 0;border-bottom:1px solid var(--g200);font-size:.9rem;}
.sum-r:last-child{border-bottom:none;}
.sum-l{color:var(--g500);}
.sum-v{font-weight:700;}
.cost-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:.9rem;margin-top:.7rem;}
.cc{background:var(--white);border:1px solid var(--g200);border-radius:7px;padding:.9rem;text-align:center;}
.cc-l{font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:var(--g500);margin-bottom:.25rem;}
.cc-v{font-size:1.35rem;font-weight:700;}
.cc-v.big{font-size:1.85rem;color:var(--red);}
.inst-list{list-style:none;counter-reset:inst;}
.inst-list li{counter-increment:inst;display:flex;gap:.85rem;align-items:flex-start;padding:.75rem 0;border-bottom:1px solid var(--g200);font-size:.9rem;line-height:1.6;}
.inst-list li:last-child{border-bottom:none;}
.inst-list li::before{content:counter(inst);flex-shrink:0;width:26px;height:26px;background:var(--black);color:var(--white);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.75rem;}
.ifra-hdr{display:grid;grid-template-columns:1fr 100px 90px 70px;gap:.5rem;padding:.4rem .7rem;background:var(--g200);border-radius:5px;font-size:.74rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--g500);margin-bottom:.4rem;}
.ifra-r{display:grid;grid-template-columns:1fr 100px 90px 70px;gap:.5rem;align-items:start;padding:.65rem .7rem;border-radius:6px;font-size:.86rem;margin-bottom:.35rem;}
.ifra-ok-r{background:rgba(22,101,52,.07);}
.ifra-warn-r{background:rgba(153,27,27,.07);}
.ifra-ok{color:#166534;font-weight:700;}
.ifra-warn{color:#991b1b;font-weight:700;}
.ifra-note{font-size:.76rem;color:var(--g500);margin-top:.2rem;}

/* â•â• CERT PAGE â•â• */
#cert-page{display:none;max-width:820px;margin:6.5rem auto 3rem;padding:0 1.4rem;}
#cert-page.show{display:block;animation:fadeUp .4s ease;}

/* â•â• RESPONSIVE â•â• */
@media(max-width:680px){
  #landing h1{font-size:2rem;}
  .step-h{font-size:1.5rem;}
  .cards{grid-template-columns:1fr 1fr;}
  .nav{flex-direction:column;}
  .acts{flex-direction:column;}
  .ing-row{grid-template-columns:1fr 70px 80px;}
  .ing-pct{display:none;}
  .ifra-hdr,.ifra-r{grid-template-columns:1fr 90px 65px;}
  .ifra-hdr span:nth-child(3),.ifra-r span:nth-child(3){display:none;}
}
@media(max-width:440px){
  .cards{grid-template-columns:1fr;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CERTIFICATE PRINT STYLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print{
  body *{visibility:hidden;}
  #cert-print-area,#cert-print-area *{visibility:visible;}
  #cert-print-area{
    position:fixed;inset:0;
    background:white;padding:30px 35px;
    font-family:'Courier New',monospace;
    color:#000;font-size:10pt;
  }
  .cert-no-print{display:none!important;}
}

/* certificate internal styles */
#cert-print-area{
  background:var(--white);
  font-family:var(--font);
}
.cert-header{
  display:flex;justify-content:space-between;align-items:flex-start;
  padding-bottom:1.2rem;border-bottom:3px solid var(--black);
  margin-bottom:1.5rem;
}
.cert-logo{font-size:1.5rem;font-weight:700;display:flex;align-items:center;gap:.4rem;}
.cert-logo-dot{width:10px;height:10px;background:var(--red);border-radius:50%;}
.cert-title{font-size:1.6rem;font-weight:700;letter-spacing:.03em;margin-bottom:.3rem;}
.cert-sub{font-size:.85rem;color:var(--g500);}
.cert-meta{font-size:.82rem;color:var(--g700);text-align:right;}
.cert-section{margin-bottom:1.4rem;}
.cert-section-title{
  font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;
  color:var(--g500);padding-bottom:.3rem;border-bottom:1px solid var(--g200);
  margin-bottom:.8rem;
}
.cert-grid2{display:grid;grid-template-columns:1fr 1fr;gap:.4rem .8rem;}
.cert-pair{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px dashed var(--g200);font-size:.87rem;}
.cert-pair-l{color:var(--g500);}
.cert-pair-v{font-weight:700;}
.cert-ing-table{width:100%;border-collapse:collapse;font-size:.83rem;}
.cert-ing-table th{background:var(--g100);padding:.4rem .6rem;text-align:left;font-size:.73rem;text-transform:uppercase;letter-spacing:.06em;border:1px solid var(--g200);}
.cert-ing-table td{padding:.4rem .6rem;border:1px solid var(--g200);}
.cert-ing-table tr:nth-child(even) td{background:var(--g50);}
.cert-ifra-section{margin-top:1rem;}
.cert-ifra-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:.4rem;padding:.4rem .6rem;font-size:.83rem;border-bottom:1px solid var(--g200);}
.cert-ifra-row.head{background:var(--g100);font-weight:700;font-size:.73rem;text-transform:uppercase;}
.cert-ok{color:var(--green);font-weight:700;}
.cert-warn{color:var(--danger);font-weight:700;}
.cert-footer{
  margin-top:2rem;padding-top:1rem;border-top:2px solid var(--black);
  display:flex;justify-content:space-between;align-items:flex-end;font-size:.8rem;
  color:var(--g500);
}
.cert-sign{text-align:right;}
.cert-sign-line{width:200px;height:1px;background:var(--black);margin:2rem 0 .3rem auto;}
.cert-disclaimer{
  background:var(--g50);border-left:3px solid var(--amber);
  padding:.8rem 1rem;font-size:.78rem;line-height:1.6;margin-top:1rem;
  color:var(--g700);
}
.cert-stamp{
  width:100px;height:100px;border:3px solid var(--green);border-radius:50%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:var(--green);font-weight:700;font-size:.68rem;text-align:center;
  text-transform:uppercase;letter-spacing:.05em;
  margin-top:1rem;
}
.cert-stamp-warn{border-color:var(--danger);color:var(--danger);}
</style>
</head>
<body>

<!-- â•â•â• LANDING â•â•â• -->
<div id="landing">
  <div class="dot" id="dot"></div>
  <h1>Parfum Studio</h1>
  <p class="land-sub">AI-Powered Fragrance Generator</p>
  <button class="btn" onclick="startApp()">Inizia la Creazione â†’</button>
</div>

<!-- â•â•â• HEADER â•â•â• -->
<div id="hdr">
  <div class="hdr-in">
    <div class="logo" onclick="location.reload()">
      <div class="logo-dot"></div>Parfum Studio
    </div>
    <div class="hdr-btns">
      <button class="btn btn-out btn-sm" onclick="location.reload()">â†º Reset</button>
      <button class="btn btn-sm" onclick="openPass()">ğŸ” Area Formule</button>
    </div>
  </div>
</div>

<!-- â•â•â• APP WIZARD â•â•â• -->
<div id="app">
  <div class="prog-wrap">
    <div class="prog-steps" id="psteps">
      <div class="prog-line" id="pline"></div>
      <div class="ps active" data-s="1"><div class="ps-n">1</div><div class="ps-l">Famiglia</div></div>
      <div class="ps"        data-s="2"><div class="ps-n">2</div><div class="ps-l">IntensitÃ </div></div>
      <div class="ps"        data-s="3"><div class="ps-n">3</div><div class="ps-l">Occasione</div></div>
      <div class="ps"        data-s="4"><div class="ps-n">4</div><div class="ps-l">Stile</div></div>
      <div class="ps"        data-s="5"><div class="ps-n">5</div><div class="ps-l">Dettagli</div></div>
    </div>
  </div>

  <!-- S1 FAMIGLIA -->
  <div class="step on" data-step="1">
    <h2 class="step-h">Famiglia Olfattiva</h2>
    <p class="step-sub">Scegli il carattere principale</p>
    <div class="cards">
      <div class="oc" data-v="fresco-agrumato"    onclick="pick(this,'family')"><span class="oc-i">ğŸ‹</span><div class="oc-t">Fresco & Agrumato</div><p class="oc-d">Limone, bergamotto, mandarino.</p></div>
      <div class="oc" data-v="floreale"           onclick="pick(this,'family')"><span class="oc-i">ğŸŒ¸</span><div class="oc-t">Floreale & Romantico</div><p class="oc-d">Rosa, gelsomino, mughetto.</p></div>
      <div class="oc" data-v="aromatico-fougere"  onclick="pick(this,'family')"><span class="oc-i">ğŸŒ¿</span><div class="oc-t">Aromatico & FougÃ¨re</div><p class="oc-d">Lavanda, erbe, felce.</p></div>
      <div class="oc" data-v="legnoso-ambrato"    onclick="pick(this,'family')"><span class="oc-i">ğŸŒ³</span><div class="oc-t">Legnoso & Ambrato</div><p class="oc-d">Cedro, vetiver, ambra.</p></div>
      <div class="oc" data-v="orientale-speziato" onclick="pick(this,'family')"><span class="oc-i">ğŸ”¥</span><div class="oc-t">Orientale & Speziato</div><p class="oc-d">Spezie, resine, vaniglia.</p></div>
      <div class="oc" data-v="marino-fresco"      onclick="pick(this,'family')"><span class="oc-i">ğŸŒŠ</span><div class="oc-t">Marino & Acquatico</div><p class="oc-d">Ozono, note acquatiche.</p></div>
      <div class="oc" data-v="chypre-verde"       onclick="pick(this,'family')"><span class="oc-i">ğŸƒ</span><div class="oc-t">Chypre & Verde</div><p class="oc-d">Patchouly, muschio di quercia.</p></div>
      <div class="oc" data-v="gourmand-dolce"     onclick="pick(this,'family')"><span class="oc-i">ğŸ°</span><div class="oc-t">Gourmand & Dolce</div><p class="oc-d">Vaniglia, cumarina, miele.</p></div>
    </div>
    <div class="nav"><button class="btn btn-out" disabled>â† Indietro</button><button class="btn" onclick="goNext()">Continua â†’</button></div>
  </div>

  <!-- S2 INTENSITÃ€ -->
  <div class="step" data-step="2">
    <h2 class="step-h">IntensitÃ </h2>
    <p class="step-sub">Tipo di concentrazione</p>
    <div class="cards">
      <div class="oc" data-v="edc" onclick="pick(this,'intensity')"><span class="oc-i">â˜ï¸</span><div class="oc-t">Eau de Cologne</div><p class="oc-d">~5% essenze Â· 2â€“3h</p></div>
      <div class="oc" data-v="edt" onclick="pick(this,'intensity')"><span class="oc-i">ğŸ’¨</span><div class="oc-t">Eau de Toilette</div><p class="oc-d">~10% essenze Â· 4â€“6h</p></div>
      <div class="oc" data-v="edp" onclick="pick(this,'intensity')"><span class="oc-i">âš¡</span><div class="oc-t">Eau de Parfum</div><p class="oc-d">~17% essenze Â· 6â€“8h</p></div>
    </div>
    <div class="nav"><button class="btn btn-out" onclick="goBack()">â† Indietro</button><button class="btn" onclick="goNext()">Continua â†’</button></div>
  </div>

  <!-- S3 OCCASIONE -->
  <div class="step" data-step="3">
    <h2 class="step-h">Occasione d'Uso</h2>
    <p class="step-sub">Opzionale â€” seleziona una o piÃ¹</p>
    <div class="tags">
      <div class="tag" data-v="quotidiano" onclick="toggleTag(this)">Uso quotidiano</div>
      <div class="tag" data-v="sera"       onclick="toggleTag(this)">Serata elegante</div>
      <div class="tag" data-v="lavoro"     onclick="toggleTag(this)">Lavoro / Ufficio</div>
      <div class="tag" data-v="sport"      onclick="toggleTag(this)">Sport</div>
      <div class="tag" data-v="romantico"  onclick="toggleTag(this)">Romantico</div>
      <div class="tag" data-v="inverno"    onclick="toggleTag(this)">Inverno</div>
      <div class="tag" data-v="estate"     onclick="toggleTag(this)">Estate</div>
      <div class="tag" data-v="primavera"  onclick="toggleTag(this)">Primavera / Autunno</div>
    </div>
    <div class="nav"><button class="btn btn-out" onclick="goBack()">â† Indietro</button><button class="btn" onclick="goNext()">Continua â†’</button></div>
  </div>

  <!-- S4 STILE -->
  <div class="step" data-step="4">
    <h2 class="step-h">Personalizza lo Stile</h2>
    <p class="step-sub">Regola le caratteristiche sensoriali</p>
    <div class="sl-wrap"><div class="sl-row"><span>ğŸ¯ Dolcezza</span><span class="s-v" id="vSw">50%</span></div><input type="range" id="sSw" min="0" max="100" value="50" oninput="usl('sSw','vSw','sweet')"></div>
    <div class="sl-wrap"><div class="sl-row"><span>ğŸ’§ Freschezza</span><span class="s-v" id="vFr">50%</span></div><input type="range" id="sFr" min="0" max="100" value="50" oninput="usl('sFr','vFr','fresh')"></div>
    <div class="sl-wrap"><div class="sl-row"><span>ğŸŒ‘ ProfonditÃ </span><span class="s-v" id="vDp">50%</span></div><input type="range" id="sDp" min="0" max="100" value="50" oninput="usl('sDp','vDp','depth')"></div>
    <div class="nav"><button class="btn btn-out" onclick="goBack()">â† Indietro</button><button class="btn" onclick="goNext()">Continua â†’</button></div>
  </div>

  <!-- S5 DETTAGLI -->
  <div class="step" data-step="5">
    <h2 class="step-h">Ultimi Dettagli</h2>
    <p class="step-sub">Nome e volume</p>
    <div style="max-width:460px;margin:0 auto">
      <div class="field"><label>Nome del Profumo</label><input type="text" class="inp" id="pName" placeholder="Es. Notte di Cedro"></div>
      <div class="field"><label>Volume Finale (ml)</label><input type="number" class="inp" id="pVol" value="50" min="10" max="1000"></div>
    </div>
    <div class="nav"><button class="btn btn-out" onclick="goBack()">â† Indietro</button><button class="btn" onclick="generate()">ğŸ”® Genera Formula</button></div>
  </div>

  <!-- ANTEPRIMA PUBBLICA -->
  <div id="preview" class="hidden">
    <div class="block">
      <div class="block-t" id="prevTitle">Ingredienti</div>
      <div style="margin-bottom:1.2rem;">
        <div class="pyr-s"><div class="pyr-h"><span>Note di Testa</span><span id="pTl">0%</span></div><div class="pyr-track"><div class="pyr-fill pt" id="pTb" style="width:0%"></div></div></div>
        <div class="pyr-s"><div class="pyr-h"><span>Note di Cuore</span><span id="pCl">0%</span></div><div class="pyr-track"><div class="pyr-fill pc" id="pCb" style="width:0%"></div></div></div>
        <div class="pyr-s"><div class="pyr-h"><span>Note di Fondo</span><span id="pFl">0%</span></div><div class="pyr-track"><div class="pyr-fill pf" id="pFb" style="width:0%"></div></div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 70px 90px 85px;gap:.5rem;padding:.3rem .9rem;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--g500);">
        <span>Ingrediente</span><span style="text-align:right">%</span><span style="text-align:right">Gocce</span><span style="text-align:right">Grammi</span>
      </div>
      <div id="prevList"></div>
      <div id="ifraTaraMsg"></div>
      <div class="ib info">
        <strong>ğŸ‘ Vista pubblica</strong> â€” Ingredienti, gocce e peso in grammi. La formula Ã¨ giÃ  tarata sui limiti IFRA.<br>
        Costi, istruzioni, conformitÃ  IFRA e certificato sono nell'<strong>Area Formule</strong>.
      </div>
      <div class="acts">
        <button class="btn btn-out" onclick="location.reload()">â†º Ricomincia</button>
        <button class="btn" onclick="openPass()">ğŸ” Area Formule</button>
      </div>
    </div>
  </div>
</div><!-- /app -->

<!-- â•â•â• MODAL PASSWORD â•â•â• -->
<div id="pass-ov">
  <div class="pass-box">
    <h3>ğŸ” Area Formule Riservata</h3>
    <p>Costi, istruzioni, IFRA e certificato PDF.</p>
    <div class="field"><label>Password</label><input type="password" class="inp" id="passInp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')chkPass()"></div>
    <div class="pass-err" id="passErr"></div>
    <div class="acts" style="margin-top:.9rem;">
      <button class="btn btn-out btn-sm" onclick="closePass()">Annulla</button>
      <button class="btn btn-sm" onclick="chkPass()">Entra â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â• FORMULA PAGE (protetta) â•â•â• -->
<div id="fp">
  <div class="fp-hero">
    <div class="fp-name" id="fpName">â€”</div>
    <div class="fp-desc" id="fpDesc">â€”</div>
  </div>

  <!-- Riepilogo -->
  <div class="fp-bl">
    <div class="fp-h">ğŸ“‹ Riepilogo Formula</div>
    <div class="sum-r"><span class="sum-l">Tipo</span><span class="sum-v" id="fpType">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Volume finale</span><span class="sum-v" id="fpVol">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Concentrato (essenze)</span><span class="sum-v" id="fpCml">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Alcol diluente 96Â°</span><span class="sum-v" id="fpAml">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Gocce totali</span><span class="sum-v" id="fpDr">â€”</span></div>
    <div class="sum-r"><span class="sum-l">Peso totale concentrato</span><span class="sum-v" id="fpGr">â€”</span></div>
    <div class="sum-r"><span class="sum-l">NÂ° ingredienti</span><span class="sum-v" id="fpNi">â€”</span></div>
  </div>

  <!-- Costi -->
  <div class="fp-bl">
    <div class="fp-h">ğŸ’¶ Costi di Produzione</div>
    <div class="cost-grid">
      <div class="cc"><div class="cc-l">Totale</div><div class="cc-v big" id="fpCtot">â‚¬â€”</div></div>
      <div class="cc"><div class="cc-l">Concentrato</div><div class="cc-v" id="fpCconc">â‚¬â€”</div></div>
      <div class="cc"><div class="cc-l">Alcol diluente</div><div class="cc-v" id="fpCalc">â‚¬â€”</div></div>
      <div class="cc"><div class="cc-l">Costo / ml</div><div class="cc-v" id="fpCml2">â‚¬â€”</div></div>
    </div>
  </div>

  <!-- Ingredienti tecnici -->
  <div class="fp-bl">
    <div class="fp-h">âš—ï¸ Dosaggi Tecnici</div>
    <div style="display:grid;grid-template-columns:1fr 70px 90px 85px;gap:.5rem;padding:.3rem .7rem;font-size:.74rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--g500);">
      <span>Ingrediente</span><span style="text-align:right">%</span><span style="text-align:right">Gocce</span><span style="text-align:right">Grammi</span>
    </div>
    <div id="fpIngList"></div>
    <div class="ib warn" style="margin-top:.8rem;">
      <strong>â„¹ï¸ DensitÃ  media 1 g/ml</strong> (approssimazione). Per oli densi (patchouly, mirra, cannella) il peso reale Ã¨ leggermente superiore. 1 goccia â‰ˆ 0.05 ml.
    </div>
  </div>

  <!-- IFRA -->
  <div class="fp-bl">
    <div class="fp-h">ğŸ›¡ï¸ ConformitÃ  IFRA â€” Cat. 4 Fine Fragrance (leave-on)</div>
    <p style="font-size:.87rem;color:var(--g500);margin-bottom:.9rem;line-height:1.6;">
      La formula Ã¨ giÃ  stata tarata automaticamente per rispettare i limiti IFRA 50th Amendment (Cat. 4 â€” applicazione diretta cute). Le gocce degli ingredienti limitati sono state ridotte all'occorrenza. Verifica sempre il certificato IFRA del fornitore per ogni lotto.
    </p>
    <div id="ifraGlobalMsg" style="margin-bottom:.8rem;"></div>
    <div class="ifra-hdr"><span>Ingrediente</span><span>% prod. finito</span><span>Limite IFRA</span><span>Stato</span></div>
    <div id="ifraRows"></div>
    <div id="ifraNoLim" class="ib ok hidden">âœ… Nessun ingrediente IFRA-limitato presente in questa formula.</div>
  </div>

  <!-- Istruzioni -->
  <div class="fp-bl">
    <div class="fp-h">ğŸ“– Istruzioni di Preparazione</div>
    <ol class="inst-list">
      <li>Prepara area di lavoro pulita e asciutta. Occorrente: bilancia 0.01 g, boccetta in vetro scuro, pipette Pasteur separate per ogni ingrediente, becher 100 ml, bastoncino vetro, etichette.</li>
      <li>Versa nella boccetta <strong id="iAlc">â€”</strong> ml di alcol etilico 96Â° per profumeria.</li>
      <li>Aggiungi le <strong>note di fondo</strong> per prime (peso massimo, scia piÃ¹ lunga): conta le gocce con la pipetta dedicata a ogni ingrediente.</li>
      <li>Aggiungi le <strong>note di cuore</strong> (corpo del profumo).</li>
      <li>Aggiungi le <strong>note di testa</strong> (le piÃ¹ volatili, per ultime).</li>
      <li>Mescola delicatamente con il bastoncino 30â€“40 sec, movimenti circolari lenti.</li>
      <li>Chiudi ermeticamente. Etichetta: nome, data, tipo (<span id="iType">â€”</span>), volume (<span id="iVol">â€”</span> ml), lotto.</li>
      <li><strong>Maturazione:</strong> 2â€“6 settimane al buio a 18â€“22 Â°C. Agita 1 volta/settimana. Non aprire i primi 7 giorni. Testa prima su mouillette.</li>
    </ol>
  </div>

  <div class="acts">
    <button class="btn btn-out" onclick="closeFP()">â† Chiudi</button>
    <button class="btn btn-out" onclick="window.print()">ğŸ–¨ï¸ Stampa</button>
    <button class="btn btn-green" onclick="showCert()">ğŸ“„ Genera Certificato IFRA</button>
    <button class="btn" onclick="saveF()">ğŸ’¾ Salva</button>
  </div>
</div><!-- /fp -->

<!-- â•â•â• CERTIFICATE PAGE â•â•â• -->
<div id="cert-page">
  <div class="acts cert-no-print" style="margin-bottom:1.2rem;">
    <button class="btn btn-out" onclick="closeCert()">â† Torna alla Formula</button>
    <button class="btn btn-green" onclick="window.print()">â¬‡ï¸ Scarica PDF</button>
  </div>

  <div id="cert-print-area">
    <!-- Header certificato -->
    <div class="cert-header">
      <div>
        <div class="cert-logo"><div class="cert-logo-dot"></div>Parfum Studio</div>
        <div style="font-size:.78rem;color:var(--g500);margin-top:.2rem;">AI-Powered Fragrance Generator</div>
      </div>
      <div class="cert-meta">
        <div><strong>CERTIFICATO DI CONFORMITÃ€ IFRA</strong></div>
        <div id="certNum" style="margin:.2rem 0;"></div>
        <div id="certDate"></div>
      </div>
    </div>

    <div class="cert-title">Dichiarazione di ConformitÃ  IFRA</div>
    <p class="cert-sub" style="margin-bottom:1.4rem;">
      Il sottoscritto dichiara che la miscela profumante descritta in questo documento Ã¨ stata formulata nel rispetto degli standard IFRA (International Fragrance Association) â€” <strong>50th Amendment (2023)</strong>, Categoria 4 â€” Fine Fragrance / Leave-on.
    </p>

    <!-- Info prodotto -->
    <div class="cert-section">
      <div class="cert-section-title">Informazioni Prodotto</div>
      <div class="cert-grid2">
        <div class="cert-pair"><span class="cert-pair-l">Nome profumo</span><span class="cert-pair-v" id="cProdName">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">Tipo concentrazione</span><span class="cert-pair-v" id="cType">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">Volume formulato</span><span class="cert-pair-v" id="cVol">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">Famiglia olfattiva</span><span class="cert-pair-v" id="cFam">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">NÂ° ingredienti</span><span class="cert-pair-v" id="cNIng">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">Conc. essenze</span><span class="cert-pair-v" id="cConcPct">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">Data formulazione</span><span class="cert-pair-v" id="cDataForm">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">Standard applicato</span><span class="cert-pair-v">IFRA 50th Amendment</span></div>
      </div>
    </div>

    <!-- Piramide olfattiva -->
    <div class="cert-section">
      <div class="cert-section-title">Piramide Olfattiva</div>
      <div class="cert-grid2">
        <div class="cert-pair"><span class="cert-pair-l">Note di Testa</span><span class="cert-pair-v" id="cPyrT">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">Note di Cuore</span><span class="cert-pair-v" id="cPyrC">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">Note di Fondo</span><span class="cert-pair-v" id="cPyrF">â€”</span></div>
        <div class="cert-pair"><span class="cert-pair-l">Gocce totali</span><span class="cert-pair-v" id="cTotDr">â€”</span></div>
      </div>
    </div>

    <!-- Ingredienti -->
    <div class="cert-section">
      <div class="cert-section-title">Composizione Dettagliata</div>
      <table class="cert-ing-table">
        <thead>
          <tr>
            <th>Ingrediente</th>
            <th>Nota</th>
            <th>Gocce</th>
            <th>Grammi</th>
            <th>% Conc.</th>
            <th>% Prod. Finito</th>
            <th>IFRA</th>
          </tr>
        </thead>
        <tbody id="cIngTbody"></tbody>
      </table>
    </div>

    <!-- IFRA specifico -->
    <div class="cert-section">
      <div class="cert-section-title">Verifica Limiti IFRA â€” Ingredienti Limitati</div>
      <p style="font-size:.8rem;color:var(--g500);margin-bottom:.7rem;">
        Di seguito la verifica per ogni ingrediente soggetto a restrizioni IFRA (50th Amendment, Cat. 4 â€” Fine Fragrance). Le concentrazioni si riferiscono al prodotto finito pronto all'uso.
      </p>
      <div id="cIfraContent"></div>
      <div id="cIfraOkMsg"></div>
    </div>

    <!-- Esito globale -->
    <div class="cert-section" style="display:flex;gap:2rem;align-items:flex-start;">
      <div style="flex:1;">
        <div class="cert-section-title">Esito Certificazione</div>
        <div id="cEsitoTxt" style="font-size:.9rem;line-height:1.7;"></div>
        <div class="cert-disclaimer">
          <strong>âš ï¸ Disclaimer:</strong> questo certificato Ã¨ generato automaticamente da Parfum Studio a scopo orientativo. 
          Non sostituisce una valutazione di sicurezza professionale ai sensi del Regolamento (CE) n. 1223/2009 nÃ© una certificazione IFRA 
          emessa da un profumiere certificato. Per uso commerciale o cosmetico, Ã¨ obbligatoria una PIF (Product Information File) 
          e una valutazione della sicurezza da parte di un valutatore qualificato. I limiti IFRA riportati sono quelli del 50th Amendment (2023) 
          per la Categoria 4 (leave-on, applicazione diretta cute). Verificare sempre i certificati IFRA dei fornitori per ogni lotto di materia prima.
        </div>
      </div>
      <div class="cert-stamp" id="cStamp" style="flex-shrink:0;">
        <div id="cStampText">CONFORME</div>
        <div style="margin-top:.3rem;font-size:.6rem;">IFRA CAT.4</div>
        <div style="font-size:.6rem;">50th Amendment</div>
      </div>
    </div>

    <!-- Footer -->
    <div class="cert-footer">
      <div>
        <div>Parfum Studio â€” AI Fragrance Generator</div>
        <div id="cFootDate"></div>
        <div>Certificato nÂ° <span id="cFootNum"></span></div>
      </div>
      <div class="cert-sign">
        <div class="cert-sign-line"></div>
        <div>Generato automaticamente</div>
        <div style="font-size:.75rem;">Parfum Studio v2.0</div>
      </div>
    </div>
  </div><!-- /cert-print-area -->

  <div class="acts cert-no-print" style="margin-top:1.2rem;">
    <button class="btn btn-out" onclick="closeCert()">â† Torna alla Formula</button>
    <button class="btn btn-green" onclick="window.print()">â¬‡ï¸ Scarica PDF</button>
  </div>
</div><!-- /cert-page -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATABASE INGREDIENTI
   ifra: true = soggetto a restrizioni IFRA
   ifraMax: % massima nel PRODOTTO FINITO
             (Cat. 4 â€” Fine Fragrance leave-on, IFRA 50th Amendment 2023)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB=[
  // â”€â”€â”€â”€ TESTA â”€â”€â”€â”€
  {n:"BERGAMOTTO",             note:"testa",fam:"agrumato", price:18,w:12, ifra:true,  ifraMax:0.4,  ifraNote:"FCF-free richiesto; olio standard max 0.4% (fototossico)",
   compat:["fresco-agrumato","floreale","aromatico-fougere","marino-fresco","chypre-verde"]},
  {n:"LIMONE ITALIA",          note:"testa",fam:"agrumato", price:12,w:12, ifra:true,  ifraMax:2.0,  ifraNote:"Limonene libero â‰¤2% prod. finito",
   compat:["fresco-agrumato","marino-fresco","aromatico-fougere"]},
  {n:"MANDARINO GIALLO",       note:"testa",fam:"agrumato", price:15,w:10, ifra:false,
   compat:["fresco-agrumato","gourmand-dolce","floreale"]},
  {n:"AGRUMEX",                note:"testa",fam:"agrumato", price:10,w:10, ifra:false,
   compat:["fresco-agrumato","marino-fresco","aromatico-fougere"]},
  {n:"VERTOCITRAL C",          note:"testa",fam:"agrumato", price:13,w:8,  ifra:false,
   compat:["fresco-agrumato","marino-fresco"]},
  {n:"ACETATO LINALILE",       note:"testa",fam:"floreale",  price:11,w:12, ifra:true,  ifraMax:5.0,  ifraNote:"Linalyl acetate â€” limite UE allergeni 5% leave-on",
   compat:["floreale","fresco-agrumato","aromatico-fougere"]},
  {n:"LINALOLO",               note:"testa",fam:"floreale",  price:10,w:12, ifra:true,  ifraMax:5.0,  ifraNote:"Linalool â€” limite UE allergeni 5% (dichiarazione INCI obbligatoria)",
   compat:["floreale","fresco-agrumato","aromatico-fougere","chypre-verde"]},
  {n:"ETIL LINALOLO",          note:"testa",fam:"floreale",  price:8, w:10, ifra:false,
   compat:["floreale","aromatico-fougere"]},
  {n:"ISORALDEINA",            note:"testa",fam:"fresco",    price:11,w:8,  ifra:false,
   compat:["marino-fresco","fresco-agrumato","chypre-verde"]},
  {n:"DIIDROMIRCENOLO",        note:"testa",fam:"fresco",    price:9, w:10, ifra:false,
   compat:["fresco-agrumato","marino-fresco","aromatico-fougere"]},
  {n:"CARDAMOMO",              note:"testa",fam:"speziato",  price:20,w:6,  ifra:false,
   compat:["orientale-speziato","aromatico-fougere","legnoso-ambrato"]},
  {n:"PEPE NERO",              note:"testa",fam:"speziato",  price:16,w:4,  ifra:false,
   compat:["orientale-speziato","legnoso-ambrato","chypre-verde"]},
  {n:"MANZANATE",              note:"testa",fam:"fruttato",  price:16,w:3,  ifra:true,  ifraMax:0.05, ifraNote:"Allyl amyl glycolate â€” max 0.05% prod. finito",
   compat:["fresco-agrumato","gourmand-dolce","floreale"]},
  {n:"ALLIL AMIL GLICOLATE",   note:"testa",fam:"fruttato",  price:14,w:3,  ifra:true,  ifraMax:0.05, ifraNote:"Max 0.05% prod. finito (IFRA 50th restricted)",
   compat:["fresco-agrumato","gourmand-dolce"]},
  {n:"ACETATO EXILE",          note:"testa",fam:"fruttato",  price:7, w:8,  ifra:false,
   compat:["fresco-agrumato","floreale","gourmand-dolce"]},

  // â”€â”€â”€â”€ CUORE â”€â”€â”€â”€
  {n:"HEDIONE",                note:"cuore",fam:"floreale",  price:25,w:15, ifra:false,
   compat:["floreale","fresco-agrumato","aromatico-fougere","marino-fresco","chypre-verde"]},
  {n:"DAMASCENONE",            note:"cuore",fam:"floreale",  price:55,w:1,  ifra:true,  ifraMax:0.02, ifraNote:"Beta-Damascenone â€” max 0.02% prod. finito (potentissimo)",
   compat:["floreale","orientale-speziato","gourmand-dolce","chypre-verde"]},
  {n:"ALFA DAMASCONE",         note:"cuore",fam:"floreale",  price:45,w:2,  ifra:true,  ifraMax:0.02, ifraNote:"Î±-Damascone â€” max 0.02% prod. finito",
   compat:["floreale","orientale-speziato","chypre-verde"]},
  {n:"GERANIOLO",              note:"cuore",fam:"floreale",  price:12,w:10, ifra:true,  ifraMax:6.0,  ifraNote:"Geraniol â€” limite UE allergeni 6% leave-on",
   compat:["floreale","chypre-verde","aromatico-fougere"]},
  {n:"ACETATO BENZILE",        note:"cuore",fam:"floreale",  price:8, w:10, ifra:false,
   compat:["floreale","aromatico-fougere"]},
  {n:"IDROSSICITRONELLALE",    note:"cuore",fam:"floreale",  price:9, w:12, ifra:true,  ifraMax:1.0,  ifraNote:"Hydroxycitronellal â€” max 1.0% leave-on (sensibilizzante)",
   compat:["floreale","fresco-agrumato","chypre-verde"]},
  {n:"SALICILATO BENZILE",     note:"cuore",fam:"floreale",  price:7, w:12, ifra:true,  ifraMax:10.0, ifraNote:"Benzyl salicylate â€” limite UE 10% leave-on",
   compat:["floreale","chypre-verde","aromatico-fougere"]},
  {n:"ACETATO GERANILE",       note:"cuore",fam:"floreale",  price:9, w:10, ifra:false,
   compat:["floreale","chypre-verde"]},
  {n:"ALDEIDE ALFA EXILCINNAMICA",note:"cuore",fam:"floreale",price:15,w:5, ifra:true,  ifraMax:0.5,  ifraNote:"Î±-Hexylcinnamaldehyde â€” max 0.5% leave-on",
   compat:["floreale","orientale-speziato"]},
  {n:"ANTRANILATO METILE",     note:"cuore",fam:"floreale",  price:8, w:8,  ifra:false,
   compat:["floreale","gourmand-dolce"]},
  {n:"LAVANDINO GROSSO",       note:"cuore",fam:"aromatico", price:12,w:12, ifra:false,
   compat:["aromatico-fougere","fresco-agrumato","legnoso-ambrato","chypre-verde"]},
  {n:"SALVIA SCLAREA",         note:"cuore",fam:"aromatico", price:14,w:10, ifra:false,
   compat:["aromatico-fougere","legnoso-ambrato","orientale-speziato"]},
  {n:"HELIONAL",               note:"cuore",fam:"marino",    price:22,w:10, ifra:false,
   compat:["marino-fresco","fresco-agrumato"]},
  {n:"ALDEIDE C14",            note:"cuore",fam:"fresco",    price:12,w:6,  ifra:false,
   compat:["marino-fresco","fresco-agrumato","chypre-verde"]},
  {n:"OCTINE CARBONATO METILE",note:"cuore",fam:"verde",     price:12,w:8,  ifra:false,
   compat:["chypre-verde","floreale","aromatico-fougere"]},
  {n:"CANNELLA CINA",          note:"cuore",fam:"speziato",  price:25,w:2,  ifra:true,  ifraMax:0.1,  ifraNote:"Cinnamaldehyde â€” max 0.1% leave-on (forte allergene IFRA)",
   compat:["orientale-speziato","gourmand-dolce"]},
  {n:"NOCE MOSCATA",           note:"cuore",fam:"speziato",  price:14,w:5,  ifra:true,  ifraMax:1.0,  ifraNote:"Nutmeg oil (safrolo rid.) â€” max 1.0% leave-on",
   compat:["orientale-speziato","legnoso-ambrato","gourmand-dolce"]},
  {n:"EUGENOLO PURO",          note:"cuore",fam:"speziato",  price:10,w:4,  ifra:true,  ifraMax:0.5,  ifraNote:"Eugenol â€” max 0.5% leave-on (allergene IFRA)",
   compat:["orientale-speziato","chypre-verde"]},

  // â”€â”€â”€â”€ FONDO â”€â”€â”€â”€
  {n:"ISO E SUPER",            note:"fondo",fam:"legnoso",   price:18,w:15, ifra:false,
   compat:["legnoso-ambrato","orientale-speziato","marino-fresco","aromatico-fougere","chypre-verde","floreale"]},
  {n:"CEDRO VIRGINIA",         note:"fondo",fam:"legnoso",   price:16,w:10, ifra:false,
   compat:["legnoso-ambrato","orientale-speziato","aromatico-fougere","chypre-verde"]},
  {n:"PATCHOULY",              note:"fondo",fam:"legnoso",   price:20,w:8,  ifra:false,
   compat:["legnoso-ambrato","orientale-speziato","chypre-verde","gourmand-dolce"]},
  {n:"VETIVER GIAVA",          note:"fondo",fam:"legnoso",   price:22,w:10, ifra:false,
   compat:["legnoso-ambrato","fresco-agrumato","chypre-verde","aromatico-fougere"]},
  {n:"SANDALORE",              note:"fondo",fam:"legnoso",   price:24,w:10, ifra:false,
   compat:["legnoso-ambrato","floreale","orientale-speziato","gourmand-dolce"]},
  {n:"VERTOFIX COEUR",         note:"fondo",fam:"legnoso",   price:20,w:10, ifra:false,
   compat:["legnoso-ambrato","chypre-verde","aromatico-fougere"]},
  {n:"MOUSSE DE METRE",        note:"fondo",fam:"legnoso",   price:28,w:5,  ifra:true,  ifraMax:0.03, ifraNote:"Oakmoss absolute â€” max 0.03% leave-on (IFRA strictly restricted)",
   compat:["chypre-verde","aromatico-fougere","legnoso-ambrato"]},
  {n:"AMBROX SUPER",           note:"fondo",fam:"ambrato",   price:35,w:6,  ifra:false,
   compat:["legnoso-ambrato","orientale-speziato","floreale","gourmand-dolce"]},
  {n:"ALDEIDE C18",            note:"fondo",fam:"orientale", price:10,w:4,  ifra:false,
   compat:["orientale-speziato","gourmand-dolce","legnoso-ambrato"]},
  {n:"CUMARINA",               note:"fondo",fam:"dolce",     price:10,w:8,  ifra:true,  ifraMax:1.0,  ifraNote:"Coumarin â€” max 1.0% leave-on (IFRA 50th)",
   compat:["gourmand-dolce","orientale-speziato","aromatico-fougere"]},
  {n:"VANILLA",                note:"fondo",fam:"dolce",     price:12,w:5,  ifra:false,
   compat:["gourmand-dolce","orientale-speziato","floreale"]},
  {n:"GALAXOLIDE",             note:"fondo",fam:"muschiato", price:16,w:10, ifra:false,
   compat:["floreale","legnoso-ambrato","marino-fresco","aromatico-fougere","chypre-verde"]},
  {n:"HABANOLIDE",             note:"fondo",fam:"muschiato", price:25,w:6,  ifra:false,
   compat:["floreale","legnoso-ambrato","gourmand-dolce"]},
  {n:"ETILENE BRASSILATE",     note:"fondo",fam:"muschiato", price:18,w:8,  ifra:false,
   compat:["floreale","marino-fresco","chypre-verde","aromatico-fougere"]},
  {n:"INCENSO PURO",           note:"fondo",fam:"resinoso",  price:30,w:5,  ifra:false,
   compat:["orientale-speziato","legnoso-ambrato","chypre-verde"]},
  {n:"MIRRA",                  note:"fondo",fam:"resinoso",  price:22,w:6,  ifra:false,
   compat:["orientale-speziato","legnoso-ambrato"]},
  {n:"BENZOATO BENZILE",       note:"fondo",fam:"balsamico", price:7, w:8,  ifra:true,  ifraMax:8.0,  ifraNote:"Benzyl benzoate â€” limite UE 8% leave-on",
   compat:["floreale","orientale-speziato","gourmand-dolce"]},
];

/* costanti */
const CONC  = {edc:5, edt:10, edp:17};
const ALCML = 0.015; // â‚¬/ml alcol
const DROML = 0.05;  // ml/goccia
const DENS  = 1.0;   // g/ml media

const PYR   = {testa:25, cuore:40, fondo:35};

const FAMNAMES = {
  "fresco-agrumato":"Fresco & Agrumato","floreale":"Floreale & Romantico",
  "aromatico-fougere":"Aromatico & FougÃ¨re","legnoso-ambrato":"Legnoso & Ambrato",
  "orientale-speziato":"Orientale & Speziato","marino-fresco":"Marino & Acquatico",
  "chypre-verde":"Chypre & Verde","gourmand-dolce":"Gourmand & Dolce"
};
const FAMDESCS = {
  "fresco-agrumato":"Profilo agrumato brillante â€” apertura vivace su base leggera e raffinata.",
  "floreale":"Bouquet floreale elegante â€” cuore ricco di fiori sostenuto da base muschiata.",
  "aromatico-fougere":"Struttura fougÃ¨re classica â€” lavanda, erbe aromatiche, base legnosa pulita.",
  "legnoso-ambrato":"Legni nobili e ambra calda â€” scia profonda e persistente da sera.",
  "orientale-speziato":"Spezie esotiche e resine â€” composizione misteriosamente avvolgente.",
  "marino-fresco":"Brezze ozoniche e note acquatiche â€” freschezza moderna e urbana.",
  "chypre-verde":"Accordo chypre sofisticato â€” patchouly, muschio di quercia, foglie verdi.",
  "gourmand-dolce":"Note golose â€” vaniglia, cumarina, gourmand morbido."
};

/* â•â• STATE â•â• */
let curStep=1;
const sel={family:null,intensity:null,occasions:[],sweet:50,fresh:50,depth:50};
let F=null; // formula corrente

/* â•â• LANDING â•â• */
function startApp(){
  const d=document.getElementById('dot');
  d.classList.add('boom');
  setTimeout(()=>document.getElementById('landing').classList.add('fade'),350);
  setTimeout(()=>{
    document.getElementById('landing').style.display='none';
    document.getElementById('hdr').style.display='block';
    document.getElementById('app').classList.add('show');
    updProg();
  },900);
}

/* â•â• WIZARD helpers â•â• */
function pick(el,key){
  el.closest('.cards').querySelectorAll('.oc').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel');
  sel[key]=el.dataset.v;
}
function toggleTag(el){
  el.classList.toggle('sel');
  const v=el.dataset.v,i=sel.occasions.indexOf(v);
  if(i>-1)sel.occasions.splice(i,1);else sel.occasions.push(v);
}
function usl(id,vid,key){
  const v=+document.getElementById(id).value;
  document.getElementById(vid).textContent=v+'%';
  sel[key]=v;
}
function goNext(){
  if(curStep===1&&!sel.family){alert('âš ï¸ Seleziona una famiglia olfattiva.');return;}
  if(curStep===2&&!sel.intensity){alert('âš ï¸ Seleziona il tipo di concentrazione.');return;}
  setStep(curStep+1);
}
function goBack(){setStep(curStep-1);}
function setStep(n){
  document.querySelector(`.step[data-step="${curStep}"]`).classList.remove('on');
  const prev=document.querySelector(`.ps[data-s="${curStep}"]`);
  if(n>curStep)prev.classList.replace('active','done');
  else prev.classList.remove('done','active');
  curStep=n;
  document.querySelector(`.step[data-step="${curStep}"]`).classList.add('on');
  document.querySelector(`.ps[data-s="${curStep}"]`).classList.add('active');
  updProg();
  window.scrollTo({top:0,behavior:'smooth'});
}
function updProg(){
  document.getElementById('pline').style.width=((curStep-1)/4*100)+'%';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERA FORMULA con TARA IFRA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generate(){
  const vol =parseInt(document.getElementById('pVol').value)||50;
  const name=document.getElementById('pName').value.trim()||'Il Mio Profumo';
  const fam =sel.family;
  const type=sel.intensity;
  const concPct=CONC[type];

  /* Score stile per ordinare ingredienti */
  const styleScore=x=>{
    let s=0;
    if(sel.sweet>60&&['dolce','fruttato','gourmand'].includes(x.fam))s+=2;
    if(sel.fresh>60&&['agrumato','fresco','marino'].includes(x.fam))s+=2;
    if(sel.depth>60&&['resinoso','ambrato','legnoso','orientale'].includes(x.fam))s+=2;
    return s;
  };
  const pool=note=>DB.filter(x=>x.note===note&&x.compat.includes(fam))
                     .sort((a,b)=>styleScore(b)-styleScore(a));

  const tPick=pool('testa').slice(0,3);
  const cPick=pool('cuore').slice(0,4);
  const fPick=pool('fondo').slice(0,3);

  const concMl=vol*concPct/100;
  const alcMl =vol-concMl;
  const totalDropsTarget=concMl/DROML;

  /* assegna gocce iniziali proporzionali al peso relativo */
  const assignDrops=(group,pyrPct)=>{
    const gDrops=totalDropsTarget*pyrPct/100;
    const sumW=group.reduce((s,x)=>s+x.w,0)||1;
    return group.map(x=>({
      ...x,
      drops:Math.max(1,Math.round(x.w/sumW*gDrops)),
      adjusted:false
    }));
  };

  let tF=assignDrops(tPick,PYR.testa);
  let cF=assignDrops(cPick,PYR.cuore);
  let fF=assignDrops(fPick,PYR.fondo);
  let formula=[...tF,...cF,...fF];

  /* â”€â”€ TARA IFRA â”€â”€
     Per ogni ingrediente IFRA-limitato, calcola la % nel prodotto finito
     e riduce le gocce se supera il limite.
     % prod.finito = (gocce Ã— DROML) / vol Ã— 100
     gocce_max = (ifraMax/100 Ã— vol) / DROML
  */
  const adjustments=[];
  formula=formula.map(x=>{
    if(!x.ifra)return x;
    const maxDrops=Math.floor((x.ifraMax/100*vol)/DROML);
    if(x.drops>maxDrops){
      adjustments.push({
        n:x.n,
        orig:x.drops,
        adj:Math.max(1,maxDrops),
        ifraMax:x.ifraMax
      });
      return{...x,drops:Math.max(1,maxDrops),adjusted:true};
    }
    return x;
  });

  const totalDrops=formula.reduce((s,x)=>s+x.drops,0);

  /* piramide reale */
  const pyr={
    testa:(formula.filter(x=>x.note==='testa').reduce((s,x)=>s+x.drops,0)/totalDrops*100).toFixed(1),
    cuore:(formula.filter(x=>x.note==='cuore').reduce((s,x)=>s+x.drops,0)/totalDrops*100).toFixed(1),
    fondo:(formula.filter(x=>x.note==='fondo').reduce((s,x)=>s+x.drops,0)/totalDrops*100).toFixed(1),
  };

  /* costi */
  const concCost=formula.reduce((s,x)=>s+(x.price/10)*(x.drops*DROML),0);
  const alcCost =alcMl*ALCML;
  const totCost =concCost+alcCost;

  F={name,fam,type,vol,concPct,concMl,alcMl,formula,totalDrops,pyr,concCost,alcCost,totCost,adjustments};

  renderPreview(F);
}

/* â•â• RENDER ANTEPRIMA â•â• */
function renderPreview(f){
  document.getElementById('prevTitle').textContent=`${f.name} â€” ${f.formula.length} ingredienti`;
  setTimeout(()=>{
    [['T',f.pyr.testa],['C',f.pyr.cuore],['F',f.pyr.fondo]].forEach(([k,p])=>{
      document.getElementById('p'+k+'l').textContent=p+'%';
      const b=document.getElementById('p'+k+'b');
      b.style.width=p+'%';b.textContent=p+'%';
    });
  },200);

  document.getElementById('prevList').innerHTML=f.formula.map(x=>{
    const pct=(x.drops/f.totalDrops*100).toFixed(1);
    const gr =(x.drops*DROML*DENS).toFixed(3);
    const bc =x.note==='testa'?'bt':x.note==='cuore'?'bc':'bf';
    const adjBadge=x.adjusted?'<span class="badge adj-badge">IFRA tarato</span>':'';
    return`<div class="ing-row">
      <div class="ing-nw"><span class="ing-n">${x.n}</span><span class="badge ${bc}">${x.note}</span>${x.ifra?'<span class="badge ifra-badge">IFRA</span>':''}${adjBadge}</div>
      <span class="ing-pct">${pct}%</span>
      <span class="ing-dr">${x.drops} gocce</span>
      <span class="ing-gr">${gr} g</span>
    </div>`;
  }).join('');

  /* messaggio tara */
  const tm=document.getElementById('ifraTaraMsg');
  if(f.adjustments.length>0){
    tm.innerHTML=`<div class="ib warn"><strong>âš™ï¸ Tara IFRA applicata</strong> â€” ${f.adjustments.length} ingrediente/i ridotti automaticamente per rispettare i limiti IFRA Cat.4:<br><ul style="margin:.5rem 0 0 1.2rem;">${
      f.adjustments.map(a=>`<li><strong>${a.n}</strong>: ${a.orig} â†’ ${a.adj} gocce (max IFRA ${a.ifraMax}% prod. finito)</li>`).join('')
    }</ul></div>`;
  } else {
    tm.innerHTML=`<div class="ib ok"><strong>âœ… Formula IFRA-conforme</strong> â€” Nessuna riduzione necessaria.</div>`;
  }

  document.getElementById('preview').classList.remove('hidden');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â•â• MODAL PASSWORD â•â• */
function openPass(){
  if(!F){alert('âš ï¸ Genera prima una formula con il wizard.');return;}
  document.getElementById('passInp').value='';
  document.getElementById('passErr').textContent='';
  document.getElementById('pass-ov').classList.add('show');
  setTimeout(()=>document.getElementById('passInp').focus(),180);
}
function closePass(){document.getElementById('pass-ov').classList.remove('show');}
function chkPass(){
  const pw=document.getElementById('passInp').value;
  if(pw!=='FormularioProfumi'){
    document.getElementById('passErr').textContent='âŒ Password errata. Riprova.';
    document.getElementById('passInp').select();
    return;
  }
  closePass();
  showFP();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMULA PAGE (protetta)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showFP(){
  const f=F;
  const typeLabel={edc:'Eau de Cologne (EDC) ~5%',edt:'Eau de Toilette (EDT) ~10%',edp:'Eau de Parfum (EDP) ~17%'};

  document.getElementById('fpName').textContent=f.name;
  document.getElementById('fpDesc').textContent=FAMDESCS[f.fam]||'';
  document.getElementById('fpType').textContent=typeLabel[f.type];
  document.getElementById('fpVol').textContent=f.vol+' ml';
  document.getElementById('fpCml').textContent=f.concMl.toFixed(2)+' ml';
  document.getElementById('fpAml').textContent=f.alcMl.toFixed(2)+' ml';
  document.getElementById('fpDr').textContent=f.totalDrops+' gocce';
  document.getElementById('fpGr').textContent=(f.totalDrops*DROML*DENS).toFixed(2)+' g';
  document.getElementById('fpNi').textContent=f.formula.length;

  document.getElementById('fpCtot').textContent='â‚¬'+f.totCost.toFixed(2);
  document.getElementById('fpCconc').textContent='â‚¬'+f.concCost.toFixed(2);
  document.getElementById('fpCalc').textContent='â‚¬'+f.alcCost.toFixed(2);
  document.getElementById('fpCml2').textContent='â‚¬'+(f.totCost/f.vol).toFixed(3);

  /* ingredienti tecnici */
  document.getElementById('fpIngList').innerHTML=f.formula.map(x=>{
    const pct=(x.drops/f.totalDrops*100).toFixed(2);
    const gr =(x.drops*DROML*DENS).toFixed(3);
    const bc =x.note==='testa'?'bt':x.note==='cuore'?'bc':'bf';
    return`<div class="ing-row">
      <div class="ing-nw"><span class="ing-n">${x.n}</span><span class="badge ${bc}">${x.note}</span>${x.ifra?'<span class="badge ifra-badge">IFRA</span>':''}${x.adjusted?'<span class="badge adj-badge">tarato</span>':''}</div>
      <span class="ing-pct">${pct}%</span>
      <span class="ing-dr">${x.drops} gocce</span>
      <span class="ing-gr">${gr} g</span>
    </div>`;
  }).join('');

  /* IFRA check */
  const limited=f.formula.filter(x=>x.ifra);
  const noLimEl=document.getElementById('ifraNoLim');
  const rowsEl =document.getElementById('ifraRows');
  const msgEl  =document.getElementById('ifraGlobalMsg');

  if(limited.length===0){
    noLimEl.classList.remove('hidden');
    rowsEl.innerHTML='';msgEl.innerHTML='';
  } else {
    noLimEl.classList.add('hidden');
    let anyWarn=false;
    rowsEl.innerHTML=limited.map(x=>{
      const pctFin=(x.drops*DROML/f.vol*100);
      const ok=pctFin<=x.ifraMax;
      if(!ok)anyWarn=true;
      return`<div class="ifra-r ${ok?'ifra-ok-r':'ifra-warn-r'}">
        <span><strong>${x.n}</strong><div class="ifra-note">${x.ifraNote}</div></span>
        <span>${pctFin.toFixed(4)}%</span>
        <span>max ${x.ifraMax}%</span>
        <span class="${ok?'ifra-ok':'ifra-warn'}">${ok?'âœ… OK':'âš ï¸ SUPERA'}</span>
      </div>`;
    }).join('');
    msgEl.innerHTML=anyWarn
      ?`<div class="ib">âš ï¸ Attenzione: uno o piÃ¹ ingredienti superano ancora il limite. Riduci manualmente.</div>`
      :`<div class="ib ok">âœ… Tutti gli ingredienti IFRA-limitati sono nei limiti per Cat.4 Fine Fragrance.</div>`;
  }

  /* istruzioni */
  document.getElementById('iAlc').textContent=f.alcMl.toFixed(1);
  document.getElementById('iType').textContent=({edc:'EDC',edt:'EDT',edp:'EDP'})[f.type];
  document.getElementById('iVol').textContent=f.vol;

  document.getElementById('app').style.display='none';
  const fp=document.getElementById('fp');
  fp.classList.add('show');
  window.scrollTo({top:0,behavior:'smooth'});
}
function closeFP(){
  document.getElementById('fp').classList.remove('show');
  document.getElementById('app').style.display='block';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CERTIFICATO IFRA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showCert(){
  const f=F;
  const now=new Date();
  const dateStr=now.toLocaleDateString('it-IT',{day:'2-digit',month:'long',year:'numeric'});
  const certNum='PS-'+now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(Math.floor(Math.random()*9000)+1000);

  document.getElementById('certNum').textContent='Rif. '+certNum;
  document.getElementById('certDate').textContent='Data: '+dateStr;
  document.getElementById('cFootDate').textContent=dateStr;
  document.getElementById('cFootNum').textContent=certNum;

  const typeLabel={edc:'Eau de Cologne (EDC) ~5%',edt:'Eau de Toilette (EDT) ~10%',edp:'Eau de Parfum (EDP) ~17%'};
  document.getElementById('cProdName').textContent=f.name;
  document.getElementById('cType').textContent=typeLabel[f.type];
  document.getElementById('cVol').textContent=f.vol+' ml';
  document.getElementById('cFam').textContent=FAMNAMES[f.fam]||f.fam;
  document.getElementById('cNIng').textContent=f.formula.length;
  document.getElementById('cConcPct').textContent=f.concPct+'%';
  document.getElementById('cDataForm').textContent=dateStr;
  document.getElementById('cPyrT').textContent=f.pyr.testa+'%';
  document.getElementById('cPyrC').textContent=f.pyr.cuore+'%';
  document.getElementById('cPyrF').textContent=f.pyr.fondo+'%';
  document.getElementById('cTotDr').textContent=f.totalDrops+' gocce';

  /* tabella ingredienti */
  document.getElementById('cIngTbody').innerHTML=f.formula.map(x=>{
    const pctConc=(x.drops/f.totalDrops*100).toFixed(2);
    const pctFin =(x.drops*DROML/f.vol*100).toFixed(4);
    const gr     =(x.drops*DROML*DENS).toFixed(3);
    const ifraCell=x.ifra?`<strong>â‰¤${x.ifraMax}%</strong>`:'â€”';
    return`<tr>
      <td>${x.n}</td>
      <td>${x.note}</td>
      <td>${x.drops}</td>
      <td>${gr} g</td>
      <td>${pctConc}%</td>
      <td>${pctFin}%</td>
      <td>${ifraCell}</td>
    </tr>`;
  }).join('');

  /* IFRA section certificato */
  const limited=f.formula.filter(x=>x.ifra);
  let allOk=true;
  if(limited.length===0){
    document.getElementById('cIfraContent').innerHTML='';
    document.getElementById('cIfraOkMsg').innerHTML=
      '<div style="background:#f0fdf4;border-left:3px solid #166534;padding:.7rem 1rem;font-size:.85rem;margin-top:.5rem;">âœ… La formula non contiene ingredienti soggetti a restrizioni IFRA Cat.4.</div>';
  } else {
    document.getElementById('cIfraOkMsg').innerHTML='';
    document.getElementById('cIfraContent').innerHTML=`
      <div class="cert-ifra-row head"><span>Ingrediente</span><span>% prod. finito</span><span>Limite IFRA Cat.4</span><span>Stato</span></div>
      ${limited.map(x=>{
        const pctFin=(x.drops*DROML/f.vol*100);
        const ok=pctFin<=x.ifraMax;
        if(!ok)allOk=false;
        return`<div class="cert-ifra-row">
          <span><strong>${x.n}</strong><br><small style="color:#777">${x.ifraNote}</small></span>
          <span>${pctFin.toFixed(4)}%</span>
          <span>max ${x.ifraMax}%</span>
          <span class="${ok?'cert-ok':'cert-warn'}">${ok?'âœ… CONFORME':'âš ï¸ NON CONFORME'}</span>
        </div>`;
      }).join('')}`;
  }

  /* esito + timbro */
  const stamp=document.getElementById('cStamp');
  const stampTxt=document.getElementById('cStampText');
  if(allOk){
    stamp.classList.remove('cert-stamp-warn');
    stampTxt.textContent='CONFORME';
    document.getElementById('cEsitoTxt').innerHTML=
      `<div style="background:#f0fdf4;border-left:4px solid #166534;padding:1rem 1.2rem;border-radius:6px;margin-bottom:1rem;">
        <strong style="color:#166534;">âœ… FORMULA CONFORME IFRA CAT. 4</strong><br>
        La miscela profumante <strong>"${f.name}"</strong> Ã¨ stata verificata e risulta conforme agli standard IFRA 50th Amendment (2023) per la Categoria 4 â€” Fine Fragrance / applicazione diretta cute.<br><br>
        ${f.adjustments.length>0?`<em>Nota: ${f.adjustments.length} ingrediente/i sono stati automaticamente tarati per rientrare nei limiti IFRA.</em>`:'Tutti gli ingredienti sono nei limiti senza necessitÃ  di aggiustamenti.'}
      </div>`;
  } else {
    stamp.classList.add('cert-stamp-warn');
    stampTxt.textContent='NON CONFORME';
    document.getElementById('cEsitoTxt').innerHTML=
      `<div style="background:#fef2f2;border-left:4px solid #991b1b;padding:1rem 1.2rem;border-radius:6px;margin-bottom:1rem;">
        <strong style="color:#991b1b;">âš ï¸ FORMULA NON COMPLETAMENTE CONFORME</strong><br>
        Uno o piÃ¹ ingredienti superano i limiti IFRA Cat.4. Ridurre le gocce degli ingredienti segnalati prima dell'utilizzo.
      </div>`;
  }

  /* mostra pagina certificato */
  document.getElementById('fp').classList.remove('show');
  document.getElementById('cert-page').classList.add('show');
  window.scrollTo({top:0,behavior:'smooth'});
}

function closeCert(){
  document.getElementById('cert-page').classList.remove('show');
  document.getElementById('fp').classList.add('show');
}

/* â•â• SALVA â•â• */
function saveF(){
  if(!F)return;
  const saved=JSON.parse(localStorage.getItem('ps_v2')||'[]');
  saved.unshift({...F,savedAt:new Date().toISOString()});
  localStorage.setItem('ps_v2',JSON.stringify(saved));
  alert('âœ… Formula "'+F.name+'" salvata!');
}
</script>
</body>
</html>
